<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="theme-color" content="#3b82f6">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Medicine Tracker">
    <meta name="description" content="Professional medicine tracking system for patients and healthcare providers with secure authentication">
    <title>Medicine Tracker - Professional Healthcare Management System</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lucide/0.263.1/lucide.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-color: #3b82f6;
            --primary-dark: #1d4ed8;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --danger-color: #ef4444;
            --gray-50: #f9fafb;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-300: #d1d5db;
            --gray-500: #6b7280;
            --gray-700: #374151;
            --gray-800: #1f2937;
            --gray-900: #111827;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #f0f4ff 0%, #e0e7ff 50%, #f0f9ff 100%);
            min-height: 100vh;
            line-height: 1.5;
            -webkit-text-size-adjust: 100%;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 1rem;
        }

        .card {
            background: white;
            border-radius: 1rem;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            border: 1px solid rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(10px);
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .btn {
            padding: 0.875rem 1.5rem;
            border-radius: 0.75rem;
            border: none;
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 600;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            min-height: 48px;
            text-decoration: none;
            white-space: nowrap;
            text-transform: uppercase;
            letter-spacing: 0.025em;
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }

        .btn:hover::before {
            left: 100%;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-sm {
            padding: 0.625rem 1rem;
            min-height: 40px;
            font-size: 0.75rem;
        }

        .btn-primary { 
            background: linear-gradient(135deg, #3b82f6, #1d4ed8); 
            color: white; 
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
        }
        .btn-primary:hover:not(:disabled) { 
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(59, 130, 246, 0.4);
        }

        .btn-secondary { 
            background: linear-gradient(135deg, #6b7280, #4b5563); 
            color: white; 
        }
        .btn-secondary:hover:not(:disabled) { 
            background: linear-gradient(135deg, #4b5563, #374151); 
            transform: translateY(-1px);
        }

        .btn-success { 
            background: linear-gradient(135deg, #10b981, #059669); 
            color: white; 
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
        }
        .btn-success:hover:not(:disabled) { 
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(16, 185, 129, 0.4);
        }

        .btn-danger { 
            background: linear-gradient(135deg, #ef4444, #dc2626); 
            color: white; 
            box-shadow: 0 4px 15px rgba(239, 68, 68, 0.3);
        }
        .btn-danger:hover:not(:disabled) { 
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(239, 68, 68, 0.4);
        }

        .btn-warning { 
            background: linear-gradient(135deg, #f59e0b, #d97706); 
            color: white; 
            box-shadow: 0 4px 15px rgba(245, 158, 11, 0.3);
        }
        .btn-warning:hover:not(:disabled) { 
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(245, 158, 11, 0.4);
        }

        .input {
            width: 100%;
            padding: 1rem 1.25rem;
            border: 2px solid var(--gray-200);
            border-radius: 0.75rem;
            font-size: 1.125rem;
            min-height: 52px;
            background: white;
            transition: all 0.3s ease;
            -webkit-appearance: none;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }

        .input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1);
            transform: translateY(-1px);
        }

        /* Mobile-specific input improvements */
        @media (max-width: 768px) {
            .input {
                font-size: 1.125rem;
                min-height: 56px;
                padding: 1.125rem 1.25rem;
                border-width: 2px;
                -webkit-user-select: text;
                user-select: text;
            }
            
            .input:focus {
                transform: none;
                box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
            }
        }

        .grid {
            display: grid;
            gap: 1.5rem;
        }

        .grid-1 { grid-template-columns: 1fr; }
        .grid-2 { grid-template-columns: repeat(2, 1fr); }
        .grid-3 { grid-template-columns: repeat(3, 1fr); }
        .grid-4 { grid-template-columns: repeat(4, 1fr); }

        .flex {
            display: flex;
        }

        .flex-col { flex-direction: column; }
        .flex-wrap { flex-wrap: wrap; }
        .items-center { align-items: center; }
        .items-start { align-items: flex-start; }
        .justify-between { justify-content: space-between; }
        .justify-center { justify-content: center; }
        .gap-1 { gap: 0.25rem; }
        .gap-2 { gap: 0.5rem; }
        .gap-3 { gap: 0.75rem; }
        .gap-4 { gap: 1rem; }
        .gap-6 { gap: 1.5rem; }

        .space-y-2 > * + * { margin-top: 0.5rem; }
        .space-y-3 > * + * { margin-top: 0.75rem; }

        .hidden { display: none; }
        .w-full { width: 100%; }
        .flex-1 { flex: 1; }
        .flex-shrink-0 { flex-shrink: 0; }
        .min-w-0 { min-width: 0; }
        .break-words { word-wrap: break-word; overflow-wrap: break-word; }

        .text-center { text-align: center; }
        .text-left { text-align: left; }
        .text-sm { font-size: 0.875rem; }
        .text-xs { font-size: 0.75rem; }
        .text-lg { font-size: 1.125rem; }
        .text-xl { font-size: 1.25rem; }
        .text-2xl { font-size: 1.5rem; }
        .text-3xl { font-size: 1.875rem; }

        .font-bold { font-weight: 700; }
        .font-medium { font-weight: 500; }
        .font-semibold { font-weight: 600; }

        .text-gray-400 { color: #9ca3af; }
        .text-gray-500 { color: #6b7280; }
        .text-gray-600 { color: #4b5563; }
        .text-gray-700 { color: #374151; }
        .text-gray-800 { color: #1f2937; }
        .text-gray-900 { color: #111827; }
        .text-white { color: white; }
        .text-blue-600 { color: #2563eb; }
        .text-green-600 { color: #059669; }
        .text-red-600 { color: #dc2626; }
        .text-yellow-600 { color: #d97706; }

        .mb-1 { margin-bottom: 0.25rem; }
        .mb-2 { margin-bottom: 0.5rem; }
        .mb-3 { margin-bottom: 0.75rem; }
        .mb-4 { margin-bottom: 1rem; }
        .mb-6 { margin-bottom: 1.5rem; }
        .mb-8 { margin-bottom: 2rem; }
        .mt-1 { margin-top: 0.25rem; }
        .mt-2 { margin-top: 0.5rem; }
        .mt-4 { margin-top: 1rem; }
        .mt-6 { margin-top: 1.5rem; }
        .ml-1 { margin-left: 0.25rem; }
        .ml-2 { margin-left: 0.5rem; }

        .p-1 { padding: 0.25rem; }
        .p-2 { padding: 0.5rem; }
        .p-3 { padding: 0.75rem; }
        .p-4 { padding: 1rem; }
        .p-6 { padding: 1.5rem; }
        .px-2 { padding-left: 0.5rem; padding-right: 0.5rem; }
        .px-3 { padding-left: 0.75rem; padding-right: 0.75rem; }
        .px-4 { padding-left: 1rem; padding-right: 1rem; }
        .py-1 { padding-top: 0.25rem; padding-bottom: 0.25rem; }
        .py-2 { padding-top: 0.5rem; padding-bottom: 0.5rem; }
        .py-3 { padding-top: 0.75rem; padding-bottom: 0.75rem; }
        .py-4 { padding-top: 1rem; padding-bottom: 1rem; }
        .py-8 { padding-top: 2rem; padding-bottom: 2rem; }

        .bg-white { background: white; }
        .bg-gray-50 { background: #f9fafb; }
        .bg-gray-100 { background: #f3f4f6; }

        .border { border: 1px solid #d1d5db; }
        .border-2 { border: 2px solid #d1d5db; }

        .rounded { border-radius: 0.25rem; }
        .rounded-lg { border-radius: 0.5rem; }
        .rounded-xl { border-radius: 0.75rem; }
        .rounded-2xl { border-radius: 1rem; }
        .rounded-full { border-radius: 9999px; }

        .shadow { box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1); }
        .shadow-lg { box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1); }
        .shadow-xl { box-shadow: 0 20px 50px rgba(0, 0, 0, 0.1); }

        /* ENHANCED USER INFO SECTION */
        .user-profile-hero {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 1.5rem;
            padding: 2rem;
            margin-bottom: 2rem;
            color: white;
            position: relative;
            overflow: hidden;
        }

        .user-profile-hero::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 200px;
            height: 200px;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
            border-radius: 50%;
            transform: translate(50%, -50%);
        }

        .user-avatar-large {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
            font-weight: bold;
            margin-bottom: 1.5rem;
            border: 4px solid rgba(255, 255, 255, 0.3);
            backdrop-filter: blur(10px);
            position: relative;
            z-index: 1;
        }

        .user-badges {
            display: flex;
            gap: 0.75rem;
            flex-wrap: wrap;
            margin-top: 1rem;
        }

        .user-badge {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 2rem;
            font-size: 0.875rem;
            font-weight: 500;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .user-stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-top: 2rem;
        }

        .user-stat-card {
            background: rgba(255, 255, 255, 0.15);
            border-radius: 1rem;
            padding: 1.5rem;
            text-align: center;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .user-stat-number {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
            display: block;
        }

        .user-stat-label {
            font-size: 0.875rem;
            opacity: 0.9;
        }

        .settings-panel {
            background: white;
            border-radius: 1rem;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
        }

        .settings-section {
            border-bottom: 1px solid var(--gray-200);
            padding-bottom: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .settings-section:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }

        .settings-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem;
            border-radius: 0.75rem;
            transition: background 0.2s;
            margin-bottom: 0.5rem;
        }

        .settings-item:hover {
            background: var(--gray-50);
        }

        /* ENHANCED MEDICINE SCHEDULE */
        .schedule-header {
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            border-radius: 1.5rem;
            padding: 2rem;
            margin-bottom: 2rem;
            border: 1px solid rgba(255, 255, 255, 0.8);
        }

        .schedule-container {
            background: white;
            border-radius: 1.5rem;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.8);
        }

        .medicine-card {
            background: linear-gradient(145deg, #ffffff 0%, #f8fafc 100%);
            border-radius: 1.25rem;
            padding: 1.5rem;
            margin-bottom: 1rem;
            border: 2px solid transparent;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .medicine-card::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 6px;
            background: var(--med-color, #3b82f6);
            border-radius: 0 3px 3px 0;
        }

        .medicine-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            border-color: var(--med-color, #3b82f6);
        }

        .medicine-card.taken {
            background: linear-gradient(145deg, #f0fdf4 0%, #dcfce7 100%);
            border-color: var(--success-color);
        }

        .medicine-card.missed {
            background: linear-gradient(145deg, #fef2f2 0%, #fee2e2 100%);
            border-color: var(--danger-color);
        }

        .medicine-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .medicine-icon-container {
            width: 4rem;
            height: 4rem;
            border-radius: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.5rem;
            background: var(--med-color, #3b82f6);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
            position: relative;
        }

        .medicine-icon-container::after {
            content: '';
            position: absolute;
            inset: -2px;
            border-radius: 1rem;
            background: linear-gradient(45deg, var(--med-color, #3b82f6), rgba(255,255,255,0.2));
            z-index: -1;
            filter: blur(8px);
            opacity: 0.3;
        }

        .medicine-details h3 {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--gray-900);
            margin-bottom: 0.25rem;
            line-height: 1.2;
        }

        .medicine-dosage {
            color: var(--gray-600);
            font-size: 1rem;
            font-weight: 500;
            margin-bottom: 0.5rem;
        }

        .medicine-frequency {
            color: var(--gray-500);
            font-size: 0.875rem;
            font-weight: 500;
        }

        .time-slots-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1rem;
            margin-top: 1.5rem;
        }

        .time-slot {
            background: rgba(255, 255, 255, 0.9);
            border: 2px solid var(--gray-200);
            border-radius: 1rem;
            padding: 1.25rem;
            transition: all 0.3s ease;
            position: relative;
        }

        .time-slot:hover {
            border-color: var(--med-color, #3b82f6);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }

        .time-slot.taken {
            background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%);
            border-color: var(--success-color);
        }

        .time-slot.missed {
            background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
            border-color: var(--danger-color);
        }

        .time-display {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1rem;
        }

        .time-text {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--gray-800);
        }

        .status-indicator {
            padding: 0.5rem 1rem;
            border-radius: 2rem;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.025em;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .status-taken {
            background: #dcfce7;
            color: #166534;
        }

        .status-missed {
            background: #fee2e2;
            color: #991b1b;
        }

        .status-pending {
            background: #fef3c7;
            color: #92400e;
        }

        .action-buttons {
            display: flex;
            gap: 0.75rem;
            margin-top: 1rem;
        }

        .action-btn {
            flex: 1;
            padding: 0.75rem;
            border-radius: 0.75rem;
            border: 2px solid transparent;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .action-btn-taken {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
        }

        .action-btn-taken:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(16, 185, 129, 0.3);
        }

        .action-btn-missed {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
        }

        .action-btn-missed:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(239, 68, 68, 0.3);
        }

        .stats-overview {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: white;
            border-radius: 1rem;
            padding: 1.5rem;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-2px);
        }

        .stat-card.taken {
            background: linear-gradient(135deg, #dcfce7, #bbf7d0);
            color: #166534;
        }

        .stat-card.missed {
            background: linear-gradient(135deg, #fee2e2, #fecaca);
            color: #991b1b;
        }

        .stat-card.pending {
            background: linear-gradient(135deg, #fef3c7, #fde68a);
            color: #92400e;
        }

        .stat-card.total {
            background: linear-gradient(135deg, #dbeafe, #bfdbfe);
            color: #1d4ed8;
        }

        .stat-number {
            font-size: 2.5rem;
            font-weight: 800;
            display: block;
            margin-bottom: 0.5rem;
        }

        .stat-label {
            font-size: 0.875rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.025em;
        }

        .login-container {
            min-height: 100vh;
            background: linear-gradient(135deg, #dbeafe 0%, #e0e7ff 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }

        .login-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 1.5rem;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.1);
            padding: 2.5rem;
            width: 100%;
            max-width: 450px;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        /* Mobile login improvements */
        @media (max-width: 768px) {
            .login-card {
                padding: 1.5rem;
                margin: 1rem;
                border-radius: 1rem;
                max-width: none;
            }
            
            .login-container {
                padding: 0.5rem;
                align-items: center;
            }
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(4px);
            display: flex;
            align-items: flex-start;
            justify-content: center;
            z-index: 1000;
            padding: 1rem;
            overflow-y: auto;
        }

        .modal-content {
            background: white;
            border-radius: 1.5rem;
            padding: 2rem;
            width: 100%;
            max-width: 600px;
            margin-top: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 25px 60px rgba(0, 0, 0, 0.2);
        }

        .toggle-btn {
            display: flex;
            border: 2px solid var(--gray-200);
            border-radius: 1rem;
            overflow: hidden;
            background: white;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
        }

        .toggle-btn button {
            flex: 1;
            padding: 1rem 1.5rem;
            border: none;
            background: transparent;
            color: var(--gray-700);
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.875rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            min-height: 60px;
        }

        .toggle-btn button.active {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            color: white;
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
        }

        .view-toggle {
            background: white;
            border-radius: 1rem;
            padding: 0.5rem;
            margin-bottom: 2rem;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
            border: 2px solid var(--gray-200);
        }

        .view-toggle button {
            flex: 1;
            padding: 1rem 1.5rem;
            border: none;
            background: transparent;
            color: var(--gray-600);
            cursor: pointer;
            transition: all 0.3s;
            border-radius: 0.75rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .view-toggle button.active {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            color: white;
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
        }

        .color-picker {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .color-option {
            width: 3rem;
            height: 3rem;
            border-radius: 50%;
            border: 3px solid transparent;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }

        .color-option.selected {
            border-color: var(--gray-800);
            transform: scale(1.15);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
        }

        .color-option::after {
            content: 'âœ“';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-weight: bold;
            font-size: 1rem;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .color-option.selected::after {
            opacity: 1;
        }

        /* Mobile touch and input optimizations */
        @media (max-width: 768px) {
            * {
                -webkit-tap-highlight-color: transparent;
                -webkit-touch-callout: none;
            }
            
            input, textarea, select {
                -webkit-appearance: none;
                border-radius: 0.75rem;
                font-size: 1.125rem !important; /* Prevents zoom on iOS */
            }
            
            .login-card input {
                font-size: 1.125rem !important;
                padding: 1.25rem 1.5rem !important;
                min-height: 60px !important;
                border: 2px solid var(--gray-300) !important;
                background: #ffffff !important;
            }
            
            .login-card input:focus {
                border-color: var(--primary-color) !important;
                box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.15) !important;
            }
        }

        /* Mobile Responsive Design */
        @media (max-width: 640px) {
            .container {
                padding: 0.75rem;
            }

            .card {
                padding: 1rem;
                margin-bottom: 1rem;
                border-radius: 1rem;
            }

            .user-profile-hero {
                padding: 1.5rem;
            }

            .user-avatar-large {
                width: 80px;
                height: 80px;
                font-size: 2rem;
            }

            .medicine-card {
                padding: 1rem;
            }

            .medicine-icon-container {
                width: 3rem;
                height: 3rem;
                font-size: 1.25rem;
            }

            .medicine-details h3 {
                font-size: 1.25rem;
            }

            .time-slots-grid {
                grid-template-columns: 1fr;
            }

            .grid-2, .grid-3, .grid-4 {
                grid-template-columns: 1fr;
            }

            .btn {
                width: 100%;
                justify-content: center;
            }

            .modal {
                padding: 0.5rem;
                align-items: flex-end;
            }

            .modal-content {
                margin: 0;
                border-radius: 1rem 1rem 0 0;
                max-height: 90vh;
                overflow-y: auto;
            }

            .user-stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .stats-overview {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        /* Tablet Design */
        @media (min-width: 641px) and (max-width: 1024px) {
            .grid-3 {
                grid-template-columns: repeat(2, 1fr);
            }

            .grid-4 {
                grid-template-columns: repeat(2, 1fr);
            }

            .time-slots-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        /* Animations */
        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(100px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.05);
            }
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        .medicine-card {
            animation: slideInUp 0.5s ease-out;
        }

        .stat-card {
            animation: fadeIn 0.5s ease-out;
        }

        .notification-alert {
            animation: slideInRight 0.4s ease-out;
        }

        .overdue-alert {
            animation: pulse 2s infinite;
        }

        .missed-dose {
            animation: shake 0.5s ease-in-out;
        }

        /* Notification styles */
        .notification-toast {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            max-width: 400px;
            margin-bottom: 10px;
        }

        .notification-success {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 0.75rem;
            box-shadow: 0 10px 25px rgba(16, 185, 129, 0.3);
        }

        .notification-warning {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 0.75rem;
            box-shadow: 0 10px 25px rgba(245, 158, 11, 0.3);
        }

        .notification-error {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 0.75rem;
            box-shadow: 0 10px 25px rgba(239, 68, 68, 0.3);
        }
    </style>
</head>
<body>
    <div id="app"></div>

    <script>
        // Global Application State
        const AppState = {
            currentUser: null,
            showLogin: true,
            loginType: 'patient',
            showSignup: false,
            currentPatient: null,
            patients: [],
            doctors: [],
            medications: [],
            doses: [],
            remarks: [],
            messages: [],
            doseEffects: [],
            patientFiles: [],
            selectedDate: new Date().toISOString().split('T')[0],
            searchTerm: '',
            showAddForm: false,
            editingMed: null,
            showRemarkModal: false,
            showBulkEdit: false,
            showHistoryModal: false,
            showMessagesModal: false,
            showSendMessageModal: false,
            showDoseEffectModal: false,
            showPatientAssignModal: false,
            showUserProfileModal: false,
            showUserSettingsModal: false, // New state for settings
            currentView: 'schedule',
            selectedDoseHistory: null,
            selectedDoseForEffect: null,
            currentMessage: { text: '', patientId: null },
            currentDoseEffect: { medicationId: null, time: '', date: '', effect: '', severity: 'mild' },
            currentRemark: { date: '', text: '', type: 'note' },
            newMed: {
                name: '',
                dosage: '',
                frequency: 'once',
                times: ['09:00'],
                notes: '',
                color: '#3b82f6',
                icon: 'pill'
            },
            loginForm: { email: '', password: '' },
            signupForm: {
                email: '', password: '', confirmPassword: '', name: '', 
                dateOfBirth: '', phone: '', specialty: '', license: '', hospital: ''
            }
        };

        // Constants
        const frequencyOptions = {
            once: { label: 'Once daily', defaultTimes: ['09:00'] },
            twice: { label: 'Twice daily', defaultTimes: ['09:00', '21:00'] },
            thrice: { label: 'Three times daily', defaultTimes: ['08:00', '14:00', '20:00'] },
            four: { label: 'Four times daily', defaultTimes: ['08:00', '12:00', '16:00', '20:00'] },
            custom: { label: 'Custom times', defaultTimes: ['09:00'] }
        };

        const colorOptions = [
            '#3b82f6', '#ef4444', '#10b981', '#f59e0b', 
            '#8b5cf6', '#ec4899', '#06b6d4', '#84cc16',
            '#f97316', '#6366f1', '#14b8a6', '#eab308'
        ];

        const medicineIcons = {
            pill: 'pill',
            tablet: 'tablets',
            capsule: 'capsule',
            syringe: 'syringe',
            droplet: 'droplet',
            heart: 'heart-pulse',
            bandage: 'bandage',
            stethoscope: 'stethoscope',
            thermometer: 'thermometer',
            activity: 'activity'
        };

        // NOTIFICATION SYSTEM FUNCTIONS

        // Request notification permission
        async function requestNotificationPermission() {
            if (!('Notification' in window)) {
                alert('This browser does not support notifications');
                return false;
            }

            const permission = await Notification.requestPermission();
            AppState.notifications.permission = permission;
            
            if (permission === 'granted') {
                AppState.notifications.enabled = true;
                scheduleAllNotifications();
                showNotificationSuccess('Notifications enabled! You\'ll receive medicine reminders.');
            } else if (permission === 'denied') {
                showNotificationWarning('Notifications blocked. Enable in browser settings for reminders.');
            }
            
            saveUserData();
            render();
            return permission === 'granted';
        }

        // Schedule notifications for all medications
        function scheduleAllNotifications() {
            clearAllScheduledNotifications();
            
            if (!AppState.notifications.enabled) return;
            
            AppState.medications.forEach(med => {
                med.times.forEach(time => {
                    scheduleNotificationForDose(med, time);
                });
                scheduleRefillReminder(med);
            });
        }

        // Schedule notification for a specific dose
        function scheduleNotificationForDose(medication, time) {
            const now = new Date();
            const today = now.toISOString().split('T')[0];
            
            // Schedule for today and next 7 days
            for (let i = 0; i < 7; i++) {
                const date = new Date(now);
                date.setDate(date.getDate() + i);
                const dateStr = date.toISOString().split('T')[0];
                
                const doseDateTime = new Date(`${dateStr}T${time}:00`);
                
                // Skip if dose already taken
                if (getDoseStatus(medication.id, time, dateStr) === 'taken') continue;
                
                // Schedule reminder notification (15 minutes before)
                if (AppState.notifications.settings.doseReminders) {
                    const reminderTime = new Date(doseDateTime.getTime() - (AppState.notifications.reminderMinutes * 60000));
                    if (reminderTime > now) {
                        scheduleNotification({
                            id: `reminder-${medication.id}-${dateStr}-${time}`,
                            title: 'ðŸ’Š Medicine Reminder',
                            body: `Time to take ${medication.name} (${medication.dosage})`,
                            time: reminderTime,
                            type: 'reminder',
                            medicationId: medication.id,
                            doseTime: time,
                            date: dateStr,
                            icon: 'ðŸ’Š',
                            actions: [
                                { action: 'taken', title: 'âœ… Mark as Taken' },
                                { action: 'snooze', title: 'â° Snooze 10min' }
                            ]
                        });
                    }
                }
                
                // Schedule missed dose alert (30 minutes after)
                if (AppState.notifications.settings.missedDoseAlerts) {
                    const missedTime = new Date(doseDateTime.getTime() + (AppState.notifications.missedDoseMinutes * 60000));
                    if (missedTime > now) {
                        scheduleNotification({
                            id: `missed-${medication.id}-${dateStr}-${time}`,
                            title: 'âš ï¸ Missed Dose Alert',
                            body: `You missed your ${medication.name} dose at ${time}. Take it now?`,
                            time: missedTime,
                            type: 'missed',
                            medicationId: medication.id,
                            doseTime: time,
                            date: dateStr,
                            icon: 'âš ï¸',
                            actions: [
                                { action: 'taken-late', title: 'âœ… Take Now' },
                                { action: 'skip', title: 'âŒ Skip Dose' }
                            ]
                        });
                    }
                }
            }
        }

        // Schedule refill reminder
        function scheduleRefillReminder(medication) {
            // Demo: Schedule refill reminder for 7 days from now
            if (!AppState.notifications.settings.refillReminders) return;
            
            const refillDate = new Date();
            refillDate.setDate(refillDate.getDate() + AppState.notifications.refillDays);
            
            scheduleNotification({
                id: `refill-${medication.id}`,
                title: 'ðŸ¥ Refill Reminder',
                body: `Time to refill ${medication.name}. Contact your pharmacy.`,
                time: refillDate,
                type: 'refill',
                medicationId: medication.id,
                icon: 'ðŸ¥',
                actions: [
                    { action: 'refilled', title: 'âœ… Already Refilled' },
                    { action: 'remind-later', title: 'â° Remind Tomorrow' }
                ]
            });
        }

        // Schedule a single notification
        function scheduleNotification(notificationData) {
            const timeoutId = setTimeout(() => {
                showNotification(notificationData);
                // Remove from active notifications
                AppState.activeNotifications = AppState.activeNotifications.filter(n => n.id !== notificationData.id);
            }, notificationData.time.getTime() - Date.now());
            
            // Store the scheduled notification
            AppState.activeNotifications.push({
                ...notificationData,
                timeoutId
            });
        }

        // Show a notification
        function showNotification(data) {
            if (!AppState.notifications.enabled || Notification.permission !== 'granted') return;
            
            const notification = new Notification(data.title, {
                body: data.body,
                icon: '/favicon.ico', // You can add a custom icon
                badge: '/badge.png',
                tag: data.id,
                requireInteraction: data.type === 'missed',
                silent: false
            });
            
            // Add to history
            AppState.notificationHistory.unshift({
                ...data,
                sentAt: new Date().toISOString(),
                clicked: false
            });
            
            // Handle notification clicks
            notification.onclick = () => {
                window.focus();
                handleNotificationAction(data, data.actions?.[0]?.action || 'open');
                notification.close();
            };
            
            // Auto-close reminder notifications after 30 seconds
            if (data.type === 'reminder') {
                setTimeout(() => notification.close(), 30000);
            }
            
            // Play notification sound (simulated)
            playNotificationSound(data.type);
            
            saveUserData();
        }

        // Handle notification actions
        function handleNotificationAction(notificationData, action) {
            const { medicationId, doseTime, date, type } = notificationData;
            
            switch (action) {
                case 'taken':
                case 'taken-late':
                    markDose(medicationId, doseTime, 'taken');
                    showNotificationSuccess('Dose marked as taken!');
                    break;
                    
                case 'skip':
                    markDose(medicationId, doseTime, 'missed');
                    break;
                    
                case 'snooze':
                    // Reschedule notification for 10 minutes later
                    const snoozeTime = new Date(Date.now() + 10 * 60000);
                    scheduleNotification({
                        ...notificationData,
                        id: `snooze-${notificationData.id}`,
                        time: snoozeTime,
                        title: 'ðŸ’Š Snoozed Reminder',
                        body: `Snoozed: Time to take ${AppState.medications.find(m => m.id === medicationId)?.name}`
                    });
                    break;
                    
                case 'refilled':
                    showNotificationSuccess('Great! Medication refilled.');
                    break;
                    
                case 'remind-later':
                    // Reschedule refill reminder for tomorrow
                    const tomorrow = new Date();
                    tomorrow.setDate(tomorrow.getDate() + 1);
                    scheduleNotification({
                        ...notificationData,
                        id: `refill-later-${notificationData.id}`,
                        time: tomorrow
                    });
                    break;
                    
                case 'open':
                default:
                    // Just open the app
                    break;
            }
            
            render();
        }

        // Clear all scheduled notifications
        function clearAllScheduledNotifications() {
            AppState.activeNotifications.forEach(notification => {
                if (notification.timeoutId) {
                    clearTimeout(notification.timeoutId);
                }
            });
            AppState.activeNotifications = [];
        }

        // Play notification sound (simulated for web)
        function playNotificationSound(type) {
            // In a real app, you'd play actual sound files
            // For demo, we'll just log the sound type
            console.log(`ðŸ”Š Playing ${type} notification sound`);
            
            // You could implement actual sounds like:
            // const audio = new Audio(`/sounds/${AppState.notifications.sounds[type]}.mp3`);
            // audio.play().catch(e => console.log('Could not play sound'));
        }

        // Show notification success message
        function showNotificationSuccess(message) {
            // Create a temporary success notification in the UI
            const notification = createElement('div', {
                className: 'fixed top-4 right-4 bg-green-500 text-white px-4 py-3 rounded-lg shadow-lg z-50',
                style: { animation: 'slideInRight 0.3s ease-out' }
            }, [
                createElement('div', { className: 'flex items-center gap-2' }, [
                    createIcon('check-circle', 16),
                    createElement('span', {}, [message])
                ])
            ]);
            
            document.body.appendChild(notification);
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        // Show notification warning message
        function showNotificationWarning(message) {
            const notification = createElement('div', {
                className: 'fixed top-4 right-4 bg-yellow-500 text-white px-4 py-3 rounded-lg shadow-lg z-50',
                style: { animation: 'slideInRight 0.3s ease-out' }
            }, [
                createElement('div', { className: 'flex items-center gap-2' }, [
                    createIcon('alert-triangle', 16),
                    createElement('span', {}, [message])
                ])
            ]);
            
            document.body.appendChild(notification);
            setTimeout(() => {
                notification.remove();
            }, 4000);
        }

        // Check for upcoming doses (next 2 hours)
        function getUpcomingDoses() {
            const now = new Date();
            const twoHoursLater = new Date(now.getTime() + 2 * 60 * 60 * 1000);
            const today = now.toISOString().split('T')[0];
            
            const upcoming = [];
            
            AppState.medications.forEach(med => {
                med.times.forEach(time => {
                    const doseDateTime = new Date(`${today}T${time}:00`);
                    
                    if (doseDateTime > now && doseDateTime <= twoHoursLater) {
                        const status = getDoseStatus(med.id, time);
                        if (status === 'pending') {
                            upcoming.push({
                                medication: med,
                                time: time,
                                datetime: doseDateTime,
                                minutesUntil: Math.round((doseDateTime - now) / 60000)
                            });
                        }
                    }
                });
            });
            
            return upcoming.sort((a, b) => a.datetime - b.datetime);
        }

        // Check for overdue doses
        function getOverdueDoses() {
            const now = new Date();
            const today = now.toISOString().split('T')[0];
            
            const overdue = [];
            
            AppState.medications.forEach(med => {
                med.times.forEach(time => {
                    const doseDateTime = new Date(`${today}T${time}:00`);
                    
                    if (doseDateTime < now) {
                        const status = getDoseStatus(med.id, time);
                        if (status === 'pending') {
                            overdue.push({
                                medication: med,
                                time: time,
                                datetime: doseDateTime,
                                minutesOverdue: Math.round((now - doseDateTime) / 60000)
                            });
                        }
                    }
                });
            });
            
            return overdue.sort((a, b) => b.datetime - a.datetime);
        }
        function createElement(tag, props = {}, children = []) {
            const element = document.createElement(tag);
            
            Object.entries(props).forEach(([key, value]) => {
                if (key === 'className') {
                    element.className = value;
                } else if (key.startsWith('on')) {
                    element.addEventListener(key.slice(2).toLowerCase(), value);
                } else if (key === 'style' && typeof value === 'object') {
                    Object.assign(element.style, value);
                } else {
                    element.setAttribute(key, value);
                }
            });

            children.forEach(child => {
                if (child === null || child === undefined) return;
                if (typeof child === 'string') {
                    element.appendChild(document.createTextNode(child));
                } else if (Array.isArray(child)) {
                    child.forEach(subChild => {
                        if (subChild !== null && subChild !== undefined) {
                            element.appendChild(subChild);
                        }
                    });
                } else if (child) {
                    element.appendChild(child);
                }
            });

            return element;
        }

        function createIcon(name, size = 16, className = '') {
            const icon = document.createElement('i');
            icon.setAttribute('data-lucide', name);
            icon.style.width = size + 'px';
            icon.style.height = size + 'px';
            if (className) {
                icon.className = className;
            }
            return icon;
        }

        // Data persistence functions
        function saveToStorage(key, data) {
            try {
                localStorage.setItem(key, JSON.stringify(data));
            } catch (error) {
                console.error('Failed to save data:', error);
            }
        }

        function loadFromStorage(key, defaultValue = []) {
            try {
                const stored = localStorage.getItem(key);
                return stored ? JSON.parse(stored) : defaultValue;
            } catch (error) {
                console.error('Failed to load data:', error);
                return defaultValue;
            }
        }

        function loadUserData() {
            const globalPatients = loadFromStorage('patients_global', []);
            const globalDoctors = loadFromStorage('doctors_global', []);
            
            AppState.patients = globalPatients;
            AppState.doctors = globalDoctors;
            
            if (AppState.currentUser) {
                const userKey = `${AppState.currentUser.role}_${AppState.currentUser.id}`;
                AppState.medications = loadFromStorage(`medications_${userKey}`, []);
                AppState.doses = loadFromStorage(`doses_${userKey}`, []);
                AppState.remarks = loadFromStorage(`remarks_${userKey}`, []);
                AppState.doseEffects = loadFromStorage(`doseEffects_${userKey}`, []);
                AppState.notificationHistory = loadFromStorage(`notificationHistory_${userKey}`, []);
                
                // Load notification settings
                const savedNotificationSettings = loadFromStorage(`notifications_${userKey}`, {});
                if (savedNotificationSettings.settings) {
                    AppState.notifications = { ...AppState.notifications, ...savedNotificationSettings };
                }
                
                if (AppState.currentUser.role === 'patient') {
                    AppState.messages = loadFromStorage(`messages_patient_${AppState.currentUser.id}`, []);
                } else {
                    AppState.messages = loadFromStorage(`messages_doctor_${AppState.currentUser.id}`, []);
                }
                
                // Check notification permission and reschedule if needed
                if ('Notification' in window) {
                    AppState.notifications.permission = Notification.permission;
                    if (AppState.notifications.permission === 'granted' && AppState.notifications.enabled) {
                        scheduleAllNotifications();
                    }
                }
            }
        }

        function saveUserData() {
            if (AppState.currentUser) {
                const userKey = `${AppState.currentUser.role}_${AppState.currentUser.id}`;
                saveToStorage(`medications_${userKey}`, AppState.medications);
                saveToStorage(`doses_${userKey}`, AppState.doses);
                saveToStorage(`remarks_${userKey}`, AppState.remarks);
                saveToStorage(`doseEffects_${userKey}`, AppState.doseEffects);
                saveToStorage(`notificationHistory_${userKey}`, AppState.notificationHistory);
                saveToStorage(`notifications_${userKey}`, AppState.notifications);
                
                if (AppState.currentUser.role === 'patient') {
                    saveToStorage(`messages_patient_${AppState.currentUser.id}`, AppState.messages);
                } else {
                    saveToStorage(`messages_doctor_${AppState.currentUser.id}`, AppState.messages);
                }
            }
            
            // Save global user lists
            saveToStorage('patients_global', AppState.patients);
            saveToStorage('doctors_global', AppState.doctors);
        }

        // Authentication functions
        function handleLogin(email, password) {
            const userList = AppState.loginType === 'patient' ? AppState.patients : AppState.doctors;
            const user = userList.find(u => u.email === email && u.password === password);
            
            if (user) {
                AppState.currentUser = { ...user, role: AppState.loginType };
                AppState.showLogin = false;
                AppState.loginForm = { email: '', password: '' };
                saveToStorage('currentUser', AppState.currentUser);
                loadUserData();
                render();
                return true;
            }
            return false;
        }

        function handleSignup(formData) {
            if (!formData.name.trim()) {
                alert('Please enter your full name');
                return false;
            }
            
            if (!formData.email.trim() || !formData.email.includes('@')) {
                alert('Please enter a valid email address');
                return false;
            }
            
            if (formData.password.length < 6) {
                alert('Password must be at least 6 characters long');
                return false;
            }
            
            if (formData.password !== formData.confirmPassword) {
                alert('Passwords do not match');
                return false;
            }

            if (AppState.loginType === 'patient') {
                if (!formData.dateOfBirth) {
                    alert('Please enter your date of birth');
                    return false;
                }
                if (!formData.phone.trim()) {
                    alert('Please enter your phone number');
                    return false;
                }
            }

            if (AppState.loginType === 'doctor') {
                if (!formData.specialty.trim()) {
                    alert('Please enter your medical specialty');
                    return false;
                }
                if (!formData.license.trim()) {
                    alert('Please enter your medical license number');
                    return false;
                }
                if (!formData.hospital.trim()) {
                    alert('Please enter your hospital or clinic name');
                    return false;
                }
            }

            const allUsers = AppState.loginType === 'patient' ? AppState.patients : AppState.doctors;
            if (allUsers.find(u => u.email === formData.email)) {
                alert('Email already exists');
                return false;
            }

            const newUser = {
                id: Date.now(),
                email: formData.email,
                password: formData.password,
                name: formData.name,
                createdAt: new Date().toISOString()
            };

            if (AppState.loginType === 'patient') {
                const patientUser = {
                    ...newUser,
                    dateOfBirth: formData.dateOfBirth,
                    phone: formData.phone,
                    assignedDoctor: null
                };
                AppState.patients.push(patientUser);
                saveToStorage('patients_global', AppState.patients);
            } else {
                const doctorUser = {
                    ...newUser,
                    specialty: formData.specialty,
                    license: formData.license,
                    hospital: formData.hospital
                };
                AppState.doctors.push(doctorUser);
                saveToStorage('doctors_global', AppState.doctors);
            }

            alert('Account created successfully! Please login.');
            AppState.showSignup = false;
            AppState.signupForm = {
                email: '', password: '', confirmPassword: '', name: '', 
                dateOfBirth: '', phone: '', specialty: '', license: '', hospital: ''
            };
            render();
            return true;
        }

        function handleLogout() {
            AppState.currentUser = null;
            AppState.currentPatient = null;
            AppState.medications = [];
            AppState.doses = [];
            AppState.remarks = [];
            AppState.messages = [];
            AppState.doseEffects = [];
            AppState.notificationHistory = [];
            clearAllScheduledNotifications();
            AppState.showLogin = true;
            localStorage.removeItem('currentUser');
            render();
        }

        // Medicine management functions
        function addMedication(medData) {
            const medication = {
                id: AppState.editingMed?.id || Date.now(),
                ...medData,
                icon: medData.icon || 'pill'
            };

            if (AppState.editingMed) {
                const index = AppState.medications.findIndex(m => m.id === AppState.editingMed.id);
                AppState.medications[index] = medication;
            } else {
                AppState.medications.push(medication);
            }

            AppState.showAddForm = false;
            AppState.editingMed = null;
            AppState.newMed = {
                name: '',
                dosage: '',
                frequency: 'once',
                times: ['09:00'],
                notes: '',
                color: '#3b82f6',
                icon: 'pill'
            };
            
            // Schedule notifications for the new/updated medication
            if (AppState.notifications.enabled) {
                scheduleAllNotifications();
                showNotificationSuccess(`Notifications scheduled for ${medication.name}`);
            }
            
            saveUserData();
            render();
        }

        function deleteMedication(id) {
            AppState.medications = AppState.medications.filter(m => m.id !== id);
            AppState.doses = AppState.doses.filter(d => d.medicationId !== id);
            saveUserData();
            render();
        }

        function markDose(medId, time, status) {
            const doseKey = `${AppState.selectedDate}-${medId}-${time}`;
            const existingDoseIndex = AppState.doses.findIndex(d => d.key === doseKey);
            
            const doseData = {
                key: doseKey,
                medicationId: medId,
                date: AppState.selectedDate,
                time,
                status,
                timestamp: new Date().toISOString()
            };
            
            if (existingDoseIndex >= 0) {
                AppState.doses[existingDoseIndex] = doseData;
            } else {
                AppState.doses.push(doseData);
            }
            
            saveUserData();
            render();
        }

        function getDoseStatus(medId, time, date = AppState.selectedDate) {
            const doseKey = `${date}-${medId}-${time}`;
            const dose = AppState.doses.find(d => d.key === doseKey);
            return dose?.status || 'pending';
        }

        function getTodayStats() {
            const todayDoses = AppState.doses.filter(d => d.date === AppState.selectedDate);
            const total = AppState.medications.reduce((sum, med) => sum + med.times.length, 0);
            const taken = todayDoses.filter(d => d.status === 'taken').length;
            const missed = todayDoses.filter(d => d.status === 'missed').length;
            
            return { total, taken, missed, pending: total - taken - missed };
        }

        function getUserInitials(name) {
            return name.split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);
        }

        // UI COMPONENTS

        function createLoginScreen() {
            const container = createElement('div', { className: 'login-container' });
            const card = createElement('div', { className: 'login-card' });
            
            const header = createElement('div', { className: 'text-center mb-6' }, [
                createElement('div', { className: 'flex items-center justify-center mb-4' }, [
                    createIcon('pill', 32),
                    createElement('h1', { className: 'text-2xl font-bold text-gray-800 ml-2' }, ['Medicine Tracker'])
                ]),
                createElement('p', { className: 'text-gray-600' }, [
                    'Manage your medications with smart reminders'
                ])
            ]);

            const toggle = createElement('div', { className: 'toggle-btn mb-6' }, [
                createElement('button', {
                    className: AppState.loginType === 'patient' ? 'active' : '',
                    onClick: () => {
                        AppState.loginType = 'patient';
                        render();
                    }
                }, [createIcon('user', 18), 'Patient']),
                createElement('button', {
                    className: AppState.loginType === 'doctor' ? 'active' : '',
                    onClick: () => {
                        AppState.loginType = 'doctor';
                        render();
                    }
                }, [createIcon('stethoscope', 18), 'Doctor'])
            ]);

            let formContent;
            if (!AppState.showSignup) {
                formContent = createElement('form', {
                    onSubmit: (e) => {
                        e.preventDefault();
                        if (!handleLogin(AppState.loginForm.email, AppState.loginForm.password)) {
                            alert('Invalid email or password. Please check your credentials.');
                        }
                    }
                }, [
                    createElement('div', { className: 'mb-4' }, [
                        createElement('label', { className: 'block text-sm font-medium text-gray-700 mb-2' }, ['Email Address']),
                        createElement('input', {
                            type: 'email',
                            className: 'input',
                            value: AppState.loginForm.email,
                            onInput: (e) => {
                                AppState.loginForm.email = e.target.value;
                            },
                            placeholder: 'Enter your email address',
                            autocomplete: 'email',
                            autocapitalize: 'none',
                            autocorrect: 'off',
                            spellcheck: 'false',
                            inputmode: 'email',
                            required: true
                        })
                    ]),
                    createElement('div', { className: 'mb-6' }, [
                        createElement('label', { className: 'block text-sm font-medium text-gray-700 mb-2' }, ['Password']),
                        createElement('input', {
                            type: 'password',
                            className: 'input',
                            value: AppState.loginForm.password,
                            onInput: (e) => {
                                AppState.loginForm.password = e.target.value;
                            },
                            placeholder: 'Enter your password',
                            autocomplete: 'current-password',
                            required: true
                        })
                    ]),
                    createElement('button', {
                        type: 'submit',
                        className: 'btn btn-primary w-full'
                    }, [
                        createIcon('lock', 16),
                        `Sign In as ${AppState.loginType === 'patient' ? 'Patient' : 'Doctor'}`
                    ])
                ]);
            } else {
                formContent = createElement('form', {
                    onSubmit: (e) => {
                        e.preventDefault();
                        handleSignup(AppState.signupForm);
                    }
                }, [
                    createElement('div', { className: 'mb-4' }, [
                        createElement('label', { className: 'block text-sm font-medium text-gray-700 mb-2' }, ['Full Name *']),
                        createElement('input', {
                            type: 'text',
                            className: 'input',
                            value: AppState.signupForm.name,
                            onInput: (e) => {
                                AppState.signupForm.name = e.target.value;
                            },
                            placeholder: 'Enter your full name',
                            required: true
                        })
                    ]),
                    createElement('div', { className: 'mb-4' }, [
                        createElement('label', { className: 'block text-sm font-medium text-gray-700 mb-2' }, ['Email Address *']),
                        createElement('input', {
                            type: 'email',
                            className: 'input',
                            value: AppState.signupForm.email,
                            onInput: (e) => {
                                AppState.signupForm.email = e.target.value;
                            },
                            placeholder: 'Enter your email address',
                            autocomplete: 'email',
                            required: true
                        })
                    ]),
                    createElement('div', { className: 'mb-4' }, [
                        createElement('label', { className: 'block text-sm font-medium text-gray-700 mb-2' }, ['Password *']),
                        createElement('input', {
                            type: 'password',
                            className: 'input',
                            value: AppState.signupForm.password,
                            onInput: (e) => {
                                AppState.signupForm.password = e.target.value;
                            },
                            placeholder: 'Create a password (min 6 characters)',
                            autocomplete: 'new-password',
                            required: true
                        })
                    ]),
                    createElement('div', { className: 'mb-4' }, [
                        createElement('label', { className: 'block text-sm font-medium text-gray-700 mb-2' }, ['Confirm Password *']),
                        createElement('input', {
                            type: 'password',
                            className: 'input',
                            value: AppState.signupForm.confirmPassword,
                            onInput: (e) => {
                                AppState.signupForm.confirmPassword = e.target.value;
                            },
                            placeholder: 'Confirm your password',
                            autocomplete: 'new-password',
                            required: true
                        })
                    ]),
                    AppState.loginType === 'patient' ? [
                        createElement('div', { className: 'mb-4' }, [
                            createElement('label', { className: 'block text-sm font-medium text-gray-700 mb-2' }, ['Date of Birth *']),
                            createElement('input', {
                                type: 'date',
                                className: 'input',
                                value: AppState.signupForm.dateOfBirth,
                                onInput: (e) => {
                                    AppState.signupForm.dateOfBirth = e.target.value;
                                },
                                required: true
                            })
                        ]),
                        createElement('div', { className: 'mb-6' }, [
                            createElement('label', { className: 'block text-sm font-medium text-gray-700 mb-2' }, ['Phone Number *']),
                            createElement('input', {
                                type: 'tel',
                                className: 'input',
                                value: AppState.signupForm.phone,
                                onInput: (e) => {
                                    AppState.signupForm.phone = e.target.value;
                                },
                                placeholder: 'Enter your phone number',
                                required: true
                            })
                        ])
                    ] : [
                        createElement('div', { className: 'mb-4' }, [
                            createElement('label', { className: 'block text-sm font-medium text-gray-700 mb-2' }, ['Medical Specialty *']),
                            createElement('input', {
                                type: 'text',
                                className: 'input',
                                placeholder: 'e.g., Internal Medicine, Cardiology',
                                value: AppState.signupForm.specialty,
                                onInput: (e) => {
                                    AppState.signupForm.specialty = e.target.value;
                                },
                                required: true
                            })
                        ]),
                        createElement('div', { className: 'mb-4' }, [
                            createElement('label', { className: 'block text-sm font-medium text-gray-700 mb-2' }, ['Medical License Number *']),
                            createElement('input', {
                                type: 'text',
                                className: 'input',
                                placeholder: 'e.g., MD123456',
                                value: AppState.signupForm.license,
                                onInput: (e) => {
                                    AppState.signupForm.license = e.target.value;
                                },
                                required: true
                            })
                        ]),
                        createElement('div', { className: 'mb-6' }, [
                            createElement('label', { className: 'block text-sm font-medium text-gray-700 mb-2' }, ['Hospital/Clinic *']),
                            createElement('input', {
                                type: 'text',
                                className: 'input',
                                placeholder: 'e.g., City General Hospital',
                                value: AppState.signupForm.hospital,
                                onInput: (e) => {
                                    AppState.signupForm.hospital = e.target.value;
                                },
                                required: true
                            })
                        ])
                    ],
                    createElement('button', {
                        type: 'submit',
                        className: 'btn btn-success w-full'
                    }, [
                        createIcon('user-check', 16),
                        `Create ${AppState.loginType === 'patient' ? 'Patient' : 'Doctor'} Account`
                    ])
                ]);
            }

            const toggleLink = createElement('div', { className: 'mt-4 text-center' }, [
                createElement('button', {
                    className: 'text-blue-600 hover:text-blue-800 text-sm',
                    onClick: () => {
                        AppState.showSignup = !AppState.showSignup;
                        render();
                    }
                }, [AppState.showSignup ? 'Already have an account? Sign In' : 'Need an account? Sign Up'])
            ]);

            card.appendChild(header);
            card.appendChild(toggle);
            card.appendChild(formContent);
            card.appendChild(toggleLink);
            container.appendChild(card);
            
            return container;
        }

        function createUserProfileHero() {
            const user = AppState.currentUser;
            const totalMeds = AppState.medications.length;
            const todayStats = getTodayStats();
            const adherenceRate = todayStats.total > 0 ? Math.round((todayStats.taken / todayStats.total) * 100) : 0;
            const upcomingDoses = getUpcomingDoses();
            const overdueDoses = getOverdueDoses();
            
            return createElement('div', { className: 'user-profile-hero' }, [
                createElement('div', { className: 'flex flex-col md:flex-row items-start md:items-center gap-6' }, [
                    createElement('div', { className: 'flex items-center gap-4' }, [
                        createElement('div', { className: 'user-avatar-large' }, [
                            getUserInitials(user.name)
                        ]),
                        createElement('div', {}, [
                            createElement('h1', { className: 'text-3xl font-bold mb-2' }, [user.name]),
                            createElement('p', { className: 'text-lg opacity-90 mb-3' }, [user.email]),
                            createElement('div', { className: 'user-badges' }, [
                                user.role === 'patient' ? [
                                    createElement('span', { className: 'user-badge' }, [
                                        createIcon('calendar', 14),
                                        `${new Date().getFullYear() - new Date(user.dateOfBirth).getFullYear()} years old`
                                    ]),
                                    createElement('span', { className: 'user-badge' }, [
                                        createIcon('phone', 14),
                                        user.phone
                                    ]),
                                    // Notification status badge
                                    createElement('span', { 
                                        className: `user-badge ${AppState.notifications.enabled ? 'bg-green-500' : 'bg-yellow-500'}`,
                                        style: { background: AppState.notifications.enabled ? 'rgba(34, 197, 94, 0.3)' : 'rgba(245, 158, 11, 0.3)' }
                                    }, [
                                        createIcon(AppState.notifications.enabled ? 'bell' : 'bell-off', 14),
                                        AppState.notifications.enabled ? 'Notifications ON' : 'Notifications OFF'
                                    ])
                                ] : [
                                    createElement('span', { className: 'user-badge' }, [
                                        createIcon('stethoscope', 14),
                                        user.specialty
                                    ]),
                                    createElement('span', { className: 'user-badge' }, [
                                        createIcon('building', 14),
                                        user.hospital
                                    ])
                                ]
                            ])
                        ])
                    ]),
                    createElement('div', { className: 'ml-auto flex gap-3' }, [
                        // Notification toggle button
                        createElement('button', {
                            className: `btn ${AppState.notifications.enabled ? 'btn-success' : 'btn-warning'}`,
                            style: { background: AppState.notifications.enabled ? 'rgba(34, 197, 94, 0.2)' : 'rgba(245, 158, 11, 0.2)', border: 'none', color: 'white' },
                            onClick: () => {
                                if (AppState.notifications.enabled) {
                                    AppState.notifications.enabled = false;
                                    clearAllScheduledNotifications();
                                    showNotificationWarning('Notifications disabled');
                                } else {
                                    requestNotificationPermission();
                                }
                                render();
                            }
                        }, [
                            createIcon(AppState.notifications.enabled ? 'bell' : 'bell-off', 16), 
                            AppState.notifications.enabled ? 'Notifications ON' : 'Enable Notifications'
                        ]),
                        createElement('button', {
                            className: 'btn btn-secondary',
                            style: { background: 'rgba(255, 255, 255, 0.2)', border: 'none', color: 'white' },
                            onClick: () => {
                                AppState.showUserSettingsModal = true;
                                render();
                            }
                        }, [createIcon('settings', 16), 'Settings']),
                        createElement('button', {
                            className: 'btn btn-secondary',
                            style: { background: 'rgba(255, 255, 255, 0.2)', border: 'none', color: 'white' },
                            onClick: () => {
                                AppState.showUserProfileModal = true;
                                render();
                            }
                        }, [createIcon('edit', 16), 'Edit Profile'])
                    ])
                ]),
                createElement('div', { className: 'user-stats-grid' }, [
                    createElement('div', { className: 'user-stat-card' }, [
                        createElement('span', { className: 'user-stat-number' }, [totalMeds.toString()]),
                        createElement('span', { className: 'user-stat-label' }, ['Active Medications'])
                    ]),
                    createElement('div', { className: 'user-stat-card' }, [
                        createElement('span', { className: 'user-stat-number' }, [todayStats.taken.toString()]),
                        createElement('span', { className: 'user-stat-label' }, ['Taken Today'])
                    ]),
                    createElement('div', { className: 'user-stat-card' }, [
                        createElement('span', { className: 'user-stat-number' }, [`${adherenceRate}%`]),
                        createElement('span', { className: 'user-stat-label' }, ['Adherence Rate'])
                    ]),
                    createElement('div', { 
                        className: 'user-stat-card',
                        style: overdueDoses.length > 0 ? { background: 'rgba(239, 68, 68, 0.2)' } : upcomingDoses.length > 0 ? { background: 'rgba(245, 158, 11, 0.2)' } : {}
                    }, [
                        createElement('span', { className: 'user-stat-number' }, [
                            overdueDoses.length > 0 ? overdueDoses.length.toString() : 
                            upcomingDoses.length > 0 ? upcomingDoses.length.toString() : '0'
                        ]),
                        createElement('span', { className: 'user-stat-label' }, [
                            overdueDoses.length > 0 ? 'Overdue Doses' : 
                            upcomingDoses.length > 0 ? 'Upcoming Doses' : 'All Caught Up'
                        ])
                    ])
                ]),
                
                // Notification alerts section
                (overdueDoses.length > 0 || upcomingDoses.length > 0) ? createElement('div', { 
                    className: 'mt-4 p-4 rounded-lg',
                    style: { background: 'rgba(255, 255, 255, 0.15)', backdropFilter: 'blur(10px)' }
                }, [
                    createElement('h3', { className: 'font-semibold mb-3 flex items-center gap-2' }, [
                        createIcon('clock', 16),
                        'Dose Alerts'
                    ]),
                    createElement('div', { className: 'grid grid-1 md:grid-2 gap-3' }, [
                        // Overdue doses
                        ...overdueDoses.slice(0, 2).map(dose => 
                            createElement('div', { 
                                className: 'flex items-center justify-between p-3 rounded-lg',
                                style: { background: 'rgba(239, 68, 68, 0.2)' }
                            }, [
                                createElement('div', {}, [
                                    createElement('div', { className: 'font-medium' }, [dose.medication.name]),
                                    createElement('div', { className: 'text-sm opacity-90' }, [`${dose.minutesOverdue} min overdue`])
                                ]),
                                createElement('button', {
                                    className: 'btn btn-sm',
                                    style: { background: 'rgba(255, 255, 255, 0.3)', color: 'white', border: 'none' },
                                    onClick: () => markDose(dose.medication.id, dose.time, 'taken')
                                }, ['Take Now'])
                            ])
                        ),
                        // Upcoming doses
                        ...upcomingDoses.slice(0, 2).map(dose => 
                            createElement('div', { 
                                className: 'flex items-center justify-between p-3 rounded-lg',
                                style: { background: 'rgba(245, 158, 11, 0.2)' }
                            }, [
                                createElement('div', {}, [
                                    createElement('div', { className: 'font-medium' }, [dose.medication.name]),
                                    createElement('div', { className: 'text-sm opacity-90' }, [`in ${dose.minutesUntil} min`])
                                ]),
                                createElement('div', { className: 'text-sm opacity-75' }, [dose.time])
                            ])
                        )
                    ])
                ]) : null
            ]);
        }

        function createViewToggle() {
            return createElement('div', { className: 'view-toggle flex' }, [
                createElement('button', {
                    className: AppState.currentView === 'schedule' ? 'active' : '',
                    onClick: () => {
                        AppState.currentView = 'schedule';
                        render();
                    }
                }, [createIcon('clock', 16), 'Schedule']),
                createElement('button', {
                    className: AppState.currentView === 'list' ? 'active' : '',
                    onClick: () => {
                        AppState.currentView = 'list';
                        render();
                    }
                }, [createIcon('list', 16), 'Medicine List']),
                createElement('button', {
                    className: AppState.currentView === 'weekly' ? 'active' : '',
                    onClick: () => {
                        AppState.currentView = 'weekly';
                        render();
                    }
                }, [createIcon('calendar', 16), 'Weekly View'])
            ]);
        }

        function createEnhancedScheduleView() {
            const todayStats = getTodayStats();
            
            if (AppState.medications.length === 0) {
                return createElement('div', { className: 'schedule-container text-center py-8' }, [
                    createIcon('pill', 64, 'text-gray-400'),
                    createElement('h3', { className: 'text-xl font-semibold text-gray-600 mb-3 mt-6' }, [
                        `Welcome to Medicine Tracker, ${AppState.currentUser.name.split(' ')[0]}! ðŸ‘‹`
                    ]),
                    createElement('p', { className: 'text-gray-500 mb-6 max-w-md mx-auto' }, [
                        'Start by adding your medications to track doses, set smart reminders, and monitor your adherence.'
                    ]),
                    createElement('div', { className: 'flex flex-col md:flex-row gap-4 justify-center items-center' }, [
                        createElement('button', {
                            className: 'btn btn-primary',
                            onClick: () => {
                                AppState.showAddForm = true;
                                render();
                            }
                        }, [createIcon('plus', 16), 'Add Your First Medicine']),
                        createElement('button', {
                            className: 'btn btn-secondary',
                            onClick: () => {
                                if (!AppState.notifications.enabled) {
                                    requestNotificationPermission();
                                } else {
                                    AppState.showUserSettingsModal = true;
                                }
                                render();
                            }
                        }, [
                            createIcon('bell', 16), 
                            AppState.notifications.enabled ? 'Notification Settings' : 'Enable Smart Reminders'
                        ])
                    ]),
                    createElement('div', { className: 'mt-8 grid grid-1 md:grid-3 gap-4 max-w-2xl mx-auto' }, [
                        createElement('div', { className: 'text-center p-4' }, [
                            createIcon('clock', 32, 'text-blue-500 mx-auto mb-2'),
                            createElement('h4', { className: 'font-semibold mb-1' }, ['Smart Reminders']),
                            createElement('p', { className: 'text-sm text-gray-600' }, ['Never miss a dose with customizable notifications'])
                        ]),
                        createElement('div', { className: 'text-center p-4' }, [
                            createIcon('trending-up', 32, 'text-green-500 mx-auto mb-2'),
                            createElement('h4', { className: 'font-semibold mb-1' }, ['Track Progress']),
                            createElement('p', { className: 'text-sm text-gray-600' }, ['Monitor adherence and build healthy habits'])
                        ]),
                        createElement('div', { className: 'text-center p-4' }, [
                            createIcon('shield-check', 32, 'text-purple-500 mx-auto mb-2'),
                            createElement('h4', { className: 'font-semibold mb-1' }, ['Stay Safe']),
                            createElement('p', { className: 'text-sm text-gray-600' }, ['Organized medication management'])
                        ])
                    ])
                ]);
            }

            return createElement('div', {}, [
                // Stats Overview
                createElement('div', { className: 'stats-overview' }, [
                    createElement('div', { className: 'stat-card taken' }, [
                        createElement('span', { className: 'stat-number' }, [todayStats.taken.toString()]),
                        createElement('span', { className: 'stat-label' }, ['Taken'])
                    ]),
                    createElement('div', { className: 'stat-card missed' }, [
                        createElement('span', { className: 'stat-number' }, [todayStats.missed.toString()]),
                        createElement('span', { className: 'stat-label' }, ['Missed'])
                    ]),
                    createElement('div', { className: 'stat-card pending' }, [
                        createElement('span', { className: 'stat-number' }, [todayStats.pending.toString()]),
                        createElement('span', { className: 'stat-label' }, ['Pending'])
                    ]),
                    createElement('div', { className: 'stat-card total' }, [
                        createElement('span', { className: 'stat-number' }, [todayStats.total.toString()]),
                        createElement('span', { className: 'stat-label' }, ['Total'])
                    ])
                ]),
                
                // Schedule Header
                createElement('div', { className: 'schedule-header' }, [
                    createElement('div', { className: 'flex items-center justify-between' }, [
                        createElement('div', {}, [
                            createElement('h2', { className: 'text-2xl font-bold text-gray-900 mb-2' }, [
                                'Today\'s Medicine Schedule'
                            ]),
                            createElement('p', { className: 'text-gray-600' }, [
                                new Date(AppState.selectedDate).toLocaleDateString('en', { 
                                    weekday: 'long', 
                                    year: 'numeric', 
                                    month: 'long', 
                                    day: 'numeric' 
                                })
                            ])
                        ]),
                        createElement('div', { className: 'flex items-center gap-3' }, [
                            createElement('input', {
                                type: 'date',
                                className: 'input',
                                value: AppState.selectedDate,
                                onInput: (e) => {
                                    AppState.selectedDate = e.target.value;
                                    render();
                                }
                            })
                        ])
                    ])
                ]),

                // Medicine Cards
                createElement('div', { className: 'space-y-4' }, 
                    AppState.medications.map(med => createEnhancedMedicineCard(med))
                )
            ]);
        }

        function createEnhancedMedicineCard(med) {
            const allTimesTaken = med.times.every(time => getDoseStatus(med.id, time) === 'taken');
            const allTimesMissed = med.times.every(time => getDoseStatus(med.id, time) === 'missed');
            
            let cardClass = 'medicine-card';
            if (allTimesTaken) cardClass += ' taken';
            else if (allTimesMissed) cardClass += ' missed';

            return createElement('div', { 
                className: cardClass,
                style: { '--med-color': med.color }
            }, [
                createElement('div', { className: 'medicine-header' }, [
                    createElement('div', { 
                        className: 'medicine-icon-container',
                        style: { background: med.color }
                    }, [
                        createIcon(medicineIcons[med.icon] || 'pill', 24)
                    ]),
                    createElement('div', { className: 'medicine-details flex-1' }, [
                        createElement('h3', {}, [med.name]),
                        createElement('div', { className: 'medicine-dosage' }, [med.dosage]),
                        createElement('div', { className: 'medicine-frequency' }, [
                            frequencyOptions[med.frequency].label
                        ]),
                        med.notes ? createElement('p', { className: 'text-sm text-gray-500 mt-2' }, [med.notes]) : null
                    ]),
                    createElement('div', { className: 'flex gap-2' }, [
                        createElement('button', {
                            className: 'btn btn-primary btn-sm',
                            onClick: () => {
                                AppState.editingMed = med;
                                AppState.newMed = { ...med };
                                AppState.showAddForm = true;
                                render();
                            }
                        }, [createIcon('edit', 14), 'Edit']),
                        createElement('button', {
                            className: 'btn btn-danger btn-sm',
                            onClick: () => {
                                if (confirm('Are you sure you want to delete this medication?')) {
                                    deleteMedication(med.id);
                                }
                            }
                        }, [createIcon('trash-2', 14)])
                    ])
                ]),
                
                createElement('div', { className: 'time-slots-grid' }, 
                    med.times.map(time => createEnhancedTimeSlot(med, time))
                )
            ]);
        }

        function createEnhancedTimeSlot(med, time) {
            const status = getDoseStatus(med.id, time);
            const hasReminder = AppState.activeNotifications.some(n => 
                n.medicationId === med.id && n.doseTime === time && n.type === 'reminder'
            );
            
            return createElement('div', { 
                className: `time-slot ${status}` 
            }, [
                createElement('div', { className: 'time-display' }, [
                    createIcon('clock', 20),
                    createElement('span', { className: 'time-text' }, [time]),
                    createElement('div', { className: 'flex items-center gap-2' }, [
                        createElement('span', { className: `status-indicator status-${status}` }, [
                            status === 'taken' ? createIcon('check', 12) : 
                            status === 'missed' ? createIcon('x', 12) : 
                            createIcon('clock', 12),
                            status.charAt(0).toUpperCase() + status.slice(1)
                        ]),
                        // Show notification indicator
                        hasReminder && AppState.notifications.enabled ? createElement('span', { 
                            className: 'text-xs px-2 py-1 rounded-full',
                            style: { background: 'rgba(59, 130, 246, 0.2)', color: '#1d4ed8' }
                        }, [
                            createIcon('bell', 10),
                            ' Alert Set'
                        ]) : null
                    ])
                ]),
                
                createElement('div', { className: 'action-buttons' }, [
                    createElement('button', {
                        className: `action-btn action-btn-taken ${status === 'taken' ? 'opacity-50' : ''}`,
                        onClick: () => {
                            markDose(med.id, time, 'taken');
                            if (status !== 'taken') {
                                showNotificationSuccess(`âœ… ${med.name} marked as taken!`);
                            }
                        },
                        disabled: status === 'taken'
                    }, [
                        createIcon('check', 16),
                        'Mark Taken'
                    ]),
                    createElement('button', {
                        className: `action-btn action-btn-missed ${status === 'missed' ? 'opacity-50' : ''}`,
                        onClick: () => {
                            markDose(med.id, time, 'missed');
                            if (status !== 'missed') {
                                showNotificationWarning(`âŒ ${med.name} marked as missed`);
                            }
                        },
                        disabled: status === 'missed'
                    }, [
                        createIcon('x', 16),
                        'Mark Missed'
                    ])
                ])
            ]);
        }

        function createMainInterface() {
            const container = createElement('div', { className: 'container' });
            
            // Enhanced User Profile Hero
            container.appendChild(createUserProfileHero());
            
            // View Toggle
            container.appendChild(createViewToggle());
            
            // Quick Actions
            const quickActions = createElement('div', { className: 'flex flex-wrap gap-3 mb-6' }, [
                createElement('button', {
                    className: 'btn btn-primary',
                    onClick: () => {
                        AppState.showAddForm = true;
                        render();
                    }
                }, [createIcon('plus', 16), 'Add Medicine']),
                
                // Smart notification button
                createElement('button', {
                    className: `btn ${AppState.notifications.enabled ? 'btn-success' : 'btn-warning'} btn-sm`,
                    onClick: () => {
                        if (!AppState.notifications.enabled) {
                            requestNotificationPermission();
                        } else {
                            AppState.showUserSettingsModal = true;
                        }
                        render();
                    }
                }, [
                    createIcon(AppState.notifications.enabled ? 'bell' : 'bell-off', 14), 
                    AppState.notifications.enabled ? `${AppState.activeNotifications.length} Reminders` : 'Enable Alerts'
                ]),
                
                createElement('button', {
                    className: 'btn btn-warning btn-sm',
                    onClick: () => {
                        AppState.showRemarkModal = true;
                        render();
                    }
                }, [createIcon('message-square', 14), 'Add Note']),
                createElement('button', {
                    className: 'btn btn-danger btn-sm',
                    onClick: handleLogout
                }, [createIcon('log-out', 16), 'Logout'])
            ]);
            container.appendChild(quickActions);

            // Content based on current view
            if (AppState.currentView === 'schedule') {
                container.appendChild(createEnhancedScheduleView());
            } else if (AppState.currentView === 'list') {
                // Simple list view for demo
                container.appendChild(createElement('div', { className: 'card' }, [
                    createElement('h3', { className: 'text-lg font-bold mb-4' }, ['Medicine List']),
                    createElement('div', { className: 'space-y-3' }, 
                        AppState.medications.map(med => 
                            createElement('div', { className: 'flex items-center gap-3 p-3 bg-gray-50 rounded-lg' }, [
                                createElement('div', { 
                                    className: 'w-10 h-10 rounded-lg flex items-center justify-center text-white',
                                    style: { backgroundColor: med.color }
                                }, [createIcon(medicineIcons[med.icon] || 'pill', 16)]),
                                createElement('div', { className: 'flex-1' }, [
                                    createElement('h4', { className: 'font-semibold' }, [med.name]),
                                    createElement('p', { className: 'text-sm text-gray-600' }, [med.dosage])
                                ])
                            ])
                        )
                    )
                ]));
            } else {
                // Weekly view placeholder
                container.appendChild(createElement('div', { className: 'card text-center py-8' }, [
                    createElement('h3', { className: 'text-lg font-bold mb-4' }, ['Weekly View']),
                    createElement('p', { className: 'text-gray-600' }, ['Weekly view functionality coming soon!'])
                ]));
            }

            // Modals
            if (AppState.showAddForm) {
                container.appendChild(createAddMedicineForm());
            }

            if (AppState.showUserProfileModal) {
                container.appendChild(createUserProfileModal());
            }

            if (AppState.showUserSettingsModal) {
                container.appendChild(createUserSettingsModal());
            }

            if (AppState.showRemarkModal) {
                container.appendChild(createRemarkModal());
            }

            return container;
        }

        function createUserSettingsModal() {
            const modal = createElement('div', { className: 'modal' });
            const content = createElement('div', { className: 'modal-content' });

            const header = createElement('div', { className: 'flex items-center justify-between mb-6' }, [
                createElement('h3', { className: 'text-xl font-bold' }, ['Settings & Preferences']),
                createElement('button', {
                    className: 'btn btn-secondary btn-sm',
                    onClick: () => {
                        AppState.showUserSettingsModal = false;
                        render();
                    }
                }, [createIcon('x', 16)])
            ]);

            const settingsContent = createElement('div', {}, [
                // Notifications Section
                createElement('div', { className: 'settings-section' }, [
                    createElement('h4', { className: 'text-lg font-semibold mb-3 flex items-center gap-2' }, [
                        createIcon('bell', 18),
                        'Smart Notifications'
                    ]),
                    
                    // Master notification toggle
                    createElement('div', { className: 'settings-item' }, [
                        createElement('div', {}, [
                            createElement('h5', { className: 'font-medium' }, ['Enable Notifications']),
                            createElement('p', { className: 'text-sm text-gray-600' }, [
                                AppState.notifications.permission === 'denied' ? 
                                'âŒ Blocked in browser. Please enable in settings.' :
                                AppState.notifications.permission === 'default' ?
                                'ðŸ”” Click to enable medicine reminders' :
                                'âœ… Notifications are enabled'
                            ])
                        ]),
                        createElement('button', {
                            className: `btn btn-sm ${AppState.notifications.enabled ? 'btn-success' : 'btn-primary'}`,
                            onClick: () => {
                                if (AppState.notifications.enabled) {
                                    AppState.notifications.enabled = false;
                                    clearAllScheduledNotifications();
                                    showNotificationWarning('Notifications disabled');
                                } else {
                                    requestNotificationPermission();
                                }
                                render();
                            },
                            disabled: AppState.notifications.permission === 'denied'
                        }, [
                            AppState.notifications.enabled ? 'Enabled' : 'Enable'
                        ])
                    ]),
                    
                    // Individual notification settings
                    AppState.notifications.enabled ? [
                        createElement('div', { className: 'settings-item' }, [
                            createElement('div', {}, [
                                createElement('h5', { className: 'font-medium' }, ['Dose Reminders']),
                                createElement('p', { className: 'text-sm text-gray-600' }, [`Get reminded ${AppState.notifications.reminderMinutes} minutes before each dose`])
                            ]),
                            createElement('label', { className: 'flex items-center gap-2' }, [
                                createElement('input', { 
                                    type: 'checkbox', 
                                    checked: AppState.notifications.settings.doseReminders,
                                    onChange: (e) => {
                                        AppState.notifications.settings.doseReminders = e.target.checked;
                                        scheduleAllNotifications();
                                        saveUserData();
                                    }
                                }),
                                createElement('span', { className: 'text-sm' }, ['Enabled'])
                            ])
                        ]),
                        createElement('div', { className: 'settings-item' }, [
                            createElement('div', {}, [
                                createElement('h5', { className: 'font-medium' }, ['Missed Dose Alerts']),
                                createElement('p', { className: 'text-sm text-gray-600' }, [`Alert you ${AppState.notifications.missedDoseMinutes} minutes after missing a dose`])
                            ]),
                            createElement('label', { className: 'flex items-center gap-2' }, [
                                createElement('input', { 
                                    type: 'checkbox', 
                                    checked: AppState.notifications.settings.missedDoseAlerts,
                                    onChange: (e) => {
                                        AppState.notifications.settings.missedDoseAlerts = e.target.checked;
                                        scheduleAllNotifications();
                                        saveUserData();
                                    }
                                }),
                                createElement('span', { className: 'text-sm' }, ['Enabled'])
                            ])
                        ]),
                        createElement('div', { className: 'settings-item' }, [
                            createElement('div', {}, [
                                createElement('h5', { className: 'font-medium' }, ['Refill Reminders']),
                                createElement('p', { className: 'text-sm text-gray-600' }, [`Remind you ${AppState.notifications.refillDays} days before running out`])
                            ]),
                            createElement('label', { className: 'flex items-center gap-2' }, [
                                createElement('input', { 
                                    type: 'checkbox', 
                                    checked: AppState.notifications.settings.refillReminders,
                                    onChange: (e) => {
                                        AppState.notifications.settings.refillReminders = e.target.checked;
                                        scheduleAllNotifications();
                                        saveUserData();
                                    }
                                }),
                                createElement('span', { className: 'text-sm' }, ['Enabled'])
                            ])
                        ]),
                        createElement('div', { className: 'settings-item' }, [
                            createElement('div', {}, [
                                createElement('h5', { className: 'font-medium' }, ['Daily Summary']),
                                createElement('p', { className: 'text-sm text-gray-600' }, ['Receive daily adherence reports'])
                            ]),
                            createElement('label', { className: 'flex items-center gap-2' }, [
                                createElement('input', { 
                                    type: 'checkbox', 
                                    checked: AppState.notifications.settings.dailySummary,
                                    onChange: (e) => {
                                        AppState.notifications.settings.dailySummary = e.target.checked;
                                        saveUserData();
                                    }
                                }),
                                createElement('span', { className: 'text-sm' }, ['Enabled'])
                            ])
                        ]),
                        
                        // Timing adjustments
                        createElement('div', { className: 'mt-4 p-4 bg-gray-50 rounded-lg' }, [
                            createElement('h5', { className: 'font-medium mb-3' }, ['Timing Preferences']),
                            createElement('div', { className: 'grid grid-1 md:grid-2 gap-4' }, [
                                createElement('div', {}, [
                                    createElement('label', { className: 'block text-sm font-medium mb-2' }, ['Reminder Before (minutes)']),
                                    createElement('select', { 
                                        className: 'input',
                                        value: AppState.notifications.reminderMinutes,
                                        onChange: (e) => {
                                            AppState.notifications.reminderMinutes = parseInt(e.target.value);
                                            scheduleAllNotifications();
                                            saveUserData();
                                        }
                                    }, [
                                        createElement('option', { value: '5' }, ['5 minutes']),
                                        createElement('option', { value: '10' }, ['10 minutes']),
                                        createElement('option', { value: '15' }, ['15 minutes']),
                                        createElement('option', { value: '30' }, ['30 minutes']),
                                        createElement('option', { value: '60' }, ['1 hour'])
                                    ])
                                ]),
                                createElement('div', {}, [
                                    createElement('label', { className: 'block text-sm font-medium mb-2' }, ['Missed Alert After (minutes)']),
                                    createElement('select', { 
                                        className: 'input',
                                        value: AppState.notifications.missedDoseMinutes,
                                        onChange: (e) => {
                                            AppState.notifications.missedDoseMinutes = parseInt(e.target.value);
                                            scheduleAllNotifications();
                                            saveUserData();
                                        }
                                    }, [
                                        createElement('option', { value: '15' }, ['15 minutes']),
                                        createElement('option', { value: '30' }, ['30 minutes']),
                                        createElement('option', { value: '60' }, ['1 hour']),
                                        createElement('option', { value: '120' }, ['2 hours'])
                                    ])
                                ])
                            ])
                        ]),
                        
                        // Notification history
                        AppState.notificationHistory.length > 0 ? createElement('div', { className: 'mt-4' }, [
                            createElement('h5', { className: 'font-medium mb-2' }, ['Recent Notifications']),
                            createElement('div', { className: 'max-h-32 overflow-y-auto space-y-2' }, 
                                AppState.notificationHistory.slice(0, 5).map(notif => 
                                    createElement('div', { className: 'flex items-center justify-between text-sm p-2 bg-white rounded' }, [
                                        createElement('span', {}, [notif.title]),
                                        createElement('span', { className: 'text-gray-500' }, [
                                            new Date(notif.sentAt).toLocaleTimeString('en', { hour: '2-digit', minute: '2-digit' })
                                        ])
                                    ])
                                )
                            )
                        ]) : null
                    ] : null
                ]),

                // Privacy Section
                createElement('div', { className: 'settings-section' }, [
                    createElement('h4', { className: 'text-lg font-semibold mb-3' }, ['Privacy & Security']),
                    createElement('div', { className: 'settings-item' }, [
                        createElement('div', {}, [
                            createElement('h5', { className: 'font-medium' }, ['Data Sharing']),
                            createElement('p', { className: 'text-sm text-gray-600' }, ['Share adherence data with your healthcare provider'])
                        ]),
                        createElement('label', { className: 'flex items-center gap-2' }, [
                            createElement('input', { type: 'checkbox', checked: false }),
                            createElement('span', { className: 'text-sm' }, ['Allow'])
                        ])
                    ]),
                    createElement('div', { className: 'settings-item' }, [
                        createElement('div', {}, [
                            createElement('h5', { className: 'font-medium' }, ['Biometric Lock']),
                            createElement('p', { className: 'text-sm text-gray-600' }, ['Use fingerprint or face recognition to secure the app'])
                        ]),
                        createElement('label', { className: 'flex items-center gap-2' }, [
                            createElement('input', { type: 'checkbox', checked: true }),
                            createElement('span', { className: 'text-sm' }, ['Enabled'])
                        ])
                    ])
                ]),

                // Appearance Section
                createElement('div', { className: 'settings-section' }, [
                    createElement('h4', { className: 'text-lg font-semibold mb-3' }, ['Appearance']),
                    createElement('div', { className: 'settings-item' }, [
                        createElement('div', {}, [
                            createElement('h5', { className: 'font-medium' }, ['Theme']),
                            createElement('p', { className: 'text-sm text-gray-600' }, ['Choose your preferred color scheme'])
                        ]),
                        createElement('select', { className: 'input', style: { width: 'auto' } }, [
                            createElement('option', { value: 'light' }, ['Light']),
                            createElement('option', { value: 'dark' }, ['Dark']),
                            createElement('option', { value: 'auto' }, ['Auto'])
                        ])
                    ])
                ])
            ]);

            content.appendChild(header);
            content.appendChild(settingsContent);
            modal.appendChild(content);

            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    AppState.showUserSettingsModal = false;
                    render();
                }
            });

            return modal;
        }

        function createUserProfileModal() {
            const modal = createElement('div', { className: 'modal' });
            const content = createElement('div', { className: 'modal-content' });

            const header = createElement('div', { className: 'flex items-center justify-between mb-4' }, [
                createElement('h3', { className: 'text-lg font-bold' }, ['Edit Profile']),
                createElement('button', {
                    className: 'btn btn-secondary btn-sm',
                    onClick: () => {
                        AppState.showUserProfileModal = false;
                        render();
                    }
                }, [createIcon('x', 16)])
            ]);

            const form = createElement('form', {
                onSubmit: (e) => {
                    e.preventDefault();
                    alert('Profile updated successfully!');
                    AppState.showUserProfileModal = false;
                    render();
                }
            }, [
                createElement('div', { className: 'grid grid-1 md:grid-2 gap-4 mb-6' }, [
                    createElement('div', {}, [
                        createElement('label', { className: 'block text-sm font-medium text-gray-700 mb-2' }, ['Full Name']),
                        createElement('input', {
                            type: 'text',
                            className: 'input',
                            value: AppState.currentUser.name
                        })
                    ]),
                    createElement('div', {}, [
                        createElement('label', { className: 'block text-sm font-medium text-gray-700 mb-2' }, ['Email']),
                        createElement('input', {
                            type: 'email',
                            className: 'input',
                            value: AppState.currentUser.email
                        })
                    ]),
                    AppState.currentUser.role === 'patient' ? [
                        createElement('div', {}, [
                            createElement('label', { className: 'block text-sm font-medium text-gray-700 mb-2' }, ['Phone']),
                            createElement('input', {
                                type: 'tel',
                                className: 'input',
                                value: AppState.currentUser.phone || ''
                            })
                        ]),
                        createElement('div', {}, [
                            createElement('label', { className: 'block text-sm font-medium text-gray-700 mb-2' }, ['Date of Birth']),
                            createElement('input', {
                                type: 'date',
                                className: 'input',
                                value: AppState.currentUser.dateOfBirth || ''
                            })
                        ])
                    ] : null
                ]),
                createElement('div', { className: 'flex flex-col md:flex-row gap-3' }, [
                    createElement('button', {
                        type: 'submit',
                        className: 'btn btn-primary'
                    }, [createIcon('save', 16), 'Save Changes']),
                    createElement('button', {
                        type: 'button',
                        className: 'btn btn-secondary',
                        onClick: () => {
                            AppState.showUserProfileModal = false;
                            render();
                        }
                    }, ['Cancel'])
                ])
            ]);

            content.appendChild(header);
            content.appendChild(form);
            modal.appendChild(content);

            return modal;
        }

        function createAddMedicineForm() {
            const modal = createElement('div', { className: 'modal' });
            const content = createElement('div', { className: 'modal-content' });

            const header = createElement('h2', { className: 'text-xl font-bold text-gray-800 mb-4' }, [
                AppState.editingMed ? 'Edit Medicine' : 'Add New Medicine'
            ]);

            const form = createElement('form', {
                onSubmit: (e) => {
                    e.preventDefault();
                    if (!AppState.newMed.name || !AppState.newMed.dosage) {
                        alert('Please fill in all required fields');
                        return;
                    }
                    addMedication(AppState.newMed);
                }
            }, [
                createElement('div', { className: 'grid grid-1 md:grid-2 gap-4 mb-4' }, [
                    createElement('div', {}, [
                        createElement('label', { className: 'block text-sm font-medium text-gray-700 mb-2' }, ['Medicine Name *']),
                        createElement('input', {
                            type: 'text',
                            className: 'input',
                            placeholder: 'e.g., Aspirin',
                            value: AppState.newMed.name,
                            onInput: (e) => {
                                AppState.newMed.name = e.target.value;
                            },
                            required: true
                        })
                    ]),
                    createElement('div', {}, [
                        createElement('label', { className: 'block text-sm font-medium text-gray-700 mb-2' }, ['Dosage *']),
                        createElement('input', {
                            type: 'text',
                            className: 'input',
                            placeholder: 'e.g., 100mg',
                            value: AppState.newMed.dosage,
                            onInput: (e) => {
                                AppState.newMed.dosage = e.target.value;
                            },
                            required: true
                        })
                    ])
                ]),
                createElement('div', { className: 'grid grid-1 md:grid-2 gap-4 mb-4' }, [
                    createElement('div', {}, [
                        createElement('label', { className: 'block text-sm font-medium text-gray-700 mb-2' }, ['Medicine Type']),
                        createElement('select', {
                            className: 'input',
                            value: AppState.newMed.icon,
                            onChange: (e) => {
                                AppState.newMed.icon = e.target.value;
                                render();
                            }
                        }, Object.entries(medicineIcons).map(([key, iconName]) =>
                            createElement('option', { value: key }, [
                                key.charAt(0).toUpperCase() + key.slice(1)
                            ])
                        ))
                    ]),
                    createElement('div', {}, [
                        createElement('label', { className: 'block text-sm font-medium text-gray-700 mb-2' }, ['Frequency']),
                        createElement('select', {
                            className: 'input',
                            value: AppState.newMed.frequency,
                            onChange: (e) => {
                                AppState.newMed.frequency = e.target.value;
                                AppState.newMed.times = frequencyOptions[e.target.value].defaultTimes;
                                render();
                            }
                        }, Object.entries(frequencyOptions).map(([key, option]) =>
                            createElement('option', { value: key }, [option.label])
                        ))
                    ])
                ]),
                createElement('div', { className: 'mb-4' }, [
                    createElement('label', { className: 'block text-sm font-medium text-gray-700 mb-2' }, ['Color Theme']),
                    createElement('div', { className: 'color-picker' }, 
                        colorOptions.map(color =>
                            createElement('button', {
                                type: 'button',
                                className: `color-option ${AppState.newMed.color === color ? 'selected' : ''}`,
                                style: { backgroundColor: color },
                                onClick: () => {
                                    AppState.newMed.color = color;
                                    render();
                                }
                            })
                        )
                    )
                ]),
                createElement('div', { className: 'mb-4' }, [
                    createElement('label', { className: 'block text-sm font-medium text-gray-700 mb-2' }, ['Times']),
                    createElement('div', { className: 'space-y-2' }, 
                        AppState.newMed.times.map((time, index) =>
                            createElement('div', { className: 'flex items-center gap-2' }, [
                                createElement('input', {
                                    type: 'time',
                                    className: 'input flex-1',
                                    value: time,
                                    onInput: (e) => {
                                        AppState.newMed.times[index] = e.target.value;
                                    }
                                }),
                                AppState.newMed.times.length > 1 ? createElement('button', {
                                    type: 'button',
                                    className: 'btn btn-danger btn-sm',
                                    onClick: () => {
                                        AppState.newMed.times.splice(index, 1);
                                        render();
                                    }
                                }, [createIcon('x-circle', 16)]) : null
                            ])
                        )
                    ),
                    AppState.newMed.frequency === 'custom' ? createElement('button', {
                        type: 'button',
                        className: 'btn btn-secondary btn-sm mt-2',
                        onClick: () => {
                            AppState.newMed.times.push('09:00');
                            render();
                        }
                    }, [createIcon('plus', 16), 'Add Time']) : null
                ]),
                createElement('div', { className: 'mb-6' }, [
                    createElement('label', { className: 'block text-sm font-medium text-gray-700 mb-2' }, ['Notes']),
                    createElement('textarea', {
                        className: 'input',
                        rows: '3',
                        placeholder: 'Take with food, special instructions, etc.',
                        value: AppState.newMed.notes,
                        onInput: (e) => {
                            AppState.newMed.notes = e.target.value;
                        }
                    })
                ]),
                createElement('div', { className: 'flex flex-col md:flex-row gap-3' }, [
                    createElement('button', {
                        type: 'submit',
                        className: 'btn btn-success'
                    }, [AppState.editingMed ? 'Update Medicine' : 'Save Medicine']),
                    createElement('button', {
                        type: 'button',
                        className: 'btn btn-secondary',
                        onClick: () => {
                            AppState.showAddForm = false;
                            AppState.editingMed = null;
                            AppState.newMed = {
                                name: '',
                                dosage: '',
                                frequency: 'once',
                                times: ['09:00'],
                                notes: '',
                                color: '#3b82f6',
                                icon: 'pill'
                            };
                            render();
                        }
                    }, ['Cancel'])
                ])
            ]);

            content.appendChild(header);
            content.appendChild(form);
            modal.appendChild(content);

            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    AppState.showAddForm = false;
                    render();
                }
            });

            return modal;
        }

        function createRemarkModal() {
            const modal = createElement('div', { className: 'modal' });
            const content = createElement('div', { className: 'modal-content' });

            const header = createElement('h3', { className: 'text-lg font-bold mb-4' }, ['Add Note']);

            const form = createElement('form', {
                onSubmit: (e) => {
                    e.preventDefault();
                    alert('Note added successfully!');
                    AppState.showRemarkModal = false;
                    render();
                }
            }, [
                createElement('div', { className: 'mb-4' }, [
                    createElement('label', { className: 'block text-sm font-medium text-gray-700 mb-2' }, ['Note']),
                    createElement('textarea', {
                        className: 'input',
                        rows: '4',
                        placeholder: 'Enter your note or observation...',
                        required: true
                    })
                ]),
                createElement('div', { className: 'flex flex-col md:flex-row gap-2' }, [
                    createElement('button', {
                        type: 'submit',
                        className: 'btn btn-primary'
                    }, ['Add Note']),
                    createElement('button', {
                        type: 'button',
                        className: 'btn btn-secondary',
                        onClick: () => {
                            AppState.showRemarkModal = false;
                            render();
                        }
                    }, ['Cancel'])
                ])
            ]);

            content.appendChild(header);
            content.appendChild(form);
            modal.appendChild(content);

            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    AppState.showRemarkModal = false;
                    render();
                }
            });

            return modal;
        }

        // Main Render Function
        function render() {
            const app = document.getElementById('app');
            app.innerHTML = '';

            if (!AppState.currentUser || AppState.showLogin) {
                app.appendChild(createLoginScreen());
            } else {
                app.appendChild(createMainInterface());
            }

            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
        }

        // Initialize Application
        function init() {
            // Load global user data first
            AppState.patients = loadFromStorage('patients_global', []);
            AppState.doctors = loadFromStorage('doctors_global', []);
            
            // Check if user was previously logged in
            const savedUser = loadFromStorage('currentUser', null);
            if (savedUser) {
                AppState.currentUser = savedUser;
                AppState.showLogin = false;
                loadUserData();
            }

            render();
            
            // Set up periodic notification checks (every minute)
            setInterval(() => {
                if (AppState.currentUser && AppState.notifications.enabled) {
                    // Check for any new doses that need reminders
                    checkForUpcomingReminders();
                }
            }, 60000); // Check every minute
        }

        // Check for upcoming reminders that need to be scheduled
        function checkForUpcomingReminders() {
            const now = new Date();
            const next24Hours = new Date(now.getTime() + 24 * 60 * 60 * 1000);
            
            AppState.medications.forEach(med => {
                med.times.forEach(time => {
                    for (let i = 0; i < 2; i++) { // Check today and tomorrow
                        const date = new Date(now);
                        date.setDate(date.getDate() + i);
                        const dateStr = date.toISOString().split('T')[0];
                        
                        const doseDateTime = new Date(`${dateStr}T${time}:00`);
                        
                        if (doseDateTime >= now && doseDateTime <= next24Hours) {
                            // Check if we already have a reminder scheduled for this dose
                            const hasReminder = AppState.activeNotifications.some(n => 
                                n.medicationId === med.id && 
                                n.doseTime === time && 
                                n.date === dateStr && 
                                n.type === 'reminder'
                            );
                            
                            if (!hasReminder && getDoseStatus(med.id, time, dateStr) === 'pending') {
                                scheduleNotificationForDose(med, time);
                            }
                        }
                    }
                });
            });
        }

        // Auto-save user data periodically
        setInterval(() => {
            if (AppState.currentUser) {
                saveUserData();
            }
        }, 30000); // Save every 30 seconds

        window.addEventListener('beforeunload', () => {
            if (AppState.currentUser) {
                saveToStorage('currentUser', AppState.currentUser);
                saveUserData();
            }
        });

        init();
    </script>
</body>
</html>
