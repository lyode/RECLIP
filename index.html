<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Auto Beat-Sync Clip Maker Pro</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: white;
            overflow-x: hidden;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.8rem;
            margin-bottom: 10px;
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4, #45b7d1, #f9ca24);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            animation: gradientShift 3s ease-in-out infinite;
        }

        @keyframes gradientShift {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        .tabs {
            display: flex;
            margin-bottom: 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 5px;
        }

        .tab {
            flex: 1;
            padding: 12px 20px;
            text-align: center;
            cursor: pointer;
            border-radius: 10px;
            transition: all 0.3s ease;
            font-weight: 600;
        }

        .tab.active {
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
            color: white;
        }

        .tab-content {
            display: none;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .tab-content.active {
            display: block;
        }

        .music-browser {
            margin-bottom: 30px;
        }

        .search-container {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .search-input {
            flex: 1;
            padding: 12px 15px;
            border-radius: 10px;
            border: none;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            font-size: 1rem;
        }

        .search-input::placeholder {
            color: rgba(255, 255, 255, 0.7);
        }

        .genre-filter {
            padding: 12px 15px;
            border-radius: 10px;
            border: none;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            min-width: 150px;
        }

        .genre-filter option {
            background: #333;
            color: white;
        }

        .search-btn {
            padding: 12px 20px;
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
            border: none;
            border-radius: 10px;
            color: white;
            cursor: pointer;
            font-weight: bold;
        }

        .music-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
            max-height: 400px;
            overflow-y: auto;
            padding: 10px;
        }

        .music-card {
            background: rgba(255, 255, 255, 0.15);
            border-radius: 15px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }

        .music-card:hover {
            transform: translateY(-5px);
            border-color: #4ecdc4;
            background: rgba(78, 205, 196, 0.2);
        }

        .music-card.selected {
            border-color: #ff6b6b;
            background: rgba(255, 107, 107, 0.2);
        }

        .music-info h4 {
            margin-bottom: 5px;
            color: #fff;
        }

        .music-info p {
            color: rgba(255, 255, 255, 0.8);
            font-size: 0.9rem;
            margin-bottom: 10px;
        }

        .music-controls {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .play-btn {
            background: #4ecdc4;
            border: none;
            border-radius: 50%;
            width: 35px;
            height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: white;
            font-size: 14px;
        }

        .waveform {
            flex: 1;
            height: 30px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            position: relative;
            overflow: hidden;
        }

        .waveform-progress {
            height: 100%;
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
            border-radius: 15px;
            width: 0%;
            transition: width 0.1s ease;
        }

        .upload-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .upload-area {
            border: 2px dashed rgba(255, 255, 255, 0.5);
            border-radius: 15px;
            padding: 40px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .upload-area:hover {
            border-color: #4ecdc4;
            background: rgba(78, 205, 196, 0.1);
            transform: translateY(-5px);
        }

        .upload-area input {
            position: absolute;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }

        .upload-icon {
            font-size: 3rem;
            margin-bottom: 15px;
            opacity: 0.8;
        }

        .controls-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .control-group {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .control-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            font-size: 0.9rem;
        }

        .control-group select,
        .control-group input {
            width: 100%;
            padding: 10px;
            border-radius: 8px;
            border: none;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            font-size: 0.9rem;
        }

        .control-group select option {
            background: #333;
            color: white;
        }

        .generate-btn {
            width: 100%;
            padding: 18px;
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
            border: none;
            border-radius: 12px;
            color: white;
            font-size: 1.2rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 20px;
            position: relative;
            overflow: hidden;
        }

        .generate-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.3);
        }

        .generate-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .preview-section {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .preview-container {
            position: relative;
            width: 100%;
            max-width: 900px;
            margin: 0 auto;
            aspect-ratio: 16/9;
            background: #000;
            border-radius: 15px;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .preview-content {
            width: 100%;
            height: 100%;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .preview-media {
            max-width: 100%;
            max-height: 100%;
            object-fit: cover;
            border-radius: 10px;
        }

        .effect-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 10;
        }

        .audio-visualizer {
            position: absolute;
            bottom: 20px;
            left: 20px;
            right: 20px;
            height: 80px;
            display: flex;
            align-items: end;
            gap: 3px;
            z-index: 15;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            padding: 10px;
        }

        .audio-bar {
            flex: 1;
            background: linear-gradient(to top, #ff6b6b, #4ecdc4, #45b7d1);
            border-radius: 2px;
            transition: height 0.05s ease;
            opacity: 0.9;
            min-height: 3px;
        }

        .status {
            text-align: center;
            margin-top: 20px;
            padding: 15px;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.1);
            font-weight: 600;
        }

        .beat-indicator {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 25px;
            height: 25px;
            background: #ff6b6b;
            border-radius: 50%;
            z-index: 15;
            opacity: 0;
            transition: all 0.1s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
        }

        .beat-active {
            opacity: 1;
            animation: beatPulse 0.3s ease;
            box-shadow: 0 0 20px rgba(255, 107, 107, 0.8);
        }

        @keyframes beatPulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.8); }
            100% { transform: scale(1); }
        }

        .effect-flash {
            animation: flashEffect 0.4s ease;
        }

        @keyframes flashEffect {
            0% { filter: brightness(1) contrast(1) saturate(1); }
            50% { filter: brightness(1.8) contrast(1.4) saturate(1.6) hue-rotate(30deg); }
            100% { filter: brightness(1) contrast(1) saturate(1); }
        }

        .effect-zoom {
            animation: zoomEffect 0.6s ease;
        }

        @keyframes zoomEffect {
            0% { transform: scale(1) rotate(0deg); }
            50% { transform: scale(1.15) rotate(2deg); }
            100% { transform: scale(1) rotate(0deg); }
        }

        .effect-shake {
            animation: shakeEffect 0.4s ease;
        }

        @keyframes shakeEffect {
            0%, 100% { transform: translateX(0) translateY(0); }
            25% { transform: translateX(-8px) translateY(4px); }
            75% { transform: translateX(8px) translateY(-4px); }
        }

        .effect-glitch {
            animation: glitchEffect 0.3s ease;
        }

        @keyframes glitchEffect {
            0% { transform: translateX(0); filter: hue-rotate(0deg); }
            20% { transform: translateX(-5px); filter: hue-rotate(90deg); }
            40% { transform: translateX(5px); filter: hue-rotate(180deg); }
            60% { transform: translateX(-3px); filter: hue-rotate(270deg); }
            80% { transform: translateX(3px); filter: hue-rotate(360deg); }
            100% { transform: translateX(0); filter: hue-rotate(0deg); }
        }

        .progress-bar {
            width: 100%;
            height: 6px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 3px;
            margin-top: 15px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
            width: 0%;
            transition: width 0.3s ease;
        }

        .particle {
            position: absolute;
            pointer-events: none;
            border-radius: 50%;
            z-index: 20;
        }

        .frequency-display {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.7);
            padding: 10px;
            border-radius: 10px;
            font-size: 12px;
            font-family: monospace;
            z-index: 15;
        }

        .export-controls {
            margin-top: 20px;
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .export-btn {
            padding: 12px 20px;
            background: linear-gradient(45deg, #45b7d1, #96ceb4);
            border: none;
            border-radius: 10px;
            color: white;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .export-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
        }

        .file-list {
            margin-top: 15px;
            max-height: 200px;
            overflow-y: auto;
        }

        .file-item {
            background: rgba(255, 255, 255, 0.1);
            padding: 10px;
            margin-bottom: 5px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .remove-btn {
            background: #ff6b6b;
            border: none;
            border-radius: 5px;
            color: white;
            padding: 5px 10px;
            cursor: pointer;
            font-size: 12px;
        }

        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🎵 Auto Beat-Sync Clip Maker Pro</h1>
            <p>AI-Powered Music Synchronization • Professional Visual Effects • Free Music Library</p>
        </div>

        <div class="tabs">
            <div class="tab active" onclick="switchTab('music')">🎵 Music Library</div>
            <div class="tab" onclick="switchTab('upload')">📁 Upload Content</div>
            <div class="tab" onclick="switchTab('effects')">⚡ Effects & Settings</div>
        </div>

        <!-- Music Library Tab -->
        <div class="tab-content active" id="music-tab">
            <h3 style="margin-bottom: 20px;">🎧 Free Dance Music Library</h3>
            <div class="music-browser">
                <div class="search-container">
                    <input type="text" class="search-input" id="musicSearch" placeholder="Search for dance, electronic, EDM, house, techno..." />
                    <select class="genre-filter" id="genreFilter">
                        <option value="">All Genres</option>
                        <option value="electronic">Electronic</option>
                        <option value="dance">Dance</option>
                        <option value="edm">EDM</option>
                        <option value="house">House</option>
                        <option value="techno">Techno</option>
                        <option value="dubstep">Dubstep</option>
                        <option value="trap">Trap</option>
                        <option value="ambient">Ambient</option>
                    </select>
                    <button class="search-btn" onclick="searchMusic()">🔍 Search</button>
                </div>
                <div class="music-grid" id="musicGrid">
                    <!-- Music cards will be populated here -->
                </div>
            </div>
        </div>

        <!-- Upload Content Tab -->
        <div class="tab-content" id="upload-tab">
            <h3 style="margin-bottom: 20px;">📁 Upload Your Content</h3>
            <div class="upload-section">
                <div class="upload-area" onclick="document.getElementById('audioFile').click()">
                    <input type="file" id="audioFile" accept="audio/*,video/*" multiple>
                    <div class="upload-icon">🎵</div>
                    <h4>Custom Audio/Music</h4>
                    <p>Upload your own tracks (.mp3, .wav, .mp4, .m4a)</p>
                </div>
                
                <div class="upload-area" onclick="document.getElementById('mediaFile').click()">
                    <input type="file" id="mediaFile" accept="image/*,video/*" multiple>
                    <div class="upload-icon">🎬</div>
                    <h4>Images/Videos</h4>
                    <p>Upload your visuals (.jpg, .png, .mp4, .mov, .gif)</p>
                </div>
            </div>

            <div class="file-list" id="uploadedFiles"></div>
        </div>

        <!-- Effects & Settings Tab -->
        <div class="tab-content" id="effects-tab">
            <h3 style="margin-bottom: 20px;">⚡ Effects & Settings</h3>
            <div class="controls-grid">
                <div class="control-group">
                    <label>🎭 Effect Style</label>
                    <select id="effectStyle">
                        <option value="auto">🤖 Auto-Detect</option>
                        <option value="electronic">⚡ Electronic/EDM</option>
                        <option value="hip-hop">🎤 Hip-Hop/Rap</option>
                        <option value="rock">🎸 Rock/Metal</option>
                        <option value="pop">💫 Pop/Dance</option>
                        <option value="chill">🌊 Chill/Ambient</option>
                        <option value="trap">🔥 Trap/Bass</option>
                        <option value="house">🏠 House/Techno</option>
                    </select>
                </div>
                
                <div class="control-group">
                    <label>⚡ Effect Intensity: <span id="intensityValue">7</span></label>
                    <input type="range" id="intensity" min="1" max="10" value="7" oninput="updateSliderValue('intensity', 'intensityValue')">
                </div>
                
                <div class="control-group">
                    <label>⏱️ Clip Duration (seconds)</label>
                    <input type="number" id="duration" min="5" max="120" value="15">
                </div>
                
                <div class="control-group">
                    <label>🎯 Beat Sensitivity: <span id="sensitivityValue">6</span></label>
                    <input type="range" id="sensitivity" min="1" max="10" value="6" oninput="updateSliderValue('sensitivity', 'sensitivityValue')">
                </div>

                <div class="control-group">
                    <label>🌈 Color Theme</label>
                    <select id="colorTheme">
                        <option value="neon">🌈 Neon Rainbow</option>
                        <option value="fire">🔥 Fire & Ice</option>
                        <option value="ocean">🌊 Ocean Waves</option>
                        <option value="sunset">🌅 Sunset Vibes</option>
                        <option value="cyber">🤖 Cyberpunk</option>
                    </select>
                </div>

                <div class="control-group">
                    <label>💥 Particle Effects</label>
                    <select id="particleMode">
                        <option value="dynamic">🎆 Dynamic</option>
                        <option value="minimal">✨ Minimal</option>
                        <option value="intense">💥 Intense</option>
                        <option value="off">❌ Off</option>
                    </select>
                </div>
            </div>

            <button class="generate-btn" id="generateBtn" onclick="generateClip()">
                🚀 Generate Auto-Synced Clip
            </button>
        </div>

        <!-- Preview Section -->
        <div class="preview-section">
            <h3 style="margin-bottom: 20px;">👀 Live Preview</h3>
            <div class="preview-container">
                <div class="preview-content" id="previewContent">
                    <p style="opacity: 0.7; text-align: center;">🎵 Your AI-generated clip will appear here...<br>Upload content and click Generate!</p>
                </div>
                <div class="effect-overlay" id="effectOverlay"></div>
                <div class="beat-indicator" id="beatIndicator">♪</div>
                <div class="frequency-display" id="frequencyDisplay">
                    <div>🎵 Frequency Analysis</div>
                    <div>Bass: <span id="bassLevel">0</span>%</div>
                    <div>Mid: <span id="midLevel">0</span>%</div>
                    <div>High: <span id="highLevel">0</span>%</div>
                    <div>BPM: <span id="bpmDisplay">0</span></div>
                </div>
                <div class="audio-visualizer" id="audioVisualizer"></div>
            </div>
            <div class="status" id="status">🎵 Ready to create your beat-synced masterpiece!</div>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>

            <div class="export-controls">
                <button class="export-btn" onclick="exportClip('mp4')">📱 Export MP4</button>
                <button class="export-btn" onclick="exportClip('gif')">🎞️ Export GIF</button>
                <button class="export-btn" onclick="shareClip()">📤 Share Clip</button>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let audioContext, analyser, dataArray, audioSource;
        let currentAudio = null;
        let currentMedia = [];
        let selectedMusic = null;
        let isPlaying = false;
        let beatDetector = null;
        let effectsEngine = null;
        let animationId = null;
        let clipRecorder = null;

        // Free music database (sample - in real app, connect to APIs)
        const freeMusicDatabase = [
            {
                id: 1,
                title: "Electric Dreams",
                artist: "SynthWave Pro",
                genre: "electronic",
                bpm: 128,
                duration: "3:45",
                url: "https://www.soundjay.com/misc/sounds/bell-ringing-05.wav", // Sample URL
                tags: ["edm", "electronic", "dance", "synth"]
            },
            {
                id: 2,
                title: "Bass Drop Revolution",
                artist: "EDM Master",
                genre: "dubstep",
                bpm: 140,
                duration: "4:12",
                url: "https://www.soundjay.com/misc/sounds/bell-ringing-05.wav",
                tags: ["dubstep", "bass", "electronic", "drop"]
            },
            {
                id: 3,
                title: "House Party Vibes",
                artist: "Deep House Collective",
                genre: "house",
                bpm: 124,
                duration: "5:30",
                url: "https://www.soundjay.com/misc/sounds/bell-ringing-05.wav",
                tags: ["house", "dance", "party", "groove"]
            },
            {
                id: 4,
                title: "Techno Underground",
                artist: "Cyber Beats",
                genre: "techno",
                bpm: 132,
                duration: "6:15",
                url: "https://www.soundjay.com/misc/sounds/bell-ringing-05.wav",
                tags: ["techno", "underground", "dark", "industrial"]
            },
            {
                id: 5,
                title: "Trap Energy",
                artist: "Urban Soundscape",
                genre: "trap",
                bpm: 150,
                duration: "3:20",
                url: "https://www.soundjay.com/misc/sounds/bell-ringing-05.wav",
                tags: ["trap", "hip-hop", "urban", "energy"]
            }
        ];

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            initAudioVisualizer();
            loadMusicLibrary();
            setupEventListeners();
            updateStatus('🎵 Welcome! Browse free music or upload your own content to get started!');
        });

        function setupEventListeners() {
            document.getElementById('audioFile').addEventListener('change', handleAudioUpload);
            document.getElementById('mediaFile').addEventListener('change', handleMediaUpload);
            document.getElementById('musicSearch').addEventListener('input', debounce(searchMusic, 300));
            document.getElementById('genreFilter').addEventListener('change', searchMusic);
        }

        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Tab switching
        function switchTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');

            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById(tabName + '-tab').classList.add('active');
        }

        // Music library functions
        function loadMusicLibrary() {
            searchMusic(); // Load all initially
        }

        function searchMusic() {
            const searchTerm = document.getElementById('musicSearch').value.toLowerCase();
            const genreFilter = document.getElementById('genreFilter').value;
            
            let filteredMusic = freeMusicDatabase.filter(track => {
                const matchesSearch = track.title.toLowerCase().includes(searchTerm) ||
                                    track.artist.toLowerCase().includes(searchTerm) ||
                                    track.tags.some(tag => tag.toLowerCase().includes(searchTerm));
                
                const matchesGenre = !genreFilter || track.genre === genreFilter;
                
                return matchesSearch && matchesGenre;
            });

            renderMusicGrid(filteredMusic);
        }

        function renderMusicGrid(tracks) {
            const grid = document.getElementById('musicGrid');
            grid.innerHTML = '';

            if (tracks.length === 0) {
                grid.innerHTML = '<p style="text-align: center; opacity: 0.7; grid-column: 1 / -1;">No tracks found. Try different search terms!</p>';
                return;
            }

            tracks.forEach(track => {
                const card = createMusicCard(track);
                grid.appendChild(card);
            });
        }

        function createMusicCard(track) {
            const card = document.createElement('div');
            card.className = 'music-card';
            card.onclick = () => selectMusic(track, card);

            card.innerHTML = `
                <div class="music-info">
                    <h4>${track.title}</h4>
                    <p>by ${track.artist} • ${track.genre} • ${track.bpm} BPM</p>
                    <p>Duration: ${track.duration}</p>
                </div>
                <div class="music-controls">
                    <button class="play-btn" onclick="event.stopPropagation(); previewTrack('${track.url}', this)">▶</button>
                    <div class="waveform">
                        <div class="waveform-progress"></div>
                    </div>
                </div>
            `;

            return card;
        }

        function selectMusic(track, cardElement) {
            // Remove previous selection
            document.querySelectorAll('.music-card').forEach(card => card.classList.remove('selected'));
            
            // Select new track
            cardElement.classList.add('selected');
            selectedMusic = track;
            
            updateStatus(`🎵 Selected: ${track.title} by ${track.artist}`);
            
            // Load the track
            loadSelectedMusic(track);
        }

        async function loadSelectedMusic(track) {
            try {
                currentAudio = await fetch(track.url).then(r => r.blob());
                updateStatus(`✅ Loaded: ${track.title} - Ready to generate!`);
            } catch (error) {
                updateStatus(`❌ Error loading track: ${track.title}`);
                console.error('Error loading music:', error);
            }
        }

        function previewTrack(url, button) {
            // Implementation for track preview
            button.innerHTML = '⏸';
            setTimeout(() => {
                button.innerHTML = '▶';
            }, 3000);
        }

        // File upload handlers
        async function handleAudioUpload(event) {
            const files = Array.from(event.target.files);
            if (files.length > 0) {
                const file = files[0];
                currentAudio = file;
                selectedMusic = null; // Clear library selection
                updateStatus(`🎵 Custom audio loaded: ${file.name}`);
                displayUploadedFiles();
            }
        }

        async function handleMediaUpload(event) {
            const files = Array.from(event.target.files);
            currentMedia = [...currentMedia, ...files];
            updateStatus(`🎬 ${files.length} media files added (Total: ${currentMedia.length})`);
            displayUploadedFiles();
        }

        function displayUploadedFiles() {
            const container = document.getElementById('uploadedFiles');
            container.innerHTML = '';

            if (currentAudio) {
                const item = document.createElement('div');
                item.className = 'file-item';
                item.innerHTML = `
                    <span>🎵 ${currentAudio.name || 'Selected Track'}</span>
                    <button class="remove-btn" onclick="removeAudio()">Remove</button>
                `;
                container.appendChild(item);
            }

            currentMedia.forEach((file, index) => {
                const item = document.createElement('div');
                item.className = 'file-item';
                item.innerHTML = `
                    <span>${file.type.startsWith('image/') ? '🖼️' : '🎬'} ${file.name}</span>
                    <button class="remove-btn" onclick="removeMedia(${index})">Remove</button>
                `;
                container.appendChild(item);
            });
        }

        function removeAudio() {
            currentAudio = null;
            selectedMusic = null;
            displayUploadedFiles();
            updateStatus('🎵 Audio removed');
        }

        function removeMedia(index) {
            currentMedia.splice(index, 1);
            displayUploadedFiles();
            updateStatus(`🎬 Media file removed (${currentMedia.length} remaining)`);
        }

        // Audio visualizer
        function initAudioVisualizer() {
            const visualizer = document.getElementById('audioVisualizer');
            for (let i = 0; i < 64; i++) {
                const bar = document.createElement('div');
                bar.className = 'audio-bar';
                bar.style.height = '5px';
                visualizer.appendChild(bar);
            }
        }

        // Beat Detection Engine
        class AdvancedBeatDetector {
            constructor(audioContext, analyser) {
                this.audioContext = audioContext;
                this.analyser = analyser;
                this.bufferSize = analyser.frequencyBinCount;
                this.dataArray = new Uint8Array(this.bufferSize);
                this.lastBeatTime = 0;
                this.beatThreshold = 0.4;
                this.energyHistory = [];
                this.bpmHistory = [];
                this.bassRange = [0, 8];
                this.midRange = [8, 24];
                this.highRange = [24, 64];
            }

            detectBeat() {
                this.analyser.getByteFrequencyData(this.dataArray);
                
                const bassEnergy = this.getFrequencyRangeEnergy(this.bassRange);
                const midEnergy = this.getFrequencyRangeEnergy(this.midRange);
                const highEnergy = this.getFrequencyRangeEnergy(this.highRange);
                
                const totalEnergy = bassEnergy + midEnergy + highEnergy;
                const normalizedEnergy = totalEnergy / 255;
                
                // Energy variance detection
                this.energyHistory.push(normalizedEnergy);
                if (this.energyHistory.length > 10) {
                    this.energyHistory.shift();
                }
                
                const avgEnergy = this.energyHistory.reduce((a, b) => a + b, 0) / this.energyHistory.length;
                const energyVariance = normalizedEnergy - avgEnergy;
                
                const now = this.audioContext.currentTime;
                const timeSinceLastBeat = now - this.lastBeatTime;
                
                // Adaptive beat detection
                let beatDetected = false;
                if (energyVariance > this.beatThreshold && timeSinceLastBeat > 0.15) {
                    beatDetected = true;
                    this.lastBeatTime = now;
                    
                    // BPM calculation
                    if (timeSinceLastBeat > 0) {
                        const currentBPM = 60 / timeSinceLastBeat;
                        this.bpmHistory.push(currentBPM);
                        if (this.bpmHistory.length > 8) {
                            this.bpmHistory.shift();
                        }
                    }
                }
                
                const avgBPM = this.bpmHistory.length > 0 ? 
                    this.bpmHistory.reduce((a, b) => a + b, 0) / this.bpmHistory.length : 0;
                
                return {
                    detected: beatDetected,
                    energy: normalizedEnergy,
                    bass: bassEnergy / 255,
                    mid: midEnergy / 255,
                    high: highEnergy / 255,
                    variance: energyVariance,
                    bpm: Math.round(avgBPM)
                };
            }

            getFrequencyRangeEnergy(range) {
                let energy = 0;
                for (let i = range[0]; i < Math.min(range[1], this.dataArray.length); i++) {
                    energy += this.dataArray[i];
                }
                return energy / (range[1] - range[0]);
            }
        }

        // Advanced Effects Engine
        class AdvancedEffectsEngine {
            constructor() {
                this.previewContent = document.getElementById('previewContent');
                this.effectOverlay = document.getElementById('effectOverlay');
                this.beatIndicator = document.getElementById('beatIndicator');
                this.currentMedia = null;
                this.mediaIndex = 0;
                this.colorTheme = 'neon';
                this.intensity = 7;
                this.particleMode = 'dynamic';
                this.effectStyle = 'auto';
                this.particles = [];
                this.lastEffectTime = 0;
            }

            updateSettings() {
                this.colorTheme = document.getElementById('colorTheme').value;
                this.intensity = parseInt(document.getElementById('intensity').value);
                this.particleMode = document.getElementById('particleMode').value;
                this.effectStyle = document.getElementById('effectStyle').value;
            }

            applyBeatEffect(beatData) {
                this.updateSettings();
                
                if (!beatData.detected) return;

                const now = performance.now();
                if (now - this.lastEffectTime < 100) return; // Throttle effects
                this.lastEffectTime = now;

                // Beat indicator with energy visualization
                this.beatIndicator.classList.add('beat-active');
                this.beatIndicator.style.backgroundColor = this.getThemeColor('primary');
                setTimeout(() => {
                    this.beatIndicator.classList.remove('beat-active');
                }, 300);

                // Apply effects based on frequency analysis
                if (beatData.bass > 0.7) {
                    this.applyBassEffect(beatData);
                } else if (beatData.high > 0.6) {
                    this.applyHighEffect(beatData);
                } else if (beatData.mid > 0.5) {
                    this.applyMidEffect(beatData);
                }

                // Style-specific effects
                this.applyStyleSpecificEffects(beatData);

                // Particle effects
                if (this.particleMode !== 'off') {
                    this.createAdvancedParticles(beatData);
                }

                // Media switching on strong beats
                if (beatData.energy > 0.8 && currentMedia.length > 1) {
                    this.switchMedia();
                }

                // Update frequency display
                this.updateFrequencyDisplay(beatData);
            }

            applyBassEffect(beatData) {
                this.previewContent.classList.add('effect-zoom');
                this.createShockwave();
                setTimeout(() => {
                    this.previewContent.classList.remove('effect-zoom');
                }, 600);
            }

            applyHighEffect(beatData) {
                this.previewContent.classList.add('effect-flash');
                this.createLightningEffect();
                setTimeout(() => {
                    this.previewContent.classList.remove('effect-flash');
                }, 400);
            }

            applyMidEffect(beatData) {
                this.previewContent.classList.add('effect-shake');
                setTimeout(() => {
                    this.previewContent.classList.remove('effect-shake');
                }, 400);
            }

            applyStyleSpecificEffects(beatData) {
                switch (this.effectStyle) {
                    case 'electronic':
                    case 'edm':
                        if (beatData.energy > 0.9) {
                            this.previewContent.classList.add('effect-glitch');
                            setTimeout(() => {
                                this.previewContent.classList.remove('effect-glitch');
                            }, 300);
                        }
                        break;
                    case 'trap':
                    case 'hip-hop':
                        if (beatData.bass > 0.8) {
                            this.createBassDropEffect();
                        }
                        break;
                }
            }

            createAdvancedParticles(beatData) {
                const particleCount = this.particleMode === 'intense' ? 8 : 
                                   this.particleMode === 'minimal' ? 2 : 4;

                for (let i = 0; i < particleCount; i++) {
                    this.createParticle(beatData);
                }
            }

            createParticle(beatData) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                
                const size = (beatData.energy * 20 + 5) * (this.intensity / 10);
                particle.style.width = size + 'px';
                particle.style.height = size + 'px';
                
                const colors = this.getThemeColors();
                particle.style.background = colors[Math.floor(Math.random() * colors.length)];
                particle.style.boxShadow = `0 0 ${size}px ${particle.style.background}`;
                
                particle.style.left = Math.random() * 100 + '%';
                particle.style.top = Math.random() * 100 + '%';
                
                this.effectOverlay.appendChild(particle);
                
                // Animate particle
                particle.animate([
                    { transform: 'scale(0)', opacity: 1 },
                    { transform: 'scale(1)', opacity: 0.8 },
                    { transform: 'scale(0)', opacity: 0 }
                ], {
                    duration: 1000 + Math.random() * 500,
                    easing: 'ease-out'
                }).onfinish = () => {
                    if (particle.parentNode) {
                        particle.parentNode.removeChild(particle);
                    }
                };
            }

            createShockwave() {
                const shockwave = document.createElement('div');
                shockwave.style.position = 'absolute';
                shockwave.style.left = '50%';
                shockwave.style.top = '50%';
                shockwave.style.width = '20px';
                shockwave.style.height = '20px';
                shockwave.style.border = `3px solid ${this.getThemeColor('primary')}`;
                shockwave.style.borderRadius = '50%';
                shockwave.style.transform = 'translate(-50%, -50%)';
                shockwave.style.pointerEvents = 'none';
                shockwave.style.zIndex = '25';
                
                this.effectOverlay.appendChild(shockwave);
                
                shockwave.animate([
                    { transform: 'translate(-50%, -50%) scale(0)', opacity: 1 },
                    { transform: 'translate(-50%, -50%) scale(10)', opacity: 0 }
                ], {
                    duration: 800,
                    easing: 'ease-out'
                }).onfinish = () => {
                    if (shockwave.parentNode) {
                        shockwave.parentNode.removeChild(shockwave);
                    }
                };
            }

            createLightningEffect() {
                const lightning = document.createElement('div');
                lightning.style.position = 'absolute';
                lightning.style.top = '0';
                lightning.style.left = '0';
                lightning.style.width = '100%';
                lightning.style.height = '100%';
                lightning.style.background = `linear-gradient(${Math.random() * 360}deg, transparent, ${this.getThemeColor('secondary')}, transparent)`;
                lightning.style.pointerEvents = 'none';
                lightning.style.zIndex = '25';
                
                this.effectOverlay.appendChild(lightning);
                
                setTimeout(() => {
                    if (lightning.parentNode) {
                        lightning.parentNode.removeChild(lightning);
                    }
                }, 150);
            }

            createBassDropEffect() {
                const container = this.effectOverlay;
                for (let i = 0; i < 12; i++) {
                    const ripple = document.createElement('div');
                    ripple.style.position = 'absolute';
                    ripple.style.left = '50%';
                    ripple.style.top = '50%';
                    ripple.style.width = '10px';
                    ripple.style.height = '10px';
                    ripple.style.background = this.getThemeColor('accent');
                    ripple.style.borderRadius = '50%';
                    ripple.style.transform = 'translate(-50%, -50%)';
                    ripple.style.pointerEvents = 'none';
                    ripple.style.zIndex = '25';
                    
                    container.appendChild(ripple);
                    
                    const angle = (i / 12) * 2 * Math.PI;
                    const distance = 300;
                    
                    ripple.animate([
                        { 
                            transform: 'translate(-50%, -50%) scale(1)',
                            opacity: 1
                        },
                        { 
                            transform: `translate(calc(-50% + ${Math.cos(angle) * distance}px), calc(-50% + ${Math.sin(angle) * distance}px)) scale(0)`,
                            opacity: 0
                        }
                    ], {
                        duration: 1000,
                        easing: 'ease-out',
                        delay: i * 50
                    }).onfinish = () => {
                        if (ripple.parentNode) {
                            ripple.parentNode.removeChild(ripple);
                        }
                    };
                }
            }

            getThemeColors() {
                const themes = {
                    neon: ['#ff6b6b', '#4ecdc4', '#45b7d1', '#f9ca24', '#6c5ce7'],
                    fire: ['#ff6b35', '#f7931e', '#ffd23f', '#ee5a24', '#e17055'],
                    ocean: ['#0984e3', '#74b9ff', '#00cec9', '#00b894', '#55a3ff'],
                    sunset: ['#fd79a8', '#fdcb6e', '#e17055', '#a29bfe', '#fd79a8'],
                    cyber: ['#00ff88', '#ff0088', '#8800ff', '#0088ff', '#ff8800']
                };
                return themes[this.colorTheme] || themes.neon;
            }

            getThemeColor(type) {
                const colors = this.getThemeColors();
                const index = {
                    primary: 0,
                    secondary: 1,
                    accent: 2
                };
                return colors[index[type]] || colors[0];
            }

            switchMedia() {
                if (currentMedia.length === 0) return;
                
                this.mediaIndex = (this.mediaIndex + 1) % currentMedia.length;
                const file = currentMedia[this.mediaIndex];
                
                if (file.type.startsWith('image/')) {
                    const img = document.createElement('img');
                    img.src = URL.createObjectURL(file);
                    img.className = 'preview-media';
                    this.previewContent.innerHTML = '';
                    this.previewContent.appendChild(img);
                } else if (file.type.startsWith('video/')) {
                    const video = document.createElement('video');
                    video.src = URL.createObjectURL(file);
                    video.className = 'preview-media';
                    video.muted = true;
                    video.loop = true;
                    video.play();
                    this.previewContent.innerHTML = '';
                    this.previewContent.appendChild(video);
                }
            }

            updateFrequencyDisplay(beatData) {
                document.getElementById('bassLevel').textContent = Math.round(beatData.bass * 100);
                document.getElementById('midLevel').textContent = Math.round(beatData.mid * 100);
                document.getElementById('highLevel').textContent = Math.round(beatData.high * 100);
                document.getElementById('bpmDisplay').textContent = beatData.bpm || 0;
            }
        }

        // Main generation function
        async function generateClip() {
            if (!currentAudio && !selectedMusic) {
                updateStatus('❌ Please select music from the library or upload an audio file!');
                return;
            }

            const generateBtn = document.getElementById('generateBtn');
            generateBtn.disabled = true;
            generateBtn.innerHTML = '<span class="loading-spinner"></span> Generating Magic...';

            try {
                // Initialize audio context
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                analyser = audioContext.createAnalyser();
                analyser.fftSize = 512;
                analyser.smoothingTimeConstant = 0.8;
                
                // Create audio element
                const audioElement = document.createElement('audio');
                
                if (selectedMusic) {
                    audioElement.src = selectedMusic.url;
                } else {
                    audioElement.src = URL.createObjectURL(currentAudio);
                }
                
                audioElement.crossOrigin = 'anonymous';
                audioElement.preload = 'auto';
                
                // Connect audio nodes
                audioSource = audioContext.createMediaElementSource(audioElement);
                audioSource.connect(analyser);
                analyser.connect(audioContext.destination);
                
                // Initialize engines
                beatDetector = new AdvancedBeatDetector(audioContext, analyser);
                effectsEngine = new AdvancedEffectsEngine();
                
                // Setup initial media
                if (currentMedia.length > 0) {
                    effectsEngine.switchMedia();
                } else {
                    // Create default visual
                    const canvas = document.createElement('canvas');
                    canvas.width = 800;
                    canvas.height = 450;
                    canvas.className = 'preview-media';
                    const ctx = canvas.getContext('2d');
                    
                    ctx.fillStyle = 'linear-gradient(45deg, #667eea, #764ba2)';
                    ctx.fillRect(0, 0, canvas.width, canvas.height);
                    ctx.fillStyle = 'white';
                    ctx.font = '48px Arial';
                    ctx.textAlign = 'center';
                    ctx.fillText('🎵 Audio Visualizer', canvas.width/2, canvas.height/2);
                    
                    document.getElementById('previewContent').innerHTML = '';
                    document.getElementById('previewContent').appendChild(canvas);
                }
                
                // Start playback
                await audioElement.play();
                isPlaying = true;
                
                updateStatus('🎵 AI analyzing music... Creating beat-synced magic!');
                
                // Animation loop
                function animate() {
                    if (!isPlaying) return;
                    
                    const beatData = beatDetector.detectBeat();
                    effectsEngine.applyBeatEffect(beatData);
                    updateAudioVisualizer();
                    updateProgress(audioElement);
                    
                    animationId = requestAnimationFrame(animate);
                }
                
                animate();
                
                // Auto-stop after duration
                const duration = parseInt(document.getElementById('duration').value) * 1000;
                setTimeout(() => {
                    audioElement.pause();
                    isPlaying = false;
                    if (animationId) {
                        cancelAnimationFrame(animationId);
                    }
                    updateStatus('✅ Beat-synced clip generation completed! 🎉');
                    generateBtn.disabled = false;
                    generateBtn.innerHTML = '🚀 Generate Auto-Synced Clip';
                }, duration);
                
            } catch (error) {
                console.error('Error generating clip:', error);
                updateStatus('❌ Error generating clip. Please try different settings.');
                generateBtn.disabled = false;
                generateBtn.innerHTML = '🚀 Generate Auto-Synced Clip';
            }
        }

        function updateAudioVisualizer() {
            if (!analyser) return;
            
            const dataArray = new Uint8Array(analyser.frequencyBinCount);
            analyser.getByteFrequencyData(dataArray);
            
            const bars = document.querySelectorAll('.audio-bar');
            const step = Math.floor(dataArray.length / bars.length);
            
            bars.forEach((bar, index) => {
                const value = dataArray[index * step];
                const height = Math.max(3, (value / 255) * 70);
                bar.style.height = height + 'px';
                
                // Color based on frequency
                if (index < bars.length / 3) {
                    bar.style.background = 'linear-gradient(to top, #ff6b6b, #ff8e8e)'; // Bass
                } else if (index < bars.length * 2 / 3) {
                    bar.style.background = 'linear-gradient(to top, #4ecdc4, #7ed7d1)'; // Mid
                } else {
                    bar.style.background = 'linear-gradient(to top, #45b7d1, #74c7e0)'; // High
                }
            });
        }

        function updateProgress(audioElement) {
            if (audioElement.duration) {
                const progress = (audioElement.currentTime / audioElement.duration) * 100;
                document.getElementById('progressFill').style.width = progress + '%';
            }
        }

        function updateSliderValue(sliderId, displayId) {
            const value = document.getElementById(sliderId).value;
            document.getElementById(displayId).textContent = value;
        }

        function updateStatus(message) {
            document.getElementById('status').innerHTML = message;
        }

        // Export functions
        function exportClip(format) {
            updateStatus(`🎬 Exporting as ${format.toUpperCase()}... (Feature coming soon!)`);
            // Implementation for actual export would go here
        }

        function shareClip() {
            updateStatus('📤 Share feature coming soon! Save your settings for now.');
            // Implementation for sharing would go here
        }

        // Initialize app
        updateStatus('🎵 Welcome to Auto Beat-Sync Clip Maker Pro! Choose music and start creating!');
    </script>
</body>
</html>
