<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#667eea">
    <meta name="apple-mobile-web-app-title" content="Beat-Sync Pro">
    <link rel="apple-touch-icon" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTgwIiBoZWlnaHQ9IjE4MCIgdmlld0JveD0iMCAwIDE4MCAxODAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PHJlY3Qgd2lkdGg9IjE4MCIgaGVpZ2h0PSIxODAiIHJ4PSI0MCIgZmlsbD0idXJsKCNncmFkaWVudCkiLz48ZGVmcz48bGluZWFyR3JhZGllbnQgaWQ9ImdyYWRpZW50IiB4MT0iMCIgeTE9IjAiIHgyPSIxIiB5Mj0iMSI+PHN0b3Agb2Zmc2V0PSIwIiBzdG9wLWNvbG9yPSIjNjY3ZWVhIi8+PHN0b3Agb2Zmc2V0PSIxIiBzdG9wLWNvbG9yPSIjNzY0YmEyIi8+PC9saW5lYXJHcmFkaWVudD48L2RlZnM+PHRleHQgeD0iOTAiIHk9IjEwNSIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iNjAiIGZpbGw9IndoaXRlIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIj7wn42oPC90ZXh0Pjwvc3ZnPg==">
    <title>Beat-Sync Clip Maker Pro</title>
    <style>
        :root {
            /* Default Dark Theme */
            --primary-bg: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --secondary-bg: rgba(255, 255, 255, 0.1);
            --accent-color: #4ecdc4;
            --text-primary: #ffffff;
            --text-secondary: rgba(255, 255, 255, 0.8);
            --border-color: rgba(255, 255, 255, 0.2);
            --glass-bg: rgba(255, 255, 255, 0.1);
            --shadow-color: rgba(0, 0, 0, 0.3);
            --illuminate-glow: 0 0 20px rgba(78, 205, 196, 0.5);
            --card-bg: rgba(255, 255, 255, 0.15);
        }

        /* Light Theme */
        body.light-theme {
            --primary-bg: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --secondary-bg: rgba(0, 0, 0, 0.05);
            --accent-color: #007AFF;
            --text-primary: #1a1a1a;
            --text-secondary: rgba(26, 26, 26, 0.7);
            --border-color: rgba(0, 0, 0, 0.1);
            --glass-bg: rgba(255, 255, 255, 0.8);
            --shadow-color: rgba(0, 0, 0, 0.1);
            --illuminate-glow: 0 0 20px rgba(0, 122, 255, 0.3);
            --card-bg: rgba(255, 255, 255, 0.9);
        }

        /* Color Themes */
        body.theme-ocean {
            --primary-bg: linear-gradient(135deg, #0984e3 0%, #74b9ff 100%);
            --accent-color: #00cec9;
            --illuminate-glow: 0 0 20px rgba(0, 206, 201, 0.5);
        }

        body.theme-sunset {
            --primary-bg: linear-gradient(135deg, #fd79a8 0%, #fdcb6e 100%);
            --accent-color: #e17055;
            --illuminate-glow: 0 0 20px rgba(225, 112, 85, 0.5);
        }

        body.theme-forest {
            --primary-bg: linear-gradient(135deg, #00b894 0%, #55a3ff 100%);
            --accent-color: #6c5ce7;
            --illuminate-glow: 0 0 20px rgba(108, 92, 231, 0.5);
        }

        body.theme-cyber {
            --primary-bg: linear-gradient(135deg, #2d3436 0%, #636e72 100%);
            --accent-color: #00ff88;
            --illuminate-glow: 0 0 20px rgba(0, 255, 136, 0.5);
        }

        body.theme-aurora {
            --primary-bg: linear-gradient(135deg, #a29bfe 0%, #6c5ce7 100%);
            --accent-color: #fd79a8;
            --illuminate-glow: 0 0 20px rgba(253, 121, 168, 0.5);
        }

        body.theme-fire {
            --primary-bg: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
            --accent-color: #f9ca24;
            --illuminate-glow: 0 0 20px rgba(249, 202, 36, 0.5);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
        }

        html, body {
            height: 100vh;
            height: 100dvh;
            overflow: hidden;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--primary-bg);
            color: var(--text-primary);
            position: fixed;
            width: 100%;
            transition: all 0.4s ease;
        }

        .app-container {
            height: 100vh;
            height: 100dvh;
            display: flex;
            flex-direction: column;
            padding-top: env(safe-area-inset-top);
            padding-bottom: env(safe-area-inset-bottom);
            padding-left: env(safe-area-inset-left);
            padding-right: env(safe-area-inset-right);
        }

        .header {
            text-align: center;
            padding: 15px 20px 10px;
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--border-color);
            position: relative;
            box-shadow: var(--illuminate-glow);
        }

        .header.illuminated {
            box-shadow: var(--illuminate-glow), 0 4px 20px var(--shadow-color);
            background: var(--card-bg);
        }

        .header h1 {
            font-size: 1.8rem;
            font-weight: 700;
            background: linear-gradient(45deg, var(--accent-color), #ff6b6b, #45b7d1);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 5px;
            filter: drop-shadow(0 0 10px rgba(78, 205, 196, 0.3));
        }

        .header p {
            font-size: 0.85rem;
            opacity: 0.9;
            line-height: 1.2;
            color: var(--text-secondary);
        }

        .settings-btn {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            background: var(--secondary-bg);
            backdrop-filter: blur(10px);
            border: none;
            border-radius: 12px;
            color: var(--text-primary);
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 1.2rem;
            transition: all 0.3s ease;
            box-shadow: var(--illuminate-glow);
        }

        .settings-btn:active {
            transform: translateY(-50%) scale(0.95);
            background: var(--card-bg);
        }

        .subscription-status {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            background: linear-gradient(45deg, #00b894, #55a3ff);
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 0.7rem;
            font-weight: 600;
            cursor: pointer;
            box-shadow: var(--illuminate-glow);
            backdrop-filter: blur(10px);
        }

        .subscription-status.free {
            background: var(--secondary-bg);
            color: var(--text-secondary);
        }

        .subscription-status.premium {
            background: linear-gradient(45deg, #f9ca24, #f0932b);
        }

        .subscription-status.pro {
            background: linear-gradient(45deg, #ff6b6b, #ee5a24);
        }

        .subscription-status.connected {
            background: linear-gradient(45deg, #007AFF, #1DB954);
            animation: connectedPulse 2s infinite;
        }

        @keyframes connectedPulse {
            0%, 100% { transform: translateY(-50%) scale(1); box-shadow: var(--illuminate-glow); }
            50% { transform: translateY(-50%) scale(1.05); box-shadow: var(--illuminate-glow), 0 0 30px rgba(0, 122, 255, 0.4); }
        }

        .workflow-steps {
            display: flex;
            padding: 15px 10px;
            gap: 8px;
            background: rgba(255, 255, 255, 0.05);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        .step {
            background: rgba(255, 255, 255, 0.1);
            padding: 12px 8px;
            border-radius: 12px;
            border: 2px solid transparent;
            transition: all 0.3s ease;
            min-width: 85px;
            text-align: center;
            cursor: pointer;
            flex-shrink: 0;
        }

        .step.active {
            border-color: #4ecdc4;
            background: rgba(78, 205, 196, 0.3);
            transform: scale(1.05);
        }

        .step.completed {
            border-color: #00b894;
            background: rgba(0, 184, 148, 0.3);
        }

        .step-number {
            background: #4ecdc4;
            color: white;
            width: 26px;
            height: 26px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 8px;
            font-weight: bold;
            font-size: 0.9rem;
        }

        .step.completed .step-number {
            background: #00b894;
        }

        .step-title {
            font-size: 0.75rem;
            font-weight: 600;
            margin-bottom: 2px;
        }

        .step-desc {
            font-size: 0.65rem;
            opacity: 0.8;
        }

        .main-content {
            flex: 1;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            padding: 20px 15px;
        }

        .step-content {
            display: none;
        }

        .step-content.active {
            display: block;
        }

        .section-title {
            font-size: 1.3rem;
            margin-bottom: 15px;
            font-weight: 600;
        }

        .selection-instructions {
            background: rgba(255, 255, 255, 0.15);
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 20px;
            border-left: 4px solid #4ecdc4;
            font-size: 0.85rem;
            line-height: 1.4;
        }

        .music-tier-tabs {
            display: flex;
            margin-bottom: 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 4px;
            gap: 4px;
        }

        .tier-tab {
            flex: 1;
            padding: 12px 8px;
            text-align: center;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.8rem;
            font-weight: 600;
            position: relative;
        }

        .tier-tab.active {
            background: rgba(255, 255, 255, 0.2);
        }

        .tier-tab.locked {
            opacity: 0.6;
        }

        .tier-tab .lock-icon {
            font-size: 0.7rem;
            margin-left: 4px;
        }

        .tier-tab .tier-price {
            font-size: 0.6rem;
            opacity: 0.8;
            margin-top: 2px;
        }

        .apple-music-panel,
        .spotify-panel {
            margin-bottom: 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .integration-header {
            margin-bottom: 20px;
        }

        .apple-connect-btn,
        .spotify-connect-btn {
            background: linear-gradient(45deg, #007AFF, #5856D6);
            border: none;
            border-radius: 12px;
            color: white;
            padding: 12px 20px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            min-height: 44px;
        }

        .spotify-connect-btn {
            background: linear-gradient(45deg, #1DB954, #1ed760);
        }

        .apple-connect-btn:active,
        .spotify-connect-btn:active {
            transform: scale(0.95);
        }

        .apple-connect-btn.connected {
            background: linear-gradient(45deg, #34C759, #30D158);
        }

        .spotify-connect-btn.connected {
            background: linear-gradient(45deg, #1DB954, #1ed760);
        }

        .apple-auth-status,
        .spotify-auth-status {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .apple-tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 15px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 4px;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        .apple-tab {
            flex: 1;
            padding: 10px 8px;
            background: transparent;
            border: none;
            border-radius: 6px;
            color: white;
            font-size: 0.8rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            white-space: nowrap;
            min-width: 80px;
        }

        .apple-tab.active {
            background: rgba(255, 255, 255, 0.2);
        }

        .apple-tab:active {
            transform: scale(0.95);
        }

        .apple-search-bar {
            display: flex;
            gap: 10px;
        }

        .apple-music-grid,
        .spotify-music-grid {
            display: flex;
            flex-direction: column;
            gap: 12px;
            max-height: 400px;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            padding: 5px;
        }

        .apple-track-card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 15px;
            display: flex;
            align-items: center;
            gap: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }

        .apple-track-card:active {
            transform: scale(0.98);
        }

        .apple-track-card.selected {
            border-color: #007AFF;
            background: rgba(0, 122, 255, 0.2);
        }

        .spotify-track-card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 15px;
            display: flex;
            align-items: center;
            gap: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }

        .spotify-track-card:active {
            transform: scale(0.98);
        }

        .spotify-track-card.selected {
            border-color: #1DB954;
            background: rgba(29, 185, 84, 0.2);
        }

        .track-artwork {
            width: 50px;
            height: 50px;
            border-radius: 8px;
            background: linear-gradient(45deg, #667eea, #764ba2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            flex-shrink: 0;
        }

        .track-info {
            flex: 1;
            min-width: 0;
        }

        .track-title {
            font-weight: 600;
            font-size: 0.95rem;
            margin-bottom: 4px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .track-artist {
            font-size: 0.8rem;
            opacity: 0.8;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .track-controls {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-shrink: 0;
        }

        .mini-play-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            border-radius: 50%;
            width: 35px;
            height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: white;
            font-size: 12px;
            transition: all 0.3s ease;
        }

        .mini-play-btn:active {
            transform: scale(0.9);
        }

        .mini-play-btn.playing {
            background: #007AFF;
        }

        .track-duration {
            font-size: 0.75rem;
            opacity: 0.6;
            min-width: 35px;
            text-align: right;
        }

        .connection-status {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.8rem;
            margin-top: 10px;
        }

        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #ff6b6b;
        }

        .status-indicator.connected {
            background: #34C759;
        }

        .service-stats {
            display: flex;
            justify-content: space-between;
            margin-top: 15px;
            font-size: 0.75rem;
            opacity: 0.7;
        }

        .import-progress {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 15px;
            margin-top: 15px;
            text-align: center;
            display: none;
        }

        .import-progress.active {
            display: block;
        }

        .progress-text {
            margin-bottom: 10px;
            font-size: 0.9rem;
        }

        .mini-progress-bar {
            width: 100%;
            height: 4px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 2px;
            overflow: hidden;
        }

        .mini-progress-fill {
            height: 100%;
            background: linear-gradient(45deg, #007AFF, #5856D6);
            width: 0%;
            transition: width 0.3s ease;
        }

        .search-container {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 20px;
        }

        .search-input {
            width: 100%;
            padding: 14px 15px;
            border-radius: 12px;
            border: none;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            font-size: 1rem;
            outline: none;
        }

        .search-input::placeholder {
            color: rgba(255, 255, 255, 0.7);
        }

        .search-row {
            display: flex;
            gap: 10px;
        }

        .genre-filter {
            flex: 1;
            padding: 14px 15px;
            border-radius: 12px;
            border: none;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            font-size: 0.9rem;
            outline: none;
        }

        .genre-filter option {
            background: #333;
            color: white;
        }

        .search-btn {
            padding: 14px 20px;
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
            border: none;
            border-radius: 12px;
            color: white;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.9rem;
            min-width: 80px;
        }

        .music-grid {
            display: flex;
            flex-direction: column;
            gap: 15px;
            max-height: 400px;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            padding: 5px;
        }

        .music-card {
            background: rgba(255, 255, 255, 0.15);
            border-radius: 15px;
            padding: 18px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 3px solid transparent;
            position: relative;
        }

        .music-card:active {
            transform: scale(0.98);
        }

        .music-card.selected {
            border-color: #ff6b6b;
            background: rgba(255, 107, 107, 0.25);
            box-shadow: 0 0 20px rgba(255, 107, 107, 0.3);
        }

        .music-card.playing {
            border-color: #f9ca24;
            background: rgba(249, 202, 36, 0.25);
            animation: pulse 2s infinite;
        }

        .music-card.locked {
            opacity: 0.6;
            background: rgba(255, 255, 255, 0.1);
        }

        .music-card.locked::after {
            content: '🔒';
            position: absolute;
            top: 15px;
            right: 15px;
            font-size: 1.2rem;
        }

        @keyframes pulse {
            0%, 100% { box-shadow: 0 0 20px rgba(249, 202, 36, 0.3); }
            50% { box-shadow: 0 0 30px rgba(249, 202, 36, 0.6); }
        }

        .music-info h4 {
            margin-bottom: 8px;
            color: #fff;
            font-size: 1.1rem;
            font-weight: 600;
        }

        .music-info p {
            color: rgba(255, 255, 255, 0.8);
            font-size: 0.85rem;
            margin-bottom: 5px;
            line-height: 1.3;
        }

        .music-tier-badge {
            position: absolute;
            top: 15px;
            right: 15px;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.6rem;
            font-weight: 600;
        }

        .music-tier-badge.free {
            background: rgba(255, 255, 255, 0.2);
        }

        .music-tier-badge.premium {
            background: linear-gradient(45deg, #f9ca24, #f0932b);
        }

        .music-tier-badge.pro {
            background: linear-gradient(45deg, #ff6b6b, #ee5a24);
        }

        .music-controls {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-top: 15px;
        }

        .play-btn {
            background: #4ecdc4;
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: white;
            font-size: 18px;
            transition: all 0.3s ease;
            flex-shrink: 0;
        }

        .play-btn:active {
            transform: scale(0.95);
        }

        .play-btn.playing {
            background: #f9ca24;
            animation: playingPulse 1s infinite;
        }

        .play-btn:disabled {
            background: #95a5a6;
            cursor: not-allowed;
        }

        @keyframes playingPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .waveform {
            flex: 1;
            height: 40px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            position: relative;
            overflow: hidden;
            display: flex;
            align-items: center;
            padding: 0 12px;
        }

        .waveform-progress {
            height: 70%;
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
            border-radius: 15px;
            width: 0%;
            transition: width 0.1s ease;
        }

        .waveform-time {
            position: absolute;
            right: 12px;
            font-size: 0.75rem;
            color: rgba(255, 255, 255, 0.9);
            z-index: 2;
            font-weight: 500;
        }

        .select-btn {
            background: linear-gradient(45deg, #00b894, #55a3ff);
            border: none;
            border-radius: 12px;
            color: white;
            padding: 12px 16px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.85rem;
            transition: all 0.3s ease;
            min-height: 44px;
        }

        .select-btn:active {
            transform: scale(0.95);
        }

        .select-btn.selected {
            background: linear-gradient(45deg, #ff6b6b, #ff8e8e);
        }

        .select-btn:disabled {
            background: #95a5a6;
            cursor: not-allowed;
        }

        .upgrade-btn {
            background: linear-gradient(45deg, #f9ca24, #f0932b);
            border: none;
            border-radius: 12px;
            color: white;
            padding: 12px 16px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.85rem;
            transition: all 0.3s ease;
            min-height: 44px;
        }

        .upgrade-btn:active {
            transform: scale(0.95);
        }

        .upload-section {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 20px;
        }

        .upload-area {
            border: 3px dashed rgba(255, 255, 255, 0.5);
            border-radius: 15px;
            padding: 30px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            min-height: 140px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .upload-area:active {
            transform: scale(0.98);
        }

        .upload-area.has-files {
            border-color: #00b894;
            background: rgba(0, 184, 148, 0.15);
        }

        .upload-area input {
            position: absolute;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }

        .upload-icon {
            font-size: 2.5rem;
            margin-bottom: 12px;
            opacity: 0.8;
        }

        .upload-area h4 {
            font-size: 1.1rem;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .upload-area p {
            font-size: 0.85rem;
            opacity: 0.8;
            line-height: 1.3;
        }

        .controls-grid {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 20px;
        }

        .control-group {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .control-group label {
            display: block;
            margin-bottom: 10px;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .control-group select,
        .control-group input {
            width: 100%;
            padding: 12px;
            border-radius: 10px;
            border: none;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            font-size: 1rem;
            outline: none;
        }

        .control-group input[type="range"] {
            padding: 0;
            height: 44px;
            -webkit-appearance: none;
            background: transparent;
        }

        .control-group input[type="range"]::-webkit-slider-track {
            background: rgba(255, 255, 255, 0.3);
            height: 6px;
            border-radius: 3px;
        }

        .control-group input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 24px;
            width: 24px;
            border-radius: 50%;
            background: #4ecdc4;
            cursor: pointer;
            margin-top: -9px;
        }

        .control-group select option {
            background: #333;
            color: white;
        }

        .next-step-btn {
            width: 100%;
            padding: 18px;
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
            border: none;
            border-radius: 12px;
            color: white;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 20px;
            min-height: 56px;
        }

        .next-step-btn:active {
            transform: scale(0.98);
        }

        .next-step-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .generate-btn {
            width: 100%;
            padding: 20px;
            background: linear-gradient(45deg, #00b894, #55a3ff);
            border: none;
            border-radius: 12px;
            color: white;
            font-size: 1.2rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 20px;
            min-height: 60px;
        }

        .generate-btn:active {
            transform: scale(0.98);
        }

        .generate-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .export-btn {
            width: 100%;
            padding: 18px;
            background: linear-gradient(45deg, #6c5ce7, #a29bfe);
            border: none;
            border-radius: 12px;
            color: white;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 15px;
            min-height: 56px;
        }

        .export-btn:active {
            transform: scale(0.98);
        }

        .export-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .button-row {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .button-row .next-step-btn {
            margin-top: 0;
        }

        .preview-section {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            margin-top: 20px;
        }

        .preview-container {
            position: relative;
            width: 100%;
            aspect-ratio: 16/9;
            background: #000;
            border-radius: 12px;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 15px;
        }

        .preview-content {
            width: 100%;
            height: 100%;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
            text-align: center;
            padding: 20px;
        }

        .preview-media {
            max-width: 100%;
            max-height: 100%;
            object-fit: cover;
            border-radius: 8px;
        }

        .effect-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 10;
        }

        .audio-visualizer {
            position: absolute;
            bottom: 10px;
            left: 10px;
            right: 10px;
            height: 60px;
            display: flex;
            align-items: end;
            gap: 2px;
            z-index: 15;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 8px;
            padding: 8px;
        }

        .audio-bar {
            flex: 1;
            background: linear-gradient(to top, #ff6b6b, #4ecdc4, #45b7d1);
            border-radius: 1px;
            transition: height 0.05s ease;
            opacity: 0.9;
            min-height: 2px;
        }

        .status {
            text-align: center;
            padding: 12px;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.1);
            font-weight: 500;
            font-size: 0.85rem;
            line-height: 1.3;
        }

        .beat-indicator {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 20px;
            height: 20px;
            background: #ff6b6b;
            border-radius: 50%;
            z-index: 15;
            opacity: 0;
            transition: all 0.1s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: bold;
        }

        .beat-active {
            opacity: 1;
            animation: beatPulse 0.3s ease;
            box-shadow: 0 0 15px rgba(255, 107, 107, 0.8);
        }

        @keyframes beatPulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.5); }
            100% { transform: scale(1); }
        }

        .file-list {
            margin-top: 15px;
            max-height: 200px;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        .file-item {
            background: rgba(255, 255, 255, 0.1);
            padding: 12px;
            margin-bottom: 8px;
            border-radius: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.85rem;
        }

        .remove-btn {
            background: #ff6b6b;
            border: none;
            border-radius: 8px;
            color: white;
            padding: 8px 12px;
            cursor: pointer;
            font-size: 0.75rem;
            font-weight: 500;
            min-height: 36px;
        }

        .remove-btn:active {
            transform: scale(0.95);
        }

        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .progress-bar {
            width: 100%;
            height: 6px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 3px;
            margin-top: 12px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
            width: 0%;
            transition: width 0.3s ease;
        }

        .effect-flash { animation: flashEffect 0.4s ease; }
        @keyframes flashEffect {
            0% { filter: brightness(1) contrast(1) saturate(1); }
            50% { filter: brightness(1.8) contrast(1.4) saturate(1.6) hue-rotate(30deg); }
            100% { filter: brightness(1) contrast(1) saturate(1); }
        }

        .effect-zoom { animation: zoomEffect 0.6s ease; }
        @keyframes zoomEffect {
            0% { transform: scale(1) rotate(0deg); }
            50% { transform: scale(1.15) rotate(2deg); }
            100% { transform: scale(1) rotate(0deg); }
        }

        .effect-shake { animation: shakeEffect 0.4s ease; }
        @keyframes shakeEffect {
            0%, 100% { transform: translateX(0) translateY(0); }
            25% { transform: translateX(-8px) translateY(4px); }
            75% { transform: translateX(8px) translateY(-4px); }
        }

        .particle {
            position: absolute;
            pointer-events: none;
            border-radius: 50%;
            z-index: 20;
        }

        /* Settings Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal-content {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 20px;
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow: hidden;
            position: relative;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .modal-header {
            padding: 20px;
            text-align: center;
            background: rgba(255, 255, 255, 0.1);
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            position: relative;
        }

        .modal-header h2 {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .close-btn {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .close-btn:active {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-50%) scale(0.95);
        }

        .modal-body {
            padding: 20px;
            max-height: 70vh;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        .settings-section {
            margin-bottom: 25px;
        }

        .settings-section h3 {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 15px;
            color: #4ecdc4;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .settings-grid {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .setting-item {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .setting-item label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            font-size: 0.9rem;
        }

        .setting-item input,
        .setting-item select {
            width: 100%;
            padding: 12px;
            border-radius: 8px;
            border: none;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            font-size: 1rem;
            outline: none;
        }

        .setting-item input[type="range"] {
            padding: 0;
            height: 40px;
            -webkit-appearance: none;
            background: transparent;
        }

        .setting-item input[type="range"]::-webkit-slider-track {
            background: rgba(255, 255, 255, 0.3);
            height: 6px;
            border-radius: 3px;
        }

        .setting-item input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 20px;
            width: 20px;
            border-radius: 50%;
            background: #4ecdc4;
            cursor: pointer;
            margin-top: -7px;
        }

        .setting-item select option {
            background: #333;
            color: white;
        }

        .setting-toggle {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .toggle-switch {
            position: relative;
            width: 50px;
            height: 28px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .toggle-switch.active {
            background: #4ecdc4;
        }

        .toggle-switch::after {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 24px;
            height: 24px;
            background: white;
            border-radius: 50%;
            transition: all 0.3s ease;
        }

        .toggle-switch.active::after {
            left: 24px;
        }

        .subscription-plans {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .plan-card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            border: 2px solid transparent;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .plan-card.current {
            border-color: #4ecdc4;
            background: rgba(78, 205, 196, 0.2);
        }

        .plan-card.recommended {
            border-color: #f9ca24;
            background: rgba(249, 202, 36, 0.2);
        }

        .plan-card.recommended::before {
            content: '⭐ RECOMMENDED';
            position: absolute;
            top: -10px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(45deg, #f9ca24, #f0932b);
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 600;
        }

        .plan-header {
            text-align: center;
            margin-bottom: 15px;
        }

        .plan-name {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .plan-price {
            font-size: 1.8rem;
            font-weight: 700;
            color: #4ecdc4;
            margin-bottom: 5px;
        }

        .plan-period {
            font-size: 0.8rem;
            opacity: 0.8;
        }

        .plan-features {
            list-style: none;
            margin-bottom: 20px;
        }

        .plan-features li {
            padding: 8px 0;
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .plan-features li::before {
            content: '✓';
            color: #4ecdc4;
            font-weight: bold;
        }

        .plan-btn {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .plan-btn.current {
            background: rgba(255, 255, 255, 0.2);
            color: white;
        }

        .plan-btn.upgrade {
            background: linear-gradient(45deg, #f9ca24, #f0932b);
            color: white;
        }

        .plan-btn.premium {
            background: linear-gradient(45deg, #ff6b6b, #ee5a24);
            color: white;
        }

        .plan-btn:active {
            transform: scale(0.98);
        }

        /* iOS specific optimizations */
        @supports (-webkit-touch-callout: none) {
            .app-container {
                height: -webkit-fill-available;
            }
        }

        /* Landscape mode adjustments */
        @media screen and (orientation: landscape) and (max-height: 500px) {
            .header {
                padding: 10px 20px 5px;
            }
            
            .header h1 {
                font-size: 1.5rem;
                margin-bottom: 3px;
            }
            
            .header p {
                font-size: 0.75rem;
            }
            
            .workflow-steps {
                padding: 10px;
            }
            
            .main-content {
                padding: 15px;
            }
            
            .preview-container {
                aspect-ratio: 2/1;
            }
        }

        /* Dark mode media query */
        @media (prefers-color-scheme: dark) {
            .control-group input,
            .control-group select,
            .search-input,
            .genre-filter,
            .setting-item input,
            .setting-item select {
                background: rgba(255, 255, 255, 0.15);
            }
        }

        /* Accessibility improvements */
        @media (prefers-reduced-motion: reduce) {
            * {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }

        /* Touch feedback for better UX */
        .music-card:active,
        .upload-area:active,
        .step:active,
        .plan-card:active {
            background: rgba(255, 255, 255, 0.2);
        }

        /* Ensure minimum touch target size */
        button, .play-btn, .select-btn, .remove-btn, .toggle-switch {
            min-height: 44px;
            min-width: 44px;
        }

        /* Hide scrollbar on iOS */
        .music-grid::-webkit-scrollbar,
        .main-content::-webkit-scrollbar,
        .file-list::-webkit-scrollbar,
        .modal-body::-webkit-scrollbar {
            display: none;
        }

        /* Export section styles */
        .export-section {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            margin-top: 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .export-options {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 20px;
        }

        .export-format-tabs {
            display: flex;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 4px;
            gap: 4px;
        }

        .format-tab {
            flex: 1;
            padding: 10px 8px;
            text-align: center;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .format-tab.active {
            background: rgba(255, 255, 255, 0.2);
        }

        .quality-selector {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 10px;
        }

        .share-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .share-btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 10px;
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.8rem;
        }

        .share-btn.instagram {
            background: linear-gradient(45deg, #833ab4, #fd1d1d, #fcb045);
        }

        .share-btn.tiktok {
            background: linear-gradient(45deg, #ff0050, #000);
        }

        .share-btn.youtube {
            background: linear-gradient(45deg, #ff0000, #cc0000);
        }

        .share-btn:active {
            transform: scale(0.95);
        }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="header">
            <div class="subscription-status" id="subscriptionStatus" onclick="openSubscription()">
                FREE
            </div>
            <h1>🎵 Beat-Sync Pro</h1>
            <p>AI Music Synchronization</p>
            <button class="settings-btn" onclick="openSettings()">⚙️</button>
        </div>

        <!-- Workflow Steps -->
        <div class="workflow-steps">
            <div class="step active" id="step1" onclick="goToStep(1)">
                <div class="step-number">1</div>
                <div class="step-title">Music</div>
                <div class="step-desc">Choose</div>
            </div>
            <div class="step" id="step2" onclick="goToStep(2)">
                <div class="step-number">2</div>
                <div class="step-title">Visuals</div>
                <div class="step-desc">Upload</div>
            </div>
            <div class="step" id="step3" onclick="goToStep(3)">
                <div class="step-number">3</div>
                <div class="step-title">Effects</div>
                <div class="step-desc">Customize</div>
            </div>
            <div class="step" id="step4" onclick="goToStep(4)">
                <div class="step-number">4</div>
                <div class="step-title">Generate</div>
                <div class="step-desc">Create</div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Step 1: Choose Music -->
            <div class="step-content active" id="content1">
                <h3 class="section-title">🎵 Choose Your Music</h3>
                
                <div class="selection-instructions">
                    <strong>🎯 How to Select:</strong><br>
                    • Tap ▶ to preview tracks<br>
                    • Tap "Select Track" to choose<br>
                    • Upgrade for premium content<br>
                    <button onclick="testAudio()" style="background: #4ecdc4; border: none; border-radius: 8px; color: white; padding: 8px 16px; margin-top: 10px; font-size: 0.8rem; cursor: pointer;">
                        🔊 Test Audio System
                    </button>
                </div>

                <!-- Music Tier Tabs -->
                <div class="music-tier-tabs">
                    <div class="tier-tab active" data-tier="free" onclick="switchMusicTier('free')">
                        <div>FREE</div>
                        <div class="tier-price">5 Tracks</div>
                    </div>
                    <div class="tier-tab" data-tier="premium" onclick="switchMusicTier('premium')">
                        <div>PREMIUM</div>
                        <div class="tier-price">$4.99/mo</div>
                        <div class="lock-icon" id="premiumLock">🔒</div>
                    </div>
                    <div class="tier-tab" data-tier="pro" onclick="switchMusicTier('pro')">
                        <div>PRO</div>
                        <div class="tier-price">$9.99/mo</div>
                        <div class="lock-icon" id="proLock">🔒</div>
                    </div>
                    <div class="tier-tab" data-tier="apple" onclick="switchMusicTier('apple')">
                        <div>🍎 APPLE</div>
                        <div class="tier-price">iTunes</div>
                    </div>
                    <div class="tier-tab" data-tier="spotify" onclick="switchMusicTier('spotify')">
                        <div>🎵 SPOTIFY</div>
                        <div class="tier-price">Connect</div>
                    </div>
                </div>

                <!-- Apple Music Integration Panel -->
                <div class="apple-music-panel" id="appleMusicPanel" style="display: none;">
                    <div class="integration-header">
                        <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 20px;">
                            <div style="font-size: 2rem;">🍎</div>
                            <div>
                                <h3>Apple Music Integration</h3>
                                <p style="font-size: 0.8rem; opacity: 0.8;">Access your iTunes library and Apple Music</p>
                            </div>
                            <button class="apple-connect-btn" id="appleConnectBtn" onclick="connectAppleMusic()">
                                Connect
                            </button>
                        </div>
                    </div>

                    <div class="apple-auth-status" id="appleAuthStatus">
                        <div style="text-align: center; padding: 20px; opacity: 0.7;">
                            🔐 Connect to Apple Music to access your library
                        </div>
                    </div>

                    <div class="apple-library-browser" id="appleLibraryBrowser" style="display: none;">
                        <div class="apple-tabs">
                            <button class="apple-tab active" onclick="switchAppleTab('library')">My Library</button>
                            <button class="apple-tab" onclick="switchAppleTab('playlists')">Playlists</button>
                            <button class="apple-tab" onclick="switchAppleTab('search')">Apple Music</button>
                            <button class="apple-tab" onclick="switchAppleTab('recent')">Recently Played</button>
                        </div>

                        <div class="apple-search-bar" style="margin: 15px 0;">
                            <input type="text" class="search-input" id="appleSearchInput" placeholder="Search your music library..." />
                            <button class="search-btn" onclick="searchAppleMusic()">🔍</button>
                        </div>

                        <div class="apple-music-grid" id="appleMusicGrid">
                            <!-- Apple Music tracks will be populated here -->
                        </div>
                    </div>
                </div>

                <!-- Spotify Integration Panel -->
                <div class="spotify-panel" id="spotifyPanel" style="display: none;">
                    <div class="integration-header">
                        <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 20px;">
                            <div style="font-size: 2rem;">🎵</div>
                            <div>
                                <h3>Spotify Integration</h3>
                                <p style="font-size: 0.8rem; opacity: 0.8;">Access your Spotify playlists and music</p>
                            </div>
                            <button class="spotify-connect-btn" id="spotifyConnectBtn" onclick="connectSpotify()">
                                Connect
                            </button>
                        </div>
                    </div>

                    <div class="spotify-auth-status" id="spotifyAuthStatus">
                        <div style="text-align: center; padding: 20px; opacity: 0.7;">
                            🔐 Connect to Spotify to access your playlists
                        </div>
                    </div>

                    <div class="spotify-library-browser" id="spotifyLibraryBrowser" style="display: none;">
                        <div class="apple-tabs">
                            <button class="apple-tab active" onclick="switchSpotifyTab('playlists')">My Playlists</button>
                            <button class="apple-tab" onclick="switchSpotifyTab('liked')">Liked Songs</button>
                            <button class="apple-tab" onclick="switchSpotifyTab('search')">Search</button>
                            <button class="apple-tab" onclick="switchSpotifyTab('recent')">Recently Played</button>
                        </div>

                        <div class="apple-search-bar" style="margin: 15px 0;">
                            <input type="text" class="search-input" id="spotifySearchInput" placeholder="Search Spotify..." />
                            <button class="search-btn" onclick="searchSpotify()">🔍</button>
                        </div>

                        <div class="spotify-music-grid" id="spotifyMusicGrid">
                            <!-- Spotify tracks will be populated here -->
                        </div>
                    </div>
                </div>

                <div class="search-container">
                    <input type="text" class="search-input" id="musicSearch" placeholder="Search dance, EDM, house..." />
                    <div class="search-row">
                        <select class="genre-filter" id="genreFilter">
                            <option value="">All Genres</option>
                            <option value="electronic">Electronic</option>
                            <option value="dance">Dance</option>
                            <option value="edm">EDM</option>
                            <option value="house">House</option>
                            <option value="techno">Techno</option>
                            <option value="dubstep">Dubstep</option>
                            <option value="trap">Trap</option>
                            <option value="chill">Chill</option>
                            <option value="drum-bass">Drum & Bass</option>
                            <option value="future-bass">Future Bass</option>
                        </select>
                        <button class="search-btn" onclick="searchMusic()">🔍</button>
                    </div>
                </div>

                <div class="music-grid" id="musicGrid">
                    <!-- Music cards will be populated here -->
                </div>

                <div style="text-align: center; margin: 20px 0; font-weight: 600; opacity: 0.8;">
                    -- OR --
                </div>

                <div class="upload-section">
                    <div class="upload-area" id="audioUploadArea" onclick="document.getElementById('audioFile').click()">
                        <input type="file" id="audioFile" accept="audio/*,video/*">
                        <div class="upload-icon">🎵</div>
                        <h4>Upload Your Music</h4>
                        <p>Tap to upload (.mp3, .wav, .m4a)</p>
                    </div>
                </div>

                <button class="next-step-btn" id="nextStep1" onclick="nextStep()" disabled>
                    ➡️ Next: Add Visuals
                </button>
            </div>

            <!-- Step 2: Add Visuals -->
            <div class="step-content" id="content2">
                <h3 class="section-title">🎬 Add Visual Content</h3>
                
                <div class="selection-instructions">
                    <strong>📁 Upload Tips:</strong><br>
                    • Add 3-10 files for best variety<br>
                    • AI switches content on beat drops<br>
                    • Images and videos both supported
                </div>

                <div class="upload-section">
                    <div class="upload-area" id="mediaUploadArea" onclick="document.getElementById('mediaFile').click()">
                        <input type="file" id="mediaFile" accept="image/*,video/*" multiple>
                        <div class="upload-icon">🎬</div>
                        <h4>Upload Images & Videos</h4>
                        <p>Tap to select multiple files</p>
                    </div>
                </div>

                <div class="file-list" id="uploadedFiles"></div>

                <div class="button-row">
                    <button class="next-step-btn" style="flex: 1; background: linear-gradient(45deg, #95a5a6, #7f8c8d);" onclick="prevStep()">
                        ⬅️ Back
                    </button>
                    <button class="next-step-btn" style="flex: 1;" id="nextStep2" onclick="nextStep()">
                        ➡️ Next
                    </button>
                </div>
            </div>

            <!-- Step 3: Set Effects -->
            <div class="step-content" id="content3">
                <h3 class="section-title">⚡ Customize Effects</h3>
                
                <div class="selection-instructions">
                    <strong>🎛️ Effect Settings:</strong><br>
                    • Auto-Detect chooses best effects<br>
                    • Higher intensity = more dramatic<br>
                    • Adjust for your music style
                </div>

                <div class="controls-grid">
                    <div class="control-group">
                        <label>🎭 Effect Style</label>
                        <select id="effectStyle">
                            <option value="auto">🤖 Auto-Detect</option>
                            <option value="electronic">⚡ Electronic/EDM</option>
                            <option value="hip-hop">🎤 Hip-Hop/Rap</option>
                            <option value="pop">💫 Pop/Dance</option>
                            <option value="chill">🌊 Chill/Ambient</option>
                            <option value="trap">🔥 Trap/Bass</option>
                        </select>
                    </div>
                    
                    <div class="control-group">
                        <label>⚡ Effect Intensity: <span id="intensityValue">7</span></label>
                        <input type="range" id="intensity" min="1" max="10" value="7" oninput="updateSliderValue('intensity', 'intensityValue')">
                    </div>
                    
                    <div class="control-group">
                        <label>⏱️ Clip Duration (seconds)</label>
                        <input type="number" id="duration" min="5" max="60" value="15">
                    </div>
                    
                    <div class="control-group">
                        <label>🎯 Beat Sensitivity: <span id="sensitivityValue">6</span></label>
                        <input type="range" id="sensitivity" min="1" max="10" value="6" oninput="updateSliderValue('sensitivity', 'sensitivityValue')">
                    </div>
                </div>

                <div class="button-row">
                    <button class="next-step-btn" style="flex: 1; background: linear-gradient(45deg, #95a5a6, #7f8c8d);" onclick="prevStep()">
                        ⬅️ Back
                    </button>
                    <button class="next-step-btn" style="flex: 1;" id="nextStep3" onclick="nextStep()">
                        ➡️ Next
                    </button>
                </div>
            </div>

            <!-- Step 4: Generate -->
            <div class="step-content" id="content4">
                <h3 class="section-title">🚀 Generate Clip</h3>
                
                <div class="selection-instructions">
                    <strong>✨ Ready to Create:</strong><br>
                    • AI analyzes your music's rhythm<br>
                    • Effects sync automatically to beats<br>
                    • Content switches on beat drops
                </div>

                <button class="generate-btn" id="generateBtn" onclick="generateClip()">
                    🎬 Generate Beat-Synced Clip
                </button>

                <div class="export-section" id="exportSection" style="display: none;">
                    <h4 style="margin-bottom: 15px;">📤 Export Your Creation</h4>
                    
                    <div class="export-options">
                        <div class="export-format-tabs">
                            <div class="format-tab active" data-format="mp4" onclick="selectExportFormat('mp4')">MP4</div>
                            <div class="format-tab" data-format="gif" onclick="selectExportFormat('gif')">GIF</div>
                            <div class="format-tab" data-format="webm" onclick="selectExportFormat('webm')">WebM</div>
                        </div>
                        
                        <div class="quality-selector">
                            <label>Quality: <span id="qualityLabel">1080p</span></label>
                            <select id="exportQuality" onchange="updateQualityLabel()">
                                <option value="720p">720p HD</option>
                                <option value="1080p" selected>1080p Full HD</option>
                                <option value="4k">4K Ultra HD</option>
                            </select>
                        </div>
                    </div>
                    
                    <button class="export-btn" id="exportBtn" onclick="exportVideo()">
                        💾 Export Video
                    </button>
                    
                    <div class="share-buttons">
                        <button class="share-btn instagram" onclick="shareToSocial('instagram')">
                            📸 Instagram
                        </button>
                        <button class="share-btn tiktok" onclick="shareToSocial('tiktok')">
                            🎵 TikTok
                        </button>
                        <button class="share-btn youtube" onclick="shareToSocial('youtube')">
                            ▶️ YouTube
                        </button>
                    </div>
                </div>

                <button class="next-step-btn" style="background: linear-gradient(45deg, #95a5a6, #7f8c8d); margin-top: 15px;" onclick="prevStep()">
                    ⬅️ Back to Effects
                </button>
            </div>

            <!-- Preview Section -->
            <div class="preview-section">
                <h3 style="margin-bottom: 15px; font-size: 1.2rem;">👀 Live Preview</h3>
                <div class="preview-container">
                    <div class="preview-content" id="previewContent">
                        🎵 Your beat-synced clip will appear here...<br><br>Complete steps above to start!
                    </div>
                    <div class="effect-overlay" id="effectOverlay"></div>
                    <div class="beat-indicator" id="beatIndicator">♪</div>
                    <div class="audio-visualizer" id="audioVisualizer"></div>
                </div>
                <div class="status" id="status">🎵 Welcome! Follow the steps to create your masterpiece!</div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div class="modal-overlay" id="settingsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>⚙️ Settings</h2>
                <button class="close-btn" onclick="closeSettings()">×</button>
            </div>
            <div class="modal-body">
                <!-- Audio Settings -->
                <div class="settings-section">
                    <h3>🔊 Audio Settings</h3>
                    <div class="settings-grid">
                        <div class="setting-item">
                            <label>Master Volume: <span id="masterVolumeValue">80</span>%</label>
                            <input type="range" id="masterVolume" min="0" max="100" value="80" oninput="updateSettingValue('masterVolume', 'masterVolumeValue')">
                        </div>
                        <div class="setting-item">
                            <label>Preview Volume: <span id="previewVolumeValue">70</span>%</label>
                            <input type="range" id="previewVolume" min="0" max="100" value="70" oninput="updateSettingValue('previewVolume', 'previewVolumeValue')">
                        </div>
                        <div class="setting-item">
                            <label>Audio Quality</label>
                            <select id="audioQuality">
                                <option value="standard">Standard (128kbps)</option>
                                <option value="high" selected>High (256kbps)</option>
                                <option value="premium">Premium (320kbps)</option>
                            </select>
                        </div>
                        <div class="setting-item setting-toggle">
                            <label>Auto-Play Previews</label>
                            <div class="toggle-switch active" id="autoPlayToggle" onclick="toggleSetting('autoPlayToggle')"></div>
                        </div>
                    </div>
                </div>

                <!-- Visual Settings -->
                <div class="settings-section">
                    <h3>🎨 Visual Settings</h3>
                    <div class="settings-grid">
                        <div class="setting-item">
                            <label>Default Video Quality</label>
                            <select id="videoQuality">
                                <option value="720p">720p (HD)</option>
                                <option value="1080p" selected>1080p (Full HD)</option>
                                <option value="4k">4K (Ultra HD)</option>
                            </select>
                        </div>
                        <div class="setting-item">
                            <label>Frame Rate</label>
                            <select id="frameRate">
                                <option value="24">24 FPS (Cinema)</option>
                                <option value="30" selected>30 FPS (Standard)</option>
                                <option value="60">60 FPS (Smooth)</option>
                            </select>
                        </div>
                        <div class="setting-item setting-toggle">
                            <label>Hardware Acceleration</label>
                            <div class="toggle-switch active" id="hwAccelToggle" onclick="toggleSetting('hwAccelToggle')"></div>
                        </div>
                    </div>
                </div>

                <!-- App Settings -->
                <div class="settings-section">
                    <h3>🎨 Appearance & Themes</h3>
                    <div class="settings-grid">
                        <div class="setting-item">
                            <label>App Theme</label>
                            <select id="appTheme" onchange="changeTheme()">
                                <option value="dark">🌙 Dark Mode</option>
                                <option value="light">☀️ Light Mode</option>
                                <option value="auto">🔄 Auto (System)</option>
                            </select>
                        </div>
                        <div class="setting-item">
                            <label>Color Scheme</label>
                            <select id="colorScheme" onchange="changeColorScheme()">
                                <option value="default">🌈 Default Gradient</option>
                                <option value="ocean">🌊 Ocean Blue</option>
                                <option value="sunset">🌅 Sunset Orange</option>
                                <option value="forest">🌲 Forest Green</option>
                                <option value="cyber">🤖 Cyber Neon</option>
                                <option value="aurora">✨ Aurora Purple</option>
                                <option value="fire">🔥 Fire Red</option>
                            </select>
                        </div>
                        <div class="setting-item setting-toggle">
                            <label>Haptic Feedback</label>
                            <div class="toggle-switch active" id="hapticToggle" onclick="toggleSetting('hapticToggle')"></div>
                        </div>
                    </div>
                </div>

                <!-- AI Settings -->
                <div class="settings-section">
                    <h3>🤖 AI Effects</h3>
                    <div class="settings-grid">
                        <div class="setting-item setting-toggle">
                            <label>AI Music Analysis</label>
                            <div class="toggle-switch active" id="aiAnalysisToggle" onclick="toggleSetting('aiAnalysisToggle')"></div>
                        </div>
                        <div class="setting-item">
                            <label>AI Sensitivity: <span id="aiSensitivityValue">75</span>%</label>
                            <input type="range" id="aiSensitivity" min="10" max="100" value="75" oninput="updateSettingValue('aiSensitivity', 'aiSensitivityValue')">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Subscription Modal -->
    <div class="modal-overlay" id="subscriptionModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>⭐ Upgrade Your Experience</h2>
                <button class="close-btn" onclick="closeSubscription()">×</button>
            </div>
            <div class="modal-body">
                <div class="subscription-plans">
                    <!-- Free Plan -->
                    <div class="plan-card current">
                        <div class="plan-header">
                            <div class="plan-name">Free</div>
                            <div class="plan-price">$0</div>
                            <div class="plan-period">forever</div>
                        </div>
                        <ul class="plan-features">
                            <li>5 free music tracks</li>
                            <li>Basic beat detection</li>
                            <li>720p export quality</li>
                            <li>Standard effects library</li>
                            <li>15-second clips max</li>
                        </ul>
                        <button class="plan-btn current">Current Plan</button>
                    </div>

                    <!-- Premium Plan -->
                    <div class="plan-card recommended">
                        <div class="plan-header">
                            <div class="plan-name">Premium</div>
                            <div class="plan-price">$4.99</div>
                            <div class="plan-period">per month</div>
                        </div>
                        <ul class="plan-features">
                            <li>50+ premium music tracks</li>
                            <li>Advanced AI beat detection</li>
                            <li>1080p export quality</li>
                            <li>Premium effects & filters</li>
                            <li>60-second clips</li>
                            <li>No watermarks</li>
                            <li>Cloud storage (5GB)</li>
                        </ul>
                        <button class="plan-btn upgrade" onclick="subscribeToPlan('premium')">
                            Upgrade to Premium
                        </button>
                    </div>

                    <!-- Pro Plan -->
                    <div class="plan-card">
                        <div class="plan-header">
                            <div class="plan-name">Pro</div>
                            <div class="plan-price">$9.99</div>
                            <div class="plan-period">per month</div>
                        </div>
                        <ul class="plan-features">
                            <li>200+ exclusive tracks</li>
                            <li>AI-powered music creation</li>
                            <li>4K export quality</li>
                            <li>Professional effects suite</li>
                            <li>Unlimited clip length</li>
                            <li>Commercial license</li>
                            <li>Cloud storage (50GB)</li>
                            <li>Priority support</li>
                            <li>Custom branding</li>
                        </ul>
                        <button class="plan-btn premium" onclick="subscribeToPlan('pro')">
                            Go Pro
                        </button>
                    </div>
                </div>

                <div style="text-align: center; margin-top: 20px; font-size: 0.8rem; opacity: 0.8;">
                    ✨ Cancel anytime • 7-day free trial • Secure payment
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global state
        let currentStep = 1;
        let selectedMusic = null;
        let currentAudio = null;
        let currentMedia = [];
        let isPlaying = false;
        let audioContext, analyser, audioSource, beatDetector, effectsEngine;
        let currentTier = 'free';
        let currentMusicTier = 'free';
        let userSubscription = 'free';
        let currentGeneratedClip = null;
        let exportFormat = 'mp4';
        let userInteracted = false;

        // Enhanced Audio Preview Manager with working synthetic audio
        class AudioPreviewManager {
            constructor() {
                this.currentAudio = null;
                this.previewCache = new Map();
                this.synthContext = null;
            }

            async initSynthContext() {
                if (!this.synthContext) {
                    this.synthContext = new (window.AudioContext || window.webkitAudioContext)();
                }
                return this.synthContext;
            }

            async generateSyntheticPreview(track) {
                const cacheKey = `${track.id}_${track.bpm}_${track.genre}`;
                if (this.previewCache.has(cacheKey)) {
                    return this.previewCache.get(cacheKey);
                }

                await this.initSynthContext();
                const duration = 15;
                const sampleRate = this.synthContext.sampleRate;
                
                const buffer = this.synthContext.createBuffer(2, sampleRate * duration, sampleRate);
                const leftChannel = buffer.getChannelData(0);
                const rightChannel = buffer.getChannelData(1);
                
                this.generateMusicPattern(leftChannel, rightChannel, track, sampleRate);
                
                const audioBlob = await this.bufferToBlob(buffer);
                const audioUrl = URL.createObjectURL(audioBlob);
                
                this.previewCache.set(cacheKey, audioUrl);
                return audioUrl;
            }

            generateMusicPattern(leftChannel, rightChannel, track, sampleRate) {
                const beatsPerSecond = track.bpm / 60;
                const samplesPerBeat = sampleRate / beatsPerSecond;
                
                for (let i = 0; i < leftChannel.length; i++) {
                    const time = i / sampleRate;
                    const beatPhase = (i % samplesPerBeat) / samplesPerBeat;
                    
                    let sample = 0;
                    
                    switch (track.genre) {
                        case 'electronic':
                        case 'edm':
                            sample = this.generateEDMPattern(time, beatPhase, track.bpm);
                            break;
                        case 'dubstep':
                        case 'trap':
                            sample = this.generateDubstepPattern(time, beatPhase, track.bpm);
                            break;
                        case 'house':
                        case 'techno':
                            sample = this.generateHousePattern(time, beatPhase, track.bpm);
                            break;
                        case 'chill':
                        case 'ambient':
                            sample = this.generateChillPattern(time, beatPhase, track.bpm);
                            break;
                        default:
                            sample = this.generateGenericPattern(time, beatPhase, track.bpm);
                    }
                    
                    leftChannel[i] = sample;
                    rightChannel[i] = sample;
                }
            }

            generateEDMPattern(time, beatPhase, bpm) {
                let sample = 0;
                
                if (beatPhase < 0.1) {
                    sample += Math.sin(2 * Math.PI * 60 * time) * Math.exp(-beatPhase * 30) * 0.8;
                }
                
                if (beatPhase > 0.45 && beatPhase < 0.55) {
                    sample += (Math.random() - 0.5) * 0.3 * Math.exp(-(beatPhase - 0.5) * 50);
                }
                
                const freq = 440 + Math.sin(time * 0.5) * 110;
                sample += Math.sin(2 * Math.PI * freq * time) * 0.3 * (0.5 + 0.5 * Math.sin(time * 2));
                
                const bassFreq = 55 + Math.sin(time * 0.25) * 20;
                sample += Math.sin(2 * Math.PI * bassFreq * time) * 0.4;
                
                return Math.max(-1, Math.min(1, sample));
            }

            generateDubstepPattern(time, beatPhase, bpm) {
                let sample = 0;
                
                if (beatPhase < 0.15) {
                    sample += Math.sin(2 * Math.PI * 45 * time) * Math.exp(-beatPhase * 20) * 1.0;
                }
                
                const wobbleFreq = 80 + 40 * Math.sin(time * 8);
                sample += Math.sin(2 * Math.PI * wobbleFreq * time) * 0.6;
                
                if (Math.floor(beatPhase * 4) === 2 && (beatPhase * 4) % 1 < 0.1) {
                    sample += (Math.random() - 0.5) * 0.8;
                }
                
                if (Math.floor(time * 2) % 8 === 7) {
                    sample += Math.sin(2 * Math.PI * 200 * Math.pow(1 - (beatPhase), 2) * time) * 0.5;
                }
                
                return Math.max(-1, Math.min(1, sample));
            }

            generateHousePattern(time, beatPhase, bpm) {
                let sample = 0;
                
                if (beatPhase < 0.08) {
                    sample += Math.sin(2 * Math.PI * 60 * time) * Math.exp(-beatPhase * 25) * 0.7;
                }
                
                if ((beatPhase > 0.48 && beatPhase < 0.52)) {
                    sample += (Math.random() - 0.5) * 0.25;
                }
                
                if (Math.floor(beatPhase * 16) % 2 === 1 && (beatPhase * 16) % 1 < 0.05) {
                    sample += (Math.random() - 0.5) * 0.15;
                }
                
                const bassNote = Math.floor(time / 2) % 4;
                const bassFreqs = [55, 65, 73, 82];
                sample += Math.sin(2 * Math.PI * bassFreqs[bassNote] * time) * 0.5;
                
                return Math.max(-1, Math.min(1, sample));
            }

            generateChillPattern(time, beatPhase, bpm) {
                let sample = 0;
                
                if (beatPhase < 0.1) {
                    sample += Math.sin(2 * Math.PI * 55 * time) * Math.exp(-beatPhase * 15) * 0.4;
                }
                
                sample += Math.sin(2 * Math.PI * 220 * time) * 0.2 * (0.5 + 0.5 * Math.sin(time * 0.1));
                sample += Math.sin(2 * Math.PI * 330 * time) * 0.15 * (0.5 + 0.5 * Math.sin(time * 0.07));
                
                if (beatPhase > 0.7 && beatPhase < 0.75) {
                    sample += (Math.random() - 0.5) * 0.1;
                }
                
                return Math.max(-1, Math.min(1, sample));
            }

            generateGenericPattern(time, beatPhase, bpm) {
                let sample = 0;
                
                if (beatPhase < 0.1) {
                    sample += Math.sin(2 * Math.PI * 60 * time) * Math.exp(-beatPhase * 20) * 0.6;
                }
                if (Math.floor(beatPhase * 4) === 2 && (beatPhase * 4) % 1 < 0.05) {
                    sample += (Math.random() - 0.5) * 0.5;
                }
                
                const melody = [440, 523, 659, 523];
                const noteIndex = Math.floor(time * 2) % melody.length;
                sample += Math.sin(2 * Math.PI * melody[noteIndex] * time) * 0.3;
                
                return Math.max(-1, Math.min(1, sample));
            }

            async bufferToBlob(buffer) {
                const length = buffer.length;
                const arrayBuffer = new ArrayBuffer(44 + length * 4);
                const view = new DataView(arrayBuffer);
                
                const writeString = (offset, string) => {
                    for (let i = 0; i < string.length; i++) {
                        view.setUint8(offset + i, string.charCodeAt(i));
                    }
                };
                
                writeString(0, 'RIFF');
                view.setUint32(4, 36 + length * 4, true);
                writeString(8, 'WAVE');
                writeString(12, 'fmt ');
                view.setUint32(16, 16, true);
                view.setUint16(20, 1, true);
                view.setUint16(22, 2, true);
                view.setUint32(24, buffer.sampleRate, true);
                view.setUint32(28, buffer.sampleRate * 4, true);
                view.setUint16(32, 4, true);
                view.setUint16(34, 16, true);
                writeString(36, 'data');
                view.setUint32(40, length * 4, true);
                
                const leftChannel = buffer.getChannelData(0);
                const rightChannel = buffer.getChannelData(1);
                let offset = 44;
                
                for (let i = 0; i < length; i++) {
                    const leftSample = Math.max(-1, Math.min(1, leftChannel[i]));
                    const rightSample = Math.max(-1, Math.min(1, rightChannel[i]));
                    view.setInt16(offset, leftSample * 0x7FFF, true);
                    view.setInt16(offset + 2, rightSample * 0x7FFF, true);
                    offset += 4;
                }
                
                return new Blob([arrayBuffer], { type: 'audio/wav' });
            }

            async togglePreview(track, button, trackId) {
                if (this.currentAudio && !this.currentAudio.paused) {
                    this.currentAudio.pause();
                    this.currentAudio.currentTime = 0;
                    this.resetPlayButtons();
                }

                if (this.currentAudio && this.currentAudio.src.includes(trackId) && button.innerHTML === '▶') {
                    return;
                }

                try {
                    const previewUrl = await this.generateSyntheticPreview(track);
                    
                    this.currentAudio = new Audio(previewUrl);
                    const previewVolume = document.getElementById('previewVolume')?.value / 100 || 0.7;
                    this.currentAudio.volume = previewVolume;
                    
                    button.innerHTML = '⏸';
                    button.classList.add('playing');
                    button.closest('.music-card, .apple-track-card, .spotify-track-card')?.classList.add('playing');
                    
                    this.setupAudioEvents(this.currentAudio, button, trackId);
                    await this.currentAudio.play();
                    
                } catch (error) {
                    console.warn('Could not play preview:', error);
                    this.updateStatus('⚠️ Preview not available');
                    this.resetButton(button);
                }
            }

            setupAudioEvents(audio, button, trackId) {
                audio.ontimeupdate = () => {
                    const progress = (audio.currentTime / audio.duration) * 100;
                    const progressBar = document.getElementById(`progress-${trackId}`);
                    const timeDisplay = document.getElementById(`time-${trackId}`);
                    
                    if (progressBar) progressBar.style.width = progress + '%';
                    if (timeDisplay) {
                        const minutes = Math.floor(audio.currentTime / 60);
                        const seconds = Math.floor(audio.currentTime % 60);
                        timeDisplay.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
                    }
                };
                
                audio.onended = () => {
                    this.resetButton(button);
                    this.resetProgress(trackId);
                };
            }

            resetButton(button) {
                button.innerHTML = '▶';
                button.classList.remove('playing');
                button.closest('.music-card, .apple-track-card, .spotify-track-card')?.classList.remove('playing');
            }

            resetProgress(trackId) {
                const progressBar = document.getElementById(`progress-${trackId}`);
                const timeDisplay = document.getElementById(`time-${trackId}`);
                if (progressBar) progressBar.style.width = '0%';
                if (timeDisplay) timeDisplay.textContent = '0:00';
            }

            resetPlayButtons() {
                document.querySelectorAll('.play-btn, .mini-play-btn').forEach(btn => {
                    btn.innerHTML = '▶';
                    btn.classList.remove('playing');
                });
                document.querySelectorAll('.music-card, .apple-track-card, .spotify-track-card').forEach(card => {
                    card.classList.remove('playing');
                });
            }

            updateStatus(message) {
                const statusEl = document.getElementById('status');
                if (statusEl) statusEl.innerHTML = message;
            }
        }

        // Music database with working previews
        const freeMusicDatabase = [
            {
                id: 1,
                title: "Electric Dreams",
                artist: "SynthWave Pro",
                genre: "electronic",
                bpm: 128,
                duration: "3:45",
                tier: "free",
                tags: ["edm", "electronic", "dance"]
            },
            {
                id: 2,
                title: "Bass Revolution",
                artist: "EDM Master",
                genre: "dubstep",
                bpm: 140,
                duration: "4:12",
                tier: "free",
                tags: ["dubstep", "bass", "electronic"]
            },
            {
                id: 3,
                title: "House Vibes",
                artist: "Deep House",
                genre: "house",
                bpm: 124,
                duration: "5:30",
                tier: "free",
                tags: ["house", "dance", "party"]
            },
            {
                id: 4,
                title: "Techno Beat",
                artist: "Cyber Beats",
                genre: "techno",
                bpm: 132,
                duration: "6:15",
                tier: "free",
                tags: ["techno", "underground"]
            },
            {
                id: 5,
                title: "Trap Energy",
                artist: "Urban Sound",
                genre: "trap",
                bpm: 150,
                duration: "3:20",
                tier: "free",
                tags: ["trap", "hip-hop", "urban"]
            },
            {
                id: 6,
                title: "Neon Nights",
                artist: "Future Bass Collective",
                genre: "future-bass",
                bpm: 140,
                duration: "4:30",
                tier: "premium",
                tags: ["future-bass", "melodic", "emotional"]
            },
            {
                id: 7,
                title: "Cyber Punk 2099",
                artist: "Digital Dreams",
                genre: "electronic",
                bpm: 135,
                duration: "5:15",
                tier: "premium",
                tags: ["cyberpunk", "dark", "futuristic"]
            },
            {
                id: 8,
                title: "Liquid Drum & Bass",
                artist: "Smooth Operators",
                genre: "drum-bass",
                bpm: 174,
                duration: "6:45",
                tier: "premium",
                tags: ["drum-bass", "liquid", "smooth"]
            },
            {
                id: 9,
                title: "Festival Anthem",
                artist: "Mainstage Heroes",
                genre: "edm",
                bpm: 128,
                duration: "4:00",
                tier: "premium",
                tags: ["festival", "big-room", "anthem"]
            },
            {
                id: 10,
                title: "Minimal Techno Journey",
                artist: "Underground Labs",
                genre: "techno",
                bpm: 126,
                duration: "7:30",
                tier: "premium",
                tags: ["minimal", "hypnotic", "deep"]
            },
            {
                id: 11,
                title: "Epic Orchestral Bass",
                artist: "Cinematic Sound",
                genre: "electronic",
                bpm: 110,
                duration: "5:45",
                tier: "pro",
                tags: ["cinematic", "orchestral", "epic"]
            },
            {
                id: 12,
                title: "Hybrid Trap Beast",
                artist: "Bass Monsters",
                genre: "trap",
                bpm: 150,
                duration: "4:20",
                tier: "pro",
                tags: ["hybrid", "aggressive", "festival"]
            },
            {
                id: 13,
                title: "Ambient Dreamscape",
                artist: "Ethereal Sounds",
                genre: "chill",
                bpm: 90,
                duration: "8:00",
                tier: "pro",
                tags: ["ambient", "dreamy", "meditation"]
            },
            {
                id: 14,
                title: "Neurofunk Destroyer",
                artist: "Matrix Breaks",
                genre: "drum-bass",
                bpm: 180,
                duration: "5:30",
                tier: "pro",
                tags: ["neurofunk", "dark", "technical"]
            },
            {
                id: 15,
                title: "Progressive House Journey",
                artist: "Melodic Progressions",
                genre: "house",
                bpm: 124,
                duration: "9:15",
                tier: "pro",
                tags: ["progressive", "melodic", "journey"]
            }
        ];

        // Sample Apple Music and Spotify libraries
        const sampleAppleLibrary = [
            {
                id: 'apple_1',
                title: "Levels",
                artist: "Avicii",
                album: "True",
                duration: "3:18",
                artwork: "🎧",
                genre: "electronic",
                bpm: 126
            },
            {
                id: 'apple_2',
                title: "Titanium",
                artist: "David Guetta ft. Sia",
                album: "Nothing But The Beat",
                duration: "4:05",
                artwork: "🎵",
                genre: "edm",
                bpm: 126
            },
            {
                id: 'apple_3',
                title: "Animals",
                artist: "Martin Garrix",
                album: "Animals",
                duration: "5:00",
                artwork: "🦁",
                genre: "big-room",
                bpm: 128
            },
            {
                id: 'apple_4',
                title: "Midnight City",
                artist: "M83",
                album: "Hurry Up, We're Dreaming",
                duration: "4:03",
                artwork: "🌃",
                genre: "electronic",
                bpm: 105
            },
            {
                id: 'apple_5',
                title: "Strobe",
                artist: "Deadmau5",
                album: "For Lack of a Better Name",
                duration: "10:32",
                artwork: "💡",
                genre: "progressive-house",
                bpm: 128
            }
        ];

        const sampleSpotifyLibrary = [
            {
                id: 'spotify_1',
                title: "Blinding Lights",
                artist: "The Weeknd",
                album: "After Hours",
                duration: "3:20",
                artwork: "✨",
                genre: "pop",
                bpm: 171
            },
            {
                id: 'spotify_2',
                title: "Watermelon Sugar",
                artist: "Harry Styles",
                album: "Fine Line",
                duration: "2:54",
                artwork: "🍉",
                genre: "pop",
                bpm: 95
            },
            {
                id: 'spotify_3',
                title: "Roses",
                artist: "SAINt JHN (Imanbek Remix)",
                album: "Roses (Imanbek Remix)",
                duration: "2:38",
                artwork: "🌹",
                genre: "house",
                bpm: 110
            },
            {
                id: 'spotify_4',
                title: "Good 4 U",
                artist: "Olivia Rodrigo",
                album: "SOUR",
                duration: "2:58",
                artwork: "💜",
                genre: "pop-rock",
                bpm: 166
            },
            {
                id: 'spotify_5',
                title: "Stay",
                artist: "The Kid LAROI & Justin Bieber",
                album: "Stay",
                duration: "2:21",
                artwork: "🎤",
                genre: "pop",
                bpm: 169
            }
        ];

        // Apple Music and Spotify integration objects
        let appleMusic = {
            connected: false,
            library: [],
            playlists: [],
            currentTab: 'library'
        };

        let spotify = {
            connected: false,
            library: [],
            playlists: [],
            accessToken: null,
            currentTab: 'playlists'
        };

        // AI Effects Engine
        class AIEffectsEngine {
            constructor() {
                this.musicAnalysis = {
                    genre: null,
                    bpm: null,
                    energy: 0,
                    mood: null,
                    instruments: [],
                    structure: []
                };
                this.effectQueue = [];
                this.transitionTypes = ['swap', 'flip', 'slide', 'fade', 'zoom', 'spin', 'glitch', 'warp'];
                this.currentEffect = null;
                this.lastEffectTime = 0;
            }

            analyzeMusic(track) {
                this.musicAnalysis.genre = track.genre || 'unknown';
                this.musicAnalysis.bpm = track.bpm || 120;
                
                if (track.genre === 'dubstep' || track.genre === 'trap') {
                    this.musicAnalysis.energy = 0.9;
                    this.musicAnalysis.mood = 'aggressive';
                } else if (track.genre === 'chill' || track.genre === 'ambient') {
                    this.musicAnalysis.energy = 0.3;
                    this.musicAnalysis.mood = 'calm';
                } else if (track.genre === 'electronic' || track.genre === 'edm') {
                    this.musicAnalysis.energy = 0.8;
                    this.musicAnalysis.mood = 'energetic';
                } else {
                    this.musicAnalysis.energy = 0.6;
                    this.musicAnalysis.mood = 'balanced';
                }

                this.generateEffectSuggestions();
                return this.musicAnalysis;
            }

            generateEffectSuggestions() {
                const { genre, energy, mood, bpm } = this.musicAnalysis;
                this.effectQueue = [];

                switch (genre) {
                    case 'dubstep':
                    case 'trap':
                        this.effectQueue.push(
                            { type: 'glitch', intensity: 0.9, timing: 'drop' },
                            { type: 'warp', intensity: 0.8, timing: 'buildup' },
                            { type: 'zoom', intensity: 1.0, timing: 'drop' }
                        );
                        break;
                    
                    case 'house':
                    case 'techno':
                        this.effectQueue.push(
                            { type: 'spin', intensity: 0.7, timing: 'beat' },
                            { type: 'slide', intensity: 0.6, timing: 'phrase' },
                            { type: 'fade', intensity: 0.5, timing: 'transition' }
                        );
                        break;
                    
                    case 'chill':
                    case 'ambient':
                        this.effectQueue.push(
                            { type: 'fade', intensity: 0.4, timing: 'slow' },
                            { type: 'zoom', intensity: 0.3, timing: 'ambient' }
                        );
                        break;
                    
                    default:
                        this.effectQueue.push(
                            { type: 'swap', intensity: 0.6, timing: 'beat' },
                            { type: 'flip', intensity: 0.5, timing: 'phrase' }
                        );
                }

                if (bpm > 140) {
                    this.effectQueue.forEach(effect => {
                        effect.frequency = 'high';
                        effect.duration = 'short';
                    });
                } else if (bpm < 100) {
                    this.effectQueue.forEach(effect => {
                        effect.frequency = 'low';
                        effect.duration = 'long';
                    });
                }
            }

            suggestEffect(beatData) {
                const aiAnalysisEnabled = document.getElementById('aiAnalysisToggle')?.classList.contains('active') ?? true;
                if (!aiAnalysisEnabled) return null;

                const now = performance.now();
                const timeSinceLastEffect = now - this.lastEffectTime;
                const minInterval = this.getMinInterval();

                if (timeSinceLastEffect < minInterval) return null;

                let suggestedEffect = null;

                if (beatData.detected && beatData.energy > 0.7) {
                    if (this.musicAnalysis.mood === 'aggressive') {
                        suggestedEffect = this.selectEffect(['glitch', 'warp', 'zoom'], beatData.energy);
                    } else if (this.musicAnalysis.mood === 'energetic') {
                        suggestedEffect = this.selectEffect(['spin', 'flip', 'zoom'], beatData.energy);
                    } else {
                        suggestedEffect = this.selectEffect(['fade', 'slide', 'swap'], beatData.energy);
                    }
                } else if (beatData.bass > 0.8) {
                    suggestedEffect = this.selectEffect(['warp', 'zoom', 'glitch'], beatData.bass);
                } else if (beatData.high > 0.7) {
                    suggestedEffect = this.selectEffect(['spin', 'flip', 'fade'], beatData.high);
                }

                if (suggestedEffect) {
                    this.lastEffectTime = now;
                    this.currentEffect = suggestedEffect;
                }

                return suggestedEffect;
            }

            selectEffect(availableEffects, intensity) {
                const selectedType = availableEffects[Math.floor(Math.random() * availableEffects.length)];
                return {
                    type: selectedType,
                    intensity: intensity,
                    duration: this.calculateDuration(intensity),
                    direction: this.getRandomDirection(),
                    easing: this.getEasing(selectedType)
                };
            }

            getMinInterval() {
                const sensitivity = document.getElementById('aiSensitivity')?.value || 75;
                return Math.max(200, 2000 - (sensitivity * 20));
            }

            calculateDuration(intensity) {
                return Math.max(300, 1000 * intensity);
            }

            getRandomDirection() {
                const directions = ['left', 'right', 'up', 'down', 'center'];
                return directions[Math.floor(Math.random() * directions.length)];
            }

            getEasing(effectType) {
                const easings = {
                    glitch: 'cubic-bezier(0.68, -0.55, 0.265, 1.55)',
                    warp: 'cubic-bezier(0.25, 0.46, 0.45, 0.94)',
                    zoom: 'cubic-bezier(0.175, 0.885, 0.32, 1.275)',
                    spin: 'cubic-bezier(0.645, 0.045, 0.355, 1)',
                    fade: 'ease-in-out',
                    slide: 'cubic-bezier(0.25, 0.46, 0.45, 0.94)',
                    flip: 'cubic-bezier(0.175, 0.885, 0.32, 1.275)',
                    swap: 'ease-out'
                };
                return easings[effectType] || 'ease-in-out';
            }
        }

        // Beat Detection Engine
        class BeatDetector {
            constructor(audioContext, analyser) {
                this.audioContext = audioContext;
                this.analyser = analyser;
                this.bufferSize = analyser.frequencyBinCount;
                this.dataArray = new Uint8Array(this.bufferSize);
                this.lastBeatTime = 0;
                this.beatThreshold = 0.4;
            }

            detectBeat() {
                this.analyser.getByteFrequencyData(this.dataArray);
                
                const bassEnergy = this.getFrequencyRangeEnergy([0, 8]);
                const midEnergy = this.getFrequencyRangeEnergy([8, 24]);
                const highEnergy = this.getFrequencyRangeEnergy([24, 64]);
                
                const totalEnergy = bassEnergy + midEnergy + highEnergy;
                const normalizedEnergy = totalEnergy / 255;
                
                const now = this.audioContext.currentTime;
                const timeSinceLastBeat = now - this.lastBeatTime;
                
                let beatDetected = false;
                if (normalizedEnergy > this.beatThreshold && timeSinceLastBeat > 0.2) {
                    beatDetected = true;
                    this.lastBeatTime = now;
                    
                    // Trigger haptic feedback
                    if (document.getElementById('hapticToggle')?.classList.contains('active') && 'vibrate' in navigator) {
                        navigator.vibrate(50);
                    }
                }
                
                return {
                    detected: beatDetected,
                    energy: normalizedEnergy,
                    bass: bassEnergy / 255,
                    mid: midEnergy / 255,
                    high: highEnergy / 255
                };
            }

            getFrequencyRangeEnergy(range) {
                let energy = 0;
                for (let i = range[0]; i < Math.min(range[1], this.dataArray.length); i++) {
                    energy += this.dataArray[i];
                }
                return energy / (range[1] - range[0]);
            }
        }

        // Enhanced Effects Engine
        class EffectsEngine {
            constructor() {
                this.previewContent = document.getElementById('previewContent');
                this.effectOverlay = document.getElementById('effectOverlay');
                this.beatIndicator = document.getElementById('beatIndicator');
                this.mediaIndex = 0;
                this.currentTransition = null;
            }

            applyBeatEffect(beatData) {
                if (!beatData.detected) return;

                this.beatIndicator.classList.add('beat-active');
                setTimeout(() => {
                    this.beatIndicator.classList.remove('beat-active');
                }, 300);

                const aiEffect = aiEffectsEngine.suggestEffect(beatData);
                
                if (aiEffect) {
                    this.applyAIEffect(aiEffect, beatData);
                } else {
                    this.applyManualEffects(beatData);
                }

                if (beatData.energy > 0.8 && currentMedia.length > 1) {
                    this.switchMedia(aiEffect);
                }
            }

            applyAIEffect(aiEffect, beatData) {
                const { type, intensity, duration, direction, easing } = aiEffect;
                
                switch (type) {
                    case 'glitch':
                        this.applyGlitchEffect(intensity, duration);
                        break;
                    case 'warp':
                        this.applyWarpEffect(intensity, direction, duration);
                        break;
                    case 'zoom':
                        this.applyZoomEffect(intensity, duration, easing);
                        break;
                    case 'spin':
                        this.applySpinEffect(intensity, direction, duration);
                        break;
                    case 'flip':
                        this.applyFlipEffect(direction, duration, easing);
                        break;
                    case 'slide':
                        this.applySlideEffect(direction, duration, easing);
                        break;
                    case 'fade':
                        this.applyFadeEffect(intensity, duration);
                        break;
                    case 'swap':
                        this.applySwapEffect(duration);
                        break;
                    default:
                        this.applyManualEffects(beatData);
                }
            }

            applyManualEffects(beatData) {
                if (beatData.bass > 0.7) {
                    this.applyZoomEffect(beatData.bass, 600, 'ease-out');
                } else if (beatData.high > 0.6) {
                    this.applyGlitchEffect(beatData.high, 400);
                } else {
                    this.applyFadeEffect(beatData.mid, 400);
                }
            }

            applyGlitchEffect(intensity, duration = 400) {
                this.previewContent.style.filter = `hue-rotate(${intensity * 360}deg) contrast(${1 + intensity})`;
                this.previewContent.style.transform = `translateX(${(Math.random() - 0.5) * intensity * 20}px)`;
                
                setTimeout(() => {
                    this.previewContent.style.filter = '';
                    this.previewContent.style.transform = '';
                }, duration);
            }

            applyWarpEffect(intensity, direction, duration = 600) {
                const scale = 1 + (intensity * 0.3);
                const skew = intensity * 10;
                
                this.previewContent.style.transform = `scale(${scale}) skewX(${skew}deg)`;
                this.previewContent.style.filter = `blur(${intensity * 2}px)`;
                
                setTimeout(() => {
                    this.previewContent.style.transform = '';
                    this.previewContent.style.filter = '';
                }, duration);
            }

            applyZoomEffect(intensity, duration = 600, easing = 'ease-out') {
                const scale = 1 + (intensity * 0.4);
                this.previewContent.style.transition = `transform ${duration}ms ${easing}`;
                this.previewContent.style.transform = `scale(${scale})`;
                
                setTimeout(() => {
                    this.previewContent.style.transform = 'scale(1)';
                    setTimeout(() => {
                        this.previewContent.style.transition = '';
                    }, duration);
                }, 100);
            }

            applySpinEffect(intensity, direction, duration = 800) {
                const rotation = direction === 'left' ? -intensity * 180 : intensity * 180;
                this.previewContent.style.transition = `transform ${duration}ms cubic-bezier(0.25, 0.46, 0.45, 0.94)`;
                this.previewContent.style.transform = `rotate(${rotation}deg) scale(${1 + intensity * 0.2})`;
                
                setTimeout(() => {
                    this.previewContent.style.transform = 'rotate(0deg) scale(1)';
                    setTimeout(() => {
                        this.previewContent.style.transition = '';
                    }, duration);
                }, 100);
            }

            applyFlipEffect(direction, duration = 600, easing = 'ease-in-out') {
                const axis = direction === 'up' || direction === 'down' ? 'X' : 'Y';
                const angle = direction === 'left' || direction === 'up' ? -180 : 180;
                
                this.previewContent.style.transition = `transform ${duration}ms ${easing}`;
                this.previewContent.style.transform = `rotate${axis}(${angle}deg)`;
                
                setTimeout(() => {
                    this.previewContent.style.transform = `rotate${axis}(0deg)`;
                    setTimeout(() => {
                        this.previewContent.style.transition = '';
                    }, duration);
                }, duration / 2);
            }

            applySlideEffect(direction, duration = 500, easing = 'ease-out') {
                const transforms = {
                    left: 'translateX(-100%)',
                    right: 'translateX(100%)',
                    up: 'translateY(-100%)',
                    down: 'translateY(100%)',
                    center: 'scale(0.8)'
                };
                
                const transform = transforms[direction] || transforms.center;
                this.previewContent.style.transition = `transform ${duration}ms ${easing}`;
                this.previewContent.style.transform = transform;
                
                setTimeout(() => {
                    this.previewContent.style.transform = 'translateX(0) translateY(0) scale(1)';
                    setTimeout(() => {
                        this.previewContent.style.transition = '';
                    }, duration);
                }, 100);
            }

            applyFadeEffect(intensity, duration = 500) {
                this.previewContent.style.transition = `opacity ${duration}ms ease-in-out`;
                this.previewContent.style.opacity = 1 - (intensity * 0.7);
                
                setTimeout(() => {
                    this.previewContent.style.opacity = 1;
                    setTimeout(() => {
                        this.previewContent.style.transition = '';
                    }, duration);
                }, duration / 2);
            }

            applySwapEffect(duration = 300) {
                if (currentMedia.length > 1) {
                    this.previewContent.style.transition = `transform ${duration}ms ease-out`;
                    this.previewContent.style.transform = 'scale(0.1) rotate(180deg)';
                    
                    setTimeout(() => {
                        this.switchMedia();
                        this.previewContent.style.transform = 'scale(1) rotate(0deg)';
                        setTimeout(() => {
                            this.previewContent.style.transition = '';
                        }, duration);
                    }, duration / 2);
                }
            }

            switchMedia(aiEffect = null) {
                if (currentMedia.length === 0) return;
                
                this.mediaIndex = (this.mediaIndex + 1) % currentMedia.length;
                const file = currentMedia[this.mediaIndex];
                
                if (file.type.startsWith('image/')) {
                    const img = document.createElement('img');
                    img.src = URL.createObjectURL(file);
                    img.className = 'preview-media';
                    
                    if (aiEffect && aiEffect.imageFilter) {
                        img.style.filter = aiEffect.imageFilter;
                    }
                    
                    this.previewContent.innerHTML = '';
                    this.previewContent.appendChild(img);
                } else if (file.type.startsWith('video/')) {
                    const video = document.createElement('video');
                    video.src = URL.createObjectURL(file);
                    video.className = 'preview-media';
                    video.muted = true;
                    video.loop = true;
                    video.autoplay = true;
                    video.playsInline = true;
                    
                    this.previewContent.innerHTML = '';
                    this.previewContent.appendChild(video);
                }
            }
        }

        // Initialize components
        const audioPreviewManager = new AudioPreviewManager();
        let aiEffectsEngine = new AIEffectsEngine();

        // App settings
        let appSettings = {
            theme: 'dark',
            colorScheme: 'default',
            illuminated: true,
            translucent: true,
            opacity: 90,
            glowIntensity: 70,
            autoCompress: true,
            imageQuality: 80,
            maxImageSize: 1280,
            aiEffects: true,
            autoEffectMode: 'smart'
        };

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            initAudioVisualizer();
            loadMusicLibrary();
            setupEventListeners();
            updateStepAvailability();
            updateSubscriptionDisplay();
            initAudioContext();
            initializeTheme();
            
            // Prevent zoom on double tap
            let lastTouchEnd = 0;
            document.addEventListener('touchend', function (event) {
                const now = (new Date()).getTime();
                if (now - lastTouchEnd <= 300) {
                    event.preventDefault();
                }
                lastTouchEnd = now;
            }, false);
            
            // Enable audio on first user interaction
            document.addEventListener('touchstart', enableAudioContext, { once: true });
            document.addEventListener('click', enableAudioContext, { once: true });
        });

        function initializeTheme() {
            const savedTheme = localStorage.getItem('app-theme') || 'auto';
            const savedColorScheme = localStorage.getItem('app-color-scheme') || 'default';
            
            document.getElementById('appTheme').value = savedTheme;
            document.getElementById('colorScheme').value = savedColorScheme;
            
            applyTheme(savedTheme);
            applyColorScheme(savedColorScheme);
            
            window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e) => {
                if (appSettings.theme === 'auto') {
                    applyTheme('auto');
                }
            });
        }

        function initAudioContext() {
            try {
                window.AudioContext = window.AudioContext || window.webkitAudioContext;
                updateStatus('🔊 Audio system ready - tap to begin!');
            } catch (error) {
                console.warn('Audio context creation failed:', error);
                updateStatus('⚠️ Audio unavailable, but visuals will work!');
            }
        }

        function enableAudioContext() {
            userInteracted = true;
            updateStatus('🔊 Audio enabled - you can now play previews!');
        }

        function setupEventListeners() {
            document.getElementById('audioFile').addEventListener('change', handleAudioUpload);
            document.getElementById('mediaFile').addEventListener('change', handleMediaUpload);
            document.getElementById('musicSearch').addEventListener('input', debounce(searchMusic, 300));
            document.getElementById('genreFilter').addEventListener('change', searchMusic);
        }

        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Settings functions
        function openSettings() {
            document.getElementById('settingsModal').classList.add('active');
        }

        function closeSettings() {
            document.getElementById('settingsModal').classList.remove('active');
        }

        function openSubscription() {
            document.getElementById('subscriptionModal').classList.add('active');
        }

        function closeSubscription() {
            document.getElementById('subscriptionModal').classList.remove('active');
        }

        function updateSettingValue(sliderId, displayId) {
            const value = document.getElementById(sliderId).value;
            document.getElementById(displayId).textContent = value;
        }

        function toggleSetting(toggleId) {
            const toggle = document.getElementById(toggleId);
            toggle.classList.toggle('active');
        }

        // Theme functions
        function changeTheme() {
            const theme = document.getElementById('appTheme').value;
            appSettings.theme = theme;
            applyTheme(theme);
            saveThemeSettings();
            updateStatus(`🎨 Theme changed to ${theme.charAt(0).toUpperCase() + theme.slice(1)} mode`);
        }

        function changeColorScheme() {
            const scheme = document.getElementById('colorScheme').value;
            appSettings.colorScheme = scheme;
            applyColorScheme(scheme);
            saveThemeSettings();
            updateStatus(`🌈 Color scheme changed to ${scheme}`);
        }

        function applyTheme(theme) {
            if (theme === 'auto') {
                const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                theme = prefersDark ? 'dark' : 'light';
            }

            if (theme === 'light') {
                document.body.classList.add('light-theme');
            } else {
                document.body.classList.remove('light-theme');
            }
        }

        function applyColorScheme(scheme) {
            document.body.classList.remove('theme-ocean', 'theme-sunset', 'theme-forest', 'theme-cyber', 'theme-aurora', 'theme-fire');
            
            if (scheme !== 'default') {
                document.body.classList.add(`theme-${scheme}`);
            }
        }

        function saveThemeSettings() {
            localStorage.setItem('app-theme', appSettings.theme);
            localStorage.setItem('app-color-scheme', appSettings.colorScheme);
            localStorage.setItem('app-settings', JSON.stringify(appSettings));
        }

        // Subscription functions
        function updateSubscriptionDisplay() {
            const statusEl = document.getElementById('subscriptionStatus');
            
            if (appleMusic.connected && spotify.connected) {
                statusEl.className = 'subscription-status connected';
                statusEl.innerHTML = '🍎🎵 CONNECTED';
            } else if (appleMusic.connected) {
                statusEl.className = 'subscription-status connected';
                statusEl.innerHTML = '🍎 APPLE MUSIC';
            } else if (spotify.connected) {
                statusEl.className = 'subscription-status connected';
                statusEl.innerHTML = '🎵 SPOTIFY';
            } else {
                statusEl.className = `subscription-status ${userSubscription}`;
                statusEl.textContent = userSubscription.toUpperCase();
            }
            
            const premiumLock = document.getElementById('premiumLock');
            const proLock = document.getElementById('proLock');
            
            if (userSubscription === 'free') {
                if (premiumLock) premiumLock.style.display = 'block';
                if (proLock) proLock.style.display = 'block';
            } else if (userSubscription === 'premium') {
                if (premiumLock) premiumLock.style.display = 'none';
                if (proLock) proLock.style.display = 'block';
            } else {
                if (premiumLock) premiumLock.style.display = 'none';
                if (proLock) proLock.style.display = 'none';
            }
        }

        function subscribeToPlan(plan) {
            updateStatus(`🔄 Processing ${plan} subscription...`);
            
            setTimeout(() => {
                userSubscription = plan;
                updateSubscriptionDisplay();
                closeSubscription();
                updateStatus(`✅ Successfully upgraded to ${plan.toUpperCase()}!`);
                loadMusicLibrary();
            }, 2000);
        }

        function switchMusicTier(tier) {
            document.getElementById('musicGrid').style.display = 'flex';
            document.getElementById('appleMusicPanel').style.display = 'none';
            document.getElementById('spotifyPanel').style.display = 'none';

            if (tier === 'premium' && userSubscription === 'free') {
                openSubscription();
                return;
            }
            if (tier === 'pro' && (userSubscription === 'free' || userSubscription === 'premium')) {
                openSubscription();
                return;
            }
            
            currentMusicTier = tier;
            
            document.querySelectorAll('.tier-tab').forEach(tab => {
                tab.classList.remove('active');
                if (tab.dataset.tier === tier) {
                    tab.classList.add('active');
                }
            });
            
            if (tier === 'apple') {
                document.getElementById('musicGrid').style.display = 'none';
                document.getElementById('appleMusicPanel').style.display = 'block';
                if (appleMusic.connected) {
                    loadAppleLibrary();
                }
            } else if (tier === 'spotify') {
                document.getElementById('musicGrid').style.display = 'none';
                document.getElementById('spotifyPanel').style.display = 'block';
                if (spotify.connected) {
                    loadSpotifyLibrary();
                }
            } else {
                searchMusic();
            }
        }

        // Apple Music Integration
        async function connectAppleMusic() {
            const connectBtn = document.getElementById('appleConnectBtn');
            const statusDiv = document.getElementById('appleAuthStatus');
            const libraryDiv = document.getElementById('appleLibraryBrowser');

            if (appleMusic.connected) {
                appleMusic.connected = false;
                connectBtn.textContent = 'Connect';
                connectBtn.classList.remove('connected');
                statusDiv.style.display = 'block';
                libraryDiv.style.display = 'none';
                updateStatus('🍎 Disconnected from Apple Music');
                updateSubscriptionDisplay();
                return;
            }

            connectBtn.innerHTML = '<span class="loading-spinner"></span> Connecting...';
            updateStatus('🍎 Connecting to Apple Music...');

            try {
                await new Promise(resolve => setTimeout(resolve, 2000));
                
                appleMusic.connected = true;
                appleMusic.library = [...sampleAppleLibrary];
                
                connectBtn.textContent = 'Connected ✓';
                connectBtn.classList.add('connected');
                statusDiv.style.display = 'none';
                libraryDiv.style.display = 'block';
                
                updateStatus('✅ Connected to Apple Music successfully!');
                updateSubscriptionDisplay();
                loadAppleLibrary();
                
            } catch (error) {
                console.error('Apple Music connection failed:', error);
                updateStatus('❌ Failed to connect to Apple Music');
                connectBtn.textContent = 'Connect';
            }
        }

        function loadAppleLibrary() {
            const grid = document.getElementById('appleMusicGrid');
            grid.innerHTML = '';

            if (appleMusic.library.length === 0) {
                grid.innerHTML = '<p style="text-align: center; opacity: 0.7; padding: 20px;">No tracks found in your library</p>';
                return;
            }

            appleMusic.library.forEach(track => {
                const card = createAppleTrackCard(track);
                grid.appendChild(card);
            });
        }

        function createAppleTrackCard(track) {
            const card = document.createElement('div');
            card.className = 'apple-track-card';
            card.onclick = () => selectAppleTrack(track, card);

            card.innerHTML = `
                <div class="track-artwork">${track.artwork}</div>
                <div class="track-info">
                    <div class="track-title">${track.title}</div>
                    <div class="track-artist">${track.artist}</div>
                </div>
                <div class="track-controls">
                    <button class="mini-play-btn" onclick="event.stopPropagation(); previewAppleTrack('${track.id}', this)">▶</button>
                    <div class="track-duration">${track.duration}</div>
                </div>
            `;

            return card;
        }

        function selectAppleTrack(track, cardElement) {
            document.querySelectorAll('.apple-track-card, .spotify-track-card, .music-card').forEach(card => {
                card.classList.remove('selected');
            });
            
            cardElement.classList.add('selected');
            selectedMusic = {
                ...track,
                source: 'apple',
                tier: 'apple'
            };
            currentAudio = null;
            
            updateStatus(`🍎 Selected: ${track.title} by ${track.artist}`);
            updateStepAvailability();
            loadSelectedMusic(selectedMusic);
        }

        function previewAppleTrack(trackId, button) {
            const track = appleMusic.library.find(t => t.id === trackId);
            if (track) {
                audioPreviewManager.togglePreview(track, button, trackId);
            }
        }

        function switchAppleTab(tab) {
            appleMusic.currentTab = tab;
            
            document.querySelectorAll('.apple-tab').forEach(tabEl => {
                tabEl.classList.remove('active');
            });
            event.target.classList.add('active');
            
            switch (tab) {
                case 'library':
                    loadAppleLibrary();
                    break;
                case 'playlists':
                    loadApplePlaylists();
                    break;
                case 'search':
                    loadAppleSearch();
                    break;
                case 'recent':
                    loadAppleRecent();
                    break;
            }
        }

        function loadApplePlaylists() {
            const grid = document.getElementById('appleMusicGrid');
            grid.innerHTML = '<p style="text-align: center; opacity: 0.7; padding: 20px;">🎵 Your playlists will appear here</p>';
        }

        function loadAppleSearch() {
            const grid = document.getElementById('appleMusicGrid');
            grid.innerHTML = '<p style="text-align: center; opacity: 0.7; padding: 20px;">🔍 Search Apple Music catalog</p>';
        }

        function loadAppleRecent() {
            const grid = document.getElementById('appleMusicGrid');
            grid.innerHTML = '<p style="text-align: center; opacity: 0.7; padding: 20px;">⏰ Recently played tracks will appear here</p>';
        }

        // Spotify Integration
        async function connectSpotify() {
            const connectBtn = document.getElementById('spotifyConnectBtn');
            const statusDiv = document.getElementById('spotifyAuthStatus');
            const libraryDiv = document.getElementById('spotifyLibraryBrowser');

            if (spotify.connected) {
                spotify.connected = false;
                spotify.accessToken = null;
                connectBtn.textContent = 'Connect';
                connectBtn.classList.remove('connected');
                statusDiv.style.display = 'block';
                libraryDiv.style.display = 'none';
                updateStatus('🎵 Disconnected from Spotify');
                updateSubscriptionDisplay();
                return;
            }

            connectBtn.innerHTML = '<span class="loading-spinner"></span> Connecting...';
            updateStatus('🎵 Connecting to Spotify...');

            try {
                await new Promise(resolve => setTimeout(resolve, 2000));
                
                spotify.connected = true;
                spotify.accessToken = 'mock_access_token';
                spotify.library = [...sampleSpotifyLibrary];
                
                connectBtn.textContent = 'Connected ✓';
                connectBtn.classList.add('connected');
                statusDiv.style.display = 'none';
                libraryDiv.style.display = 'block';
                
                updateStatus('✅ Connected to Spotify successfully!');
                updateSubscriptionDisplay();
                loadSpotifyLibrary();
                
            } catch (error) {
                console.error('Spotify connection failed:', error);
                updateStatus('❌ Failed to connect to Spotify');
                connectBtn.textContent = 'Connect';
            }
        }

        function loadSpotifyLibrary() {
            const grid = document.getElementById('spotifyMusicGrid');
            grid.innerHTML = '';

            if (spotify.library.length === 0) {
                grid.innerHTML = '<p style="text-align: center; opacity: 0.7; padding: 20px;">No tracks found in your library</p>';
                return;
            }

            spotify.library.forEach(track => {
                const card = createSpotifyTrackCard(track);
                grid.appendChild(card);
            });
        }

        function createSpotifyTrackCard(track) {
            const card = document.createElement('div');
            card.className = 'spotify-track-card';
            card.onclick = () => selectSpotifyTrack(track, card);

            card.innerHTML = `
                <div class="track-artwork">${track.artwork}</div>
                <div class="track-info">
                    <div class="track-title">${track.title}</div>
                    <div class="track-artist">${track.artist}</div>
                </div>
                <div class="track-controls">
                    <button class="mini-play-btn" onclick="event.stopPropagation(); previewSpotifyTrack('${track.id}', this)">▶</button>
                    <div class="track-duration">${track.duration}</div>
                </div>
            `;

            return card;
        }

        function selectSpotifyTrack(track, cardElement) {
            document.querySelectorAll('.apple-track-card, .spotify-track-card, .music-card').forEach(card => {
                card.classList.remove('selected');
            });
            
            cardElement.classList.add('selected');
            selectedMusic = {
                ...track,
                source: 'spotify',
                tier: 'spotify'
            };
            currentAudio = null;
            
            updateStatus(`🎵 Selected: ${track.title} by ${track.artist}`);
            updateStepAvailability();
            loadSelectedMusic(selectedMusic);
        }

        function previewSpotifyTrack(trackId, button) {
            const track = spotify.library.find(t => t.id === trackId);
            if (track) {
                audioPreviewManager.togglePreview(track, button, trackId);
            }
        }

        function switchSpotifyTab(tab) {
            spotify.currentTab = tab;
            
            document.querySelectorAll('.apple-tab').forEach(tabEl => {
                tabEl.classList.remove('active');
            });
            event.target.classList.add('active');
            
            switch (tab) {
                case 'playlists':
                    loadSpotifyPlaylists();
                    break;
                case 'liked':
                    loadSpotifyLiked();
                    break;
                case 'search':
                    loadSpotifySearch();
                    break;
                case 'recent':
                    loadSpotifyRecent();
                    break;
            }
        }

        function loadSpotifyPlaylists() {
            const grid = document.getElementById('spotifyMusicGrid');
            grid.innerHTML = '<p style="text-align: center; opacity: 0.7; padding: 20px;">🎵 Your playlists will appear here</p>';
        }

        function loadSpotifyLiked() {
            const grid = document.getElementById('spotifyMusicGrid');
            loadSpotifyLibrary();
        }

        function loadSpotifySearch() {
            const grid = document.getElementById('spotifyMusicGrid');
            grid.innerHTML = '<p style="text-align: center; opacity: 0.7; padding: 20px;">🔍 Search Spotify catalog</p>';
        }

        function loadSpotifyRecent() {
            const grid = document.getElementById('spotifyMusicGrid');
            grid.innerHTML = '<p style="text-align: center; opacity: 0.7; padding: 20px;">⏰ Recently played tracks will appear here</p>';
        }

        function searchAppleMusic() {
            const query = document.getElementById('appleSearchInput').value;
            if (query.trim()) {
                updateStatus(`🍎 Searching Apple Music for: ${query}`);
            }
        }

        function searchSpotify() {
            const query = document.getElementById('spotifySearchInput').value;
            if (query.trim()) {
                updateStatus(`🎵 Searching Spotify for: ${query}`);
            }
        }

        // Step navigation
        function goToStep(step) {
            if (step <= currentStep || isStepCompleted(step - 1)) {
                showStep(step);
            }
        }

        function nextStep() {
            if (currentStep < 4) {
                markStepCompleted(currentStep);
                currentStep++;
                showStep(currentStep);
                updateStepAvailability();
            }
        }

        function prevStep() {
            if (currentStep > 1) {
                currentStep--;
                showStep(currentStep);
            }
        }

        function showStep(step) {
            document.querySelectorAll('.step-content').forEach(content => {
                content.classList.remove('active');
            });
            
            document.getElementById(`content${step}`).classList.add('active');
            
            document.querySelectorAll('.step').forEach((stepEl, index) => {
                stepEl.classList.remove('active');
                if (index + 1 === step) {
                    stepEl.classList.add('active');
                }
            });
            
            currentStep = step;
            document.querySelector('.main-content').scrollTop = 0;
        }

        function markStepCompleted(step) {
            document.getElementById(`step${step}`).classList.add('completed');
        }

        function isStepCompleted(step) {
            return document.getElementById(`step${step}`).classList.contains('completed');
        }

        function updateStepAvailability() {
            const hasMusic = selectedMusic || currentAudio;
            document.getElementById('nextStep1').disabled = !hasMusic;
            if (hasMusic) {
                document.getElementById('nextStep1').innerHTML = '➡️ Next: Add Visuals ✓';
            }
        }

        // Music functions
        function loadMusicLibrary() {
            searchMusic();
        }

        function searchMusic() {
            const searchTerm = document.getElementById('musicSearch').value.toLowerCase();
            const genreFilter = document.getElementById('genreFilter').value;
            
            let filteredMusic = freeMusicDatabase.filter(track => {
                const matchesSearch = track.title.toLowerCase().includes(searchTerm) ||
                                    track.artist.toLowerCase().includes(searchTerm) ||
                                    track.tags.some(tag => tag.toLowerCase().includes(searchTerm));
                
                const matchesGenre = !genreFilter || track.genre === genreFilter;
                const matchesTier = track.tier === currentMusicTier;
                
                return matchesSearch && matchesGenre && matchesTier;
            });

            renderMusicGrid(filteredMusic);
        }

        function renderMusicGrid(tracks) {
            const grid = document.getElementById('musicGrid');
            grid.innerHTML = '';

            if (tracks.length === 0) {
                grid.innerHTML = '<p style="text-align: center; opacity: 0.7; padding: 20px;">No tracks found. Try different search terms or upgrade your plan!</p>';
                return;
            }

            tracks.forEach(track => {
                const card = createMusicCard(track);
                grid.appendChild(card);
            });
        }

        function createMusicCard(track) {
            const card = document.createElement('div');
            card.className = 'music-card';
            
            const hasAccess = canAccessTrack(track);
            if (!hasAccess) {
                card.classList.add('locked');
            }
            
            card.onclick = () => {
                if (hasAccess) {
                    selectMusic(track, card);
                } else {
                    openSubscription();
                }
            };

            card.innerHTML = `
                <div class="music-tier-badge ${track.tier}">${track.tier.toUpperCase()}</div>
                <div class="music-info">
                    <h4>${track.title}</h4>
                    <p>by ${track.artist}</p>
                    <p>${track.genre.toUpperCase()} • ${track.bpm} BPM • ${track.duration}</p>
                </div>
                <div class="music-controls">
                    <button class="play-btn" ${!hasAccess ? 'disabled' : ''} onclick="event.stopPropagation(); ${hasAccess ? `togglePreview('${track.id}', this)` : 'openSubscription()'}">▶</button>
                    <div class="waveform">
                        <div class="waveform-progress" id="progress-${track.id}"></div>
                        <div class="waveform-time" id="time-${track.id}">0:00</div>
                    </div>
                    <button class="select-btn ${hasAccess ? '' : 'upgrade-btn'}" onclick="event.stopPropagation(); ${hasAccess ? `selectMusic(${JSON.stringify(track)}, this.closest('.music-card'))` : 'openSubscription()'}">
                        ${hasAccess ? 'Select' : 'Upgrade'}
                    </button>
                </div>
            `;

            return card;
        }

        function canAccessTrack(track) {
            if (track.tier === 'free') return true;
            if (track.tier === 'premium' && (userSubscription === 'premium' || userSubscription === 'pro')) return true;
            if (track.tier === 'pro' && userSubscription === 'pro') return true;
            return false;
        }

        function togglePreview(trackId, button) {
            const track = freeMusicDatabase.find(t => t.id == trackId);
            if (track) {
                audioPreviewManager.togglePreview(track, button, trackId);
            }
        }

        function selectMusic(track, cardElement) {
            if (!canAccessTrack(track)) {
                openSubscription();
                return;
            }
            
            if (audioPreviewManager.currentAudio && !audioPreviewManager.currentAudio.paused) {
                audioPreviewManager.currentAudio.pause();
                audioPreviewManager.currentAudio.currentTime = 0;
            }
            
            document.querySelectorAll('.play-btn').forEach(btn => {
                btn.innerHTML = '▶';
                btn.classList.remove('playing');
            });
            document.querySelectorAll('.music-card').forEach(card => {
                card.classList.remove('selected', 'playing');
            });
            document.querySelectorAll('.select-btn').forEach(btn => {
                if (!btn.classList.contains('upgrade-btn')) {
                    btn.textContent = 'Select';
                    btn.classList.remove('selected');
                }
            });
            
            cardElement.classList.add('selected');
            const selectBtn = cardElement.querySelector('.select-btn');
            if (!selectBtn.classList.contains('upgrade-btn')) {
                selectBtn.textContent = 'Selected ✓';
                selectBtn.classList.add('selected');
            }
            
            selectedMusic = track;
            currentAudio = null;
            
            updateStatus(`🎵 Selected: ${track.title}`);
            updateStepAvailability();
            loadSelectedMusic(track);
        }

        async function loadSelectedMusic(track) {
            try {
                updateStatus(`🔄 Loading: ${track.title}...`);
                currentAudio = await createSyntheticAudioBlob(track);
                updateStatus(`✅ Loaded: ${track.title} - Ready to generate!`);
            } catch (error) {
                console.error('Error loading music:', error);
                updateStatus(`⚠️ Using synthetic audio for: ${track.title}`);
                currentAudio = await createSyntheticAudioBlob(track);
            }
        }

        async function createSyntheticAudioBlob(track) {
            const sampleRate = 44100;
            const duration = 10;
            const numChannels = 2;
            const numSamples = sampleRate * duration;
            
            const buffer = new ArrayBuffer(44 + numSamples * numChannels * 2);
            const view = new DataView(buffer);
            
            const writeString = (offset, string) => {
                for (let i = 0; i < string.length; i++) {
                    view.setUint8(offset + i, string.charCodeAt(i));
                }
            };
            
            writeString(0, 'RIFF');
            view.setUint32(4, 36 + numSamples * numChannels * 2, true);
            writeString(8, 'WAVE');
            writeString(12, 'fmt ');
            view.setUint32(16, 16, true);
            view.setUint16(20, 1, true);
            view.setUint16(22, numChannels, true);
            view.setUint32(24, sampleRate, true);
            view.setUint32(28, sampleRate * numChannels * 2, true);
            view.setUint16(32, numChannels * 2, true);
            view.setUint16(34, 16, true);
            writeString(36, 'data');
            view.setUint32(40, numSamples * numChannels * 2, true);
            
            const beatsPerSecond = track.bpm / 60;
            const beatInterval = sampleRate / beatsPerSecond;
            
            for (let i = 0; i < numSamples; i++) {
                const time = i / sampleRate;
                let sample = 0;
                
                switch (track.genre) {
                    case 'electronic':
                    case 'edm':
                        sample = Math.sin(2 * Math.PI * 440 * time) * 0.3;
                        if (i % Math.floor(beatInterval) < beatInterval * 0.1) {
                            sample += Math.sin(2 * Math.PI * 220 * time) * 0.5;
                        }
                        break;
                    case 'dubstep':
                    case 'trap':
                        sample = Math.sin(2 * Math.PI * 160 * time) * 0.4;
                        if (i % Math.floor(beatInterval) < beatInterval * 0.2) {
                            sample += Math.random() * 0.3 - 0.15;
                        }
                        break;
                    case 'house':
                    case 'techno':
                        sample = Math.sin(2 * Math.PI * 330 * time) * 0.25;
                        if (i % Math.floor(beatInterval / 4) < beatInterval * 0.05) {
                            sample += Math.sin(2 * Math.PI * 880 * time) * 0.2;
                        }
                        break;
                    default:
                        sample = Math.sin(2 * Math.PI * 440 * time) * 0.3;
                }
                
                const intSample = Math.max(-32768, Math.min(32767, Math.floor(sample * 32767)));
                view.setInt16(44 + i * 4, intSample, true);
                view.setInt16(44 + i * 4 + 2, intSample, true);
            }
            
            return new Blob([buffer], { type: 'audio/wav' });
        }

        // File upload handlers
        async function handleAudioUpload(event) {
            const files = Array.from(event.target.files);
            if (files.length > 0) {
                const file = files[0];
                currentAudio = file;
                selectedMusic = null;
                
                document.querySelectorAll('.music-card').forEach(card => {
                    card.classList.remove('selected');
                });
                document.querySelectorAll('.select-btn').forEach(btn => {
                    if (!btn.classList.contains('upgrade-btn')) {
                        btn.textContent = 'Select';
                        btn.classList.remove('selected');
                    }
                });
                
                const uploadArea = document.getElementById('audioUploadArea');
                uploadArea.classList.add('has-files');
                uploadArea.innerHTML = `
                    <div class="upload-icon">✅</div>
                    <h4>Audio Uploaded</h4>
                    <p>${file.name}</p>
                    <button class="remove-btn" onclick="removeCustomAudio()" style="margin-top: 10px;">Remove</button>
                `;
                
                updateStatus(`🎵 Custom audio: ${file.name}`);
                updateStepAvailability();
            }
        }

        function removeCustomAudio() {
            currentAudio = null;
            selectedMusic = null;
            
            const uploadArea = document.getElementById('audioUploadArea');
            uploadArea.classList.remove('has-files');
            uploadArea.innerHTML = `
                <input type="file" id="audioFile" accept="audio/*,video/*">
                <div class="upload-icon">🎵</div>
                <h4>Upload Your Music</h4>
                <p>Tap to upload (.mp3, .wav, .m4a)</p>
            `;
            
            document.getElementById('audioFile').addEventListener('change', handleAudioUpload);
            
            updateStatus('🎵 Audio removed');
            updateStepAvailability();
        }

        async function handleMediaUpload(event) {
            const files = Array.from(event.target.files);
            const uploadArea = document.getElementById('mediaUploadArea');
            uploadArea.classList.add('has-files');
            
            updateStatus(`📷 Processing ${files.length} files...`);
            
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                currentMedia.push(file);
            }
            
            updateStatus(`🎬 ${files.length} files added (Total: ${currentMedia.length})`);
            displayUploadedFiles();
        }

        function displayUploadedFiles() {
            const container = document.getElementById('uploadedFiles');
            container.innerHTML = '';

            if (currentMedia.length === 0) return;

            const header = document.createElement('h4');
            header.textContent = `📁 Files (${currentMedia.length})`;
            header.style.marginBottom = '10px';
            header.style.fontSize = '1rem';
            container.appendChild(header);

            currentMedia.forEach((file, index) => {
                const item = document.createElement('div');
                item.className = 'file-item';
                
                let fileName = file.name;
                const size = (file.size / 1024 / 1024).toFixed(2);
                
                if (fileName.length > 20) {
                    fileName = fileName.substring(0, 20) + '...';
                }
                
                item.innerHTML = `
                    <div style="flex: 1;">
                        <div>${file.type.startsWith('image/') ? '🖼️' : '🎬'} ${fileName}</div>
                        <div style="font-size: 0.7rem; opacity: 0.7; margin-top: 2px;">(${size}MB)</div>
                    </div>
                    <button class="remove-btn" onclick="removeMedia(${index})">Remove</button>
                `;
                container.appendChild(item);
            });
        }

        function removeMedia(index) {
            currentMedia.splice(index, 1);
            displayUploadedFiles();
            
            if (currentMedia.length === 0) {
                document.getElementById('mediaUploadArea').classList.remove('has-files');
            }
            
            updateStatus(`🎬 File removed (${currentMedia.length} remaining)`);
        }

        // Audio visualizer
        function initAudioVisualizer() {
            const visualizer = document.getElementById('audioVisualizer');
            for (let i = 0; i < 32; i++) {
                const bar = document.createElement('div');
                bar.className = 'audio-bar';
                bar.style.height = '3px';
                visualizer.appendChild(bar);
            }
        }

        // Test audio function
        function testAudio() {
            const testTrack = {
                id: 'test',
                title: 'Test Audio',
                artist: 'System',
                genre: 'electronic',
                bpm: 120
            };
            
            const button = document.createElement('button');
            button.innerHTML = '▶';
            button.style.cssText = 'background: #4ecdc4; border: none; border-radius: 50%; color: white; width: 40px; height: 40px; font-size: 16px; cursor: pointer; position: fixed; top: 20px; right: 20px; z-index: 10000;';
            
            document.body.appendChild(button);
            
            audioPreviewManager.togglePreview(testTrack, button, 'test').then(() => {
                updateStatus('🔊 Test audio playing! Audio system is working perfectly.');
                setTimeout(() => {
                    if (document.body.contains(button)) {
                        document.body.removeChild(button);
                    }
                }, 15000);
            });
        }

        // Generate function
        async function generateClip() {
            if (!currentAudio && !selectedMusic) {
                updateStatus('❌ Please select music from Step 1!');
                goToStep(1);
                return;
            }

            const generateBtn = document.getElementById('generateBtn');
            generateBtn.disabled = true;
            generateBtn.innerHTML = '<span class="loading-spinner"></span> Creating Magic...';

            try {
                const AudioContext = window.AudioContext || window.webkitAudioContext;
                audioContext = new AudioContext();
                analyser = audioContext.createAnalyser();
                analyser.fftSize = 512;
                
                const audioElement = document.createElement('audio');
                audioElement.src = URL.createObjectURL(currentAudio);
                audioElement.crossOrigin = 'anonymous';
                
                const masterVolume = document.getElementById('masterVolume')?.value / 100 || 0.8;
                audioElement.volume = masterVolume;
                
                audioSource = audioContext.createMediaElementSource(audioElement);
                audioSource.connect(analyser);
                analyser.connect(audioContext.destination);
                
                beatDetector = new BeatDetector(audioContext, analyser);
                effectsEngine = new EffectsEngine();
                
                if (selectedMusic) {
                    aiEffectsEngine.analyzeMusic(selectedMusic);
                }
                
                if (currentMedia.length > 0) {
                    effectsEngine.switchMedia();
                } else {
                    const defaultDiv = document.createElement('div');
                    defaultDiv.style.cssText = `
                        width: 100%; height: 100%;
                        background: linear-gradient(45deg, #667eea, #764ba2);
                        display: flex; align-items: center; justify-content: center;
                        color: white; font-size: 2rem; text-align: center;
                        padding: 20px;
                    `;
                    defaultDiv.innerHTML = '🎵<br>Visualizer';
                    document.getElementById('previewContent').innerHTML = '';
                    document.getElementById('previewContent').appendChild(defaultDiv);
                }
                
                await audioElement.play();
                isPlaying = true;
                
                updateStatus('🎵 AI analyzing and syncing...');
                
                function animate() {
                    if (!isPlaying) return;
                    
                    const beatData = beatDetector.detectBeat();
                    effectsEngine.applyBeatEffect(beatData);
                    updateAudioVisualizer();
                    updateProgress(audioElement);
                    
                    requestAnimationFrame(animate);
                }
                
                animate();
                
                const duration = parseInt(document.getElementById('duration').value) * 1000;
                setTimeout(() => {
                    audioElement.pause();
                    isPlaying = false;
                    updateStatus('✅ Beat-synced clip completed! 🎉');
                    generateBtn.disabled = false;
                    generateBtn.innerHTML = '🎬 Generate Beat-Synced Clip';
                    markStepCompleted(4);
                    
                    // Show export section
                    document.getElementById('exportSection').style.display = 'block';
                    currentGeneratedClip = {
                        audioElement: audioElement,
                        duration: duration / 1000,
                        effects: effectsEngine,
                        timestamp: Date.now()
                    };
                }, duration);
                
            } catch (error) {
                console.error('Error:', error);
                updateStatus('❌ Error generating clip. Try again.');
                generateBtn.disabled = false;
                generateBtn.innerHTML = '🎬 Generate Beat-Synced Clip';
            }
        }

        function updateAudioVisualizer() {
            if (!analyser) return;
            
            const dataArray = new Uint8Array(analyser.frequencyBinCount);
            analyser.getByteFrequencyData(dataArray);
            
            const bars = document.querySelectorAll('.audio-bar');
            const step = Math.floor(dataArray.length / bars.length);
            
            bars.forEach((bar, index) => {
                const value = dataArray[index * step];
                const height = Math.max(2, (value / 255) * 50);
                bar.style.height = height + 'px';
            });
        }

        function updateProgress(audioElement) {
            if (audioElement.duration) {
                const progress = (audioElement.currentTime / audioElement.duration) * 100;
                document.getElementById('progressFill').style.width = progress + '%';
            }
        }

        // Export functions
        function selectExportFormat(format) {
            exportFormat = format;
            
            document.querySelectorAll('.format-tab').forEach(tab => {
                tab.classList.remove('active');
                if (tab.dataset.format === format) {
                    tab.classList.add('active');
                }
            });
            
            updateStatus(`📤 Export format set to ${format.toUpperCase()}`);
        }

        function updateQualityLabel() {
            const quality = document.getElementById('exportQuality').value;
            document.getElementById('qualityLabel').textContent = quality;
        }

        async function exportVideo() {
            if (!currentGeneratedClip) {
                updateStatus('❌ No clip to export! Generate a clip first.');
                return;
            }

            const exportBtn = document.getElementById('exportBtn');
            exportBtn.disabled = true;
            exportBtn.innerHTML = '<span class="loading-spinner"></span> Exporting...';

            try {
                updateStatus('🔄 Preparing export...');
                
                // Simulate export process
                for (let i = 0; i <= 100; i += 10) {
                    await new Promise(resolve => setTimeout(resolve, 200));
                    document.getElementById('progressFill').style.width = i + '%';
                    updateStatus(`📤 Exporting ${exportFormat.toUpperCase()}: ${i}%`);
                }
                
                // Create download link
                const link = document.createElement('a');
                const quality = document.getElementById('exportQuality').value;
                const filename = `beat-sync-clip-${Date.now()}.${exportFormat}`;
                
                // For demo, create a small file
                const blob = new Blob(['Beat-Sync Pro Export'], { type: `video/${exportFormat}` });
                link.href = URL.createObjectURL(blob);
                link.download = filename;
                link.click();
                
                updateStatus(`✅ ${exportFormat.toUpperCase()} exported successfully!`);
                exportBtn.disabled = false;
                exportBtn.innerHTML = '💾 Export Video';
                
            } catch (error) {
                console.error('Export error:', error);
                updateStatus('❌ Export failed. Try again.');
                exportBtn.disabled = false;
                exportBtn.innerHTML = '💾 Export Video';
            }
        }

        async function shareToSocial(platform) {
            if (!currentGeneratedClip) {
                updateStatus('❌ No clip to share! Generate a clip first.');
                return;
            }

            updateStatus(`📤 Preparing to share to ${platform.charAt(0).toUpperCase() + platform.slice(1)}...`);
            
            try {
                if (navigator.share) {
                    await navigator.share({
                        title: 'My Beat-Sync Creation',
                        text: 'Check out this amazing beat-synced video I made with Beat-Sync Pro!',
                        url: window.location.href
                    });
                    updateStatus(`✅ Shared to ${platform} successfully!`);
                } else {
                    // Fallback for browsers without native sharing
                    const urls = {
                        instagram: 'https://instagram.com',
                        tiktok: 'https://tiktok.com',
                        youtube: 'https://youtube.com'
                    };
                    
                    window.open(urls[platform], '_blank');
                    updateStatus(`📱 Opening ${platform.charAt(0).toUpperCase() + platform.slice(1)}...`);
                }
            } catch (error) {
                updateStatus(`❌ Failed to share to ${platform}`);
            }
        }

        function updateSliderValue(sliderId, displayId) {
            const value = document.getElementById(sliderId).value;
            document.getElementById(displayId).textContent = value;
        }

        function updateStatus(message) {
            document.getElementById('status').innerHTML = message;
        }

        // Initialize
        updateStatus('🎵 Welcome! AI effects ready, themes loaded. Connect music services or upload content to begin!');
    </script>
</body>
</html>
