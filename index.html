<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#667eea">
    <title>Beat-Sync Clip Maker</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
        }

        html, body {
            height: 100vh;
            height: 100dvh;
            overflow: hidden;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            position: fixed;
            width: 100%;
        }

        .app-container {
            height: 100vh;
            height: 100dvh;
            display: flex;
            flex-direction: column;
            padding-top: env(safe-area-inset-top);
            padding-bottom: env(safe-area-inset-bottom);
            padding-left: env(safe-area-inset-left);
            padding-right: env(safe-area-inset-right);
        }

        .header {
            text-align: center;
            padding: 15px 20px 10px;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }

        .header h1 {
            font-size: 1.8rem;
            font-weight: 700;
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4, #45b7d1);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 5px;
        }

        .header p {
            font-size: 0.85rem;
            opacity: 0.9;
            line-height: 1.2;
        }

        .workflow-steps {
            display: flex;
            padding: 15px 10px;
            gap: 8px;
            background: rgba(255, 255, 255, 0.05);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        .step {
            background: rgba(255, 255, 255, 0.1);
            padding: 12px 8px;
            border-radius: 12px;
            border: 2px solid transparent;
            transition: all 0.3s ease;
            min-width: 85px;
            text-align: center;
            cursor: pointer;
            flex-shrink: 0;
        }

        .step.active {
            border-color: #4ecdc4;
            background: rgba(78, 205, 196, 0.3);
            transform: scale(1.05);
        }

        .step.completed {
            border-color: #00b894;
            background: rgba(0, 184, 148, 0.3);
        }

        .step-number {
            background: #4ecdc4;
            color: white;
            width: 26px;
            height: 26px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 8px;
            font-weight: bold;
            font-size: 0.9rem;
        }

        .step.completed .step-number {
            background: #00b894;
        }

        .step-title {
            font-size: 0.75rem;
            font-weight: 600;
            margin-bottom: 2px;
        }

        .step-desc {
            font-size: 0.65rem;
            opacity: 0.8;
        }

        .main-content {
            flex: 1;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            padding: 20px 15px;
        }

        .step-content {
            display: none;
        }

        .step-content.active {
            display: block;
        }

        .section-title {
            font-size: 1.3rem;
            margin-bottom: 15px;
            font-weight: 600;
        }

        .selection-instructions {
            background: rgba(255, 255, 255, 0.15);
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 20px;
            border-left: 4px solid #4ecdc4;
            font-size: 0.85rem;
            line-height: 1.4;
        }

        .search-container {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 20px;
        }

        .search-input {
            width: 100%;
            padding: 14px 15px;
            border-radius: 12px;
            border: none;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            font-size: 1rem;
            outline: none;
        }

        .search-input::placeholder {
            color: rgba(255, 255, 255, 0.7);
        }

        .search-row {
            display: flex;
            gap: 10px;
        }

        .genre-filter {
            flex: 1;
            padding: 14px 15px;
            border-radius: 12px;
            border: none;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            font-size: 0.9rem;
            outline: none;
        }

        .genre-filter option {
            background: #333;
            color: white;
        }

        .search-btn {
            padding: 14px 20px;
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
            border: none;
            border-radius: 12px;
            color: white;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.9rem;
            min-width: 80px;
        }

        .music-grid {
            display: flex;
            flex-direction: column;
            gap: 15px;
            max-height: 400px;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            padding: 5px;
        }

        .music-card {
            background: rgba(255, 255, 255, 0.15);
            border-radius: 15px;
            padding: 18px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 3px solid transparent;
            position: relative;
        }

        .music-card:active {
            transform: scale(0.98);
        }

        .music-card.selected {
            border-color: #ff6b6b;
            background: rgba(255, 107, 107, 0.25);
            box-shadow: 0 0 20px rgba(255, 107, 107, 0.3);
        }

        .music-card.playing {
            border-color: #f9ca24;
            background: rgba(249, 202, 36, 0.25);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { box-shadow: 0 0 20px rgba(249, 202, 36, 0.3); }
            50% { box-shadow: 0 0 30px rgba(249, 202, 36, 0.6); }
        }

        .music-info h4 {
            margin-bottom: 8px;
            color: #fff;
            font-size: 1.1rem;
            font-weight: 600;
        }

        .music-info p {
            color: rgba(255, 255, 255, 0.8);
            font-size: 0.85rem;
            margin-bottom: 5px;
            line-height: 1.3;
        }

        .music-controls {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-top: 15px;
        }

        .play-btn {
            background: #4ecdc4;
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: white;
            font-size: 18px;
            transition: all 0.3s ease;
            flex-shrink: 0;
        }

        .play-btn:active {
            transform: scale(0.95);
        }

        .play-btn.playing {
            background: #f9ca24;
            animation: playingPulse 1s infinite;
        }

        @keyframes playingPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .waveform {
            flex: 1;
            height: 40px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            position: relative;
            overflow: hidden;
            display: flex;
            align-items: center;
            padding: 0 12px;
        }

        .waveform-progress {
            height: 70%;
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
            border-radius: 15px;
            width: 0%;
            transition: width 0.1s ease;
        }

        .waveform-time {
            position: absolute;
            right: 12px;
            font-size: 0.75rem;
            color: rgba(255, 255, 255, 0.9);
            z-index: 2;
            font-weight: 500;
        }

        .select-btn {
            background: linear-gradient(45deg, #00b894, #55a3ff);
            border: none;
            border-radius: 12px;
            color: white;
            padding: 12px 16px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.85rem;
            transition: all 0.3s ease;
            min-height: 44px;
        }

        .select-btn:active {
            transform: scale(0.95);
        }

        .select-btn.selected {
            background: linear-gradient(45deg, #ff6b6b, #ff8e8e);
        }

        .upload-section {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 20px;
        }

        .upload-area {
            border: 3px dashed rgba(255, 255, 255, 0.5);
            border-radius: 15px;
            padding: 30px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            min-height: 140px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .upload-area:active {
            transform: scale(0.98);
        }

        .upload-area.has-files {
            border-color: #00b894;
            background: rgba(0, 184, 148, 0.15);
        }

        .upload-area input {
            position: absolute;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }

        .upload-icon {
            font-size: 2.5rem;
            margin-bottom: 12px;
            opacity: 0.8;
        }

        .upload-area h4 {
            font-size: 1.1rem;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .upload-area p {
            font-size: 0.85rem;
            opacity: 0.8;
            line-height: 1.3;
        }

        .controls-grid {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 20px;
        }

        .control-group {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .control-group label {
            display: block;
            margin-bottom: 10px;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .control-group select,
        .control-group input {
            width: 100%;
            padding: 12px;
            border-radius: 10px;
            border: none;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            font-size: 1rem;
            outline: none;
        }

        .control-group input[type="range"] {
            padding: 0;
            height: 44px;
            -webkit-appearance: none;
            background: transparent;
        }

        .control-group input[type="range"]::-webkit-slider-track {
            background: rgba(255, 255, 255, 0.3);
            height: 6px;
            border-radius: 3px;
        }

        .control-group input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 24px;
            width: 24px;
            border-radius: 50%;
            background: #4ecdc4;
            cursor: pointer;
            margin-top: -9px;
        }

        .control-group select option {
            background: #333;
            color: white;
        }

        .next-step-btn {
            width: 100%;
            padding: 18px;
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
            border: none;
            border-radius: 12px;
            color: white;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 20px;
            min-height: 56px;
        }

        .next-step-btn:active {
            transform: scale(0.98);
        }

        .next-step-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .generate-btn {
            width: 100%;
            padding: 20px;
            background: linear-gradient(45deg, #00b894, #55a3ff);
            border: none;
            border-radius: 12px;
            color: white;
            font-size: 1.2rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 20px;
            min-height: 60px;
        }

        .generate-btn:active {
            transform: scale(0.98);
        }

        .generate-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .button-row {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .button-row .next-step-btn {
            margin-top: 0;
        }

        .preview-section {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            margin-top: 20px;
        }

        .preview-container {
            position: relative;
            width: 100%;
            aspect-ratio: 16/9;
            background: #000;
            border-radius: 12px;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 15px;
        }

        .preview-content {
            width: 100%;
            height: 100%;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
            text-align: center;
            padding: 20px;
        }

        .preview-media {
            max-width: 100%;
            max-height: 100%;
            object-fit: cover;
            border-radius: 8px;
        }

        .effect-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 10;
        }

        .audio-visualizer {
            position: absolute;
            bottom: 10px;
            left: 10px;
            right: 10px;
            height: 60px;
            display: flex;
            align-items: end;
            gap: 2px;
            z-index: 15;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 8px;
            padding: 8px;
        }

        .audio-bar {
            flex: 1;
            background: linear-gradient(to top, #ff6b6b, #4ecdc4, #45b7d1);
            border-radius: 1px;
            transition: height 0.05s ease;
            opacity: 0.9;
            min-height: 2px;
        }

        .status {
            text-align: center;
            padding: 12px;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.1);
            font-weight: 500;
            font-size: 0.85rem;
            line-height: 1.3;
        }

        .beat-indicator {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 20px;
            height: 20px;
            background: #ff6b6b;
            border-radius: 50%;
            z-index: 15;
            opacity: 0;
            transition: all 0.1s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: bold;
        }

        .beat-active {
            opacity: 1;
            animation: beatPulse 0.3s ease;
            box-shadow: 0 0 15px rgba(255, 107, 107, 0.8);
        }

        @keyframes beatPulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.5); }
            100% { transform: scale(1); }
        }

        .file-list {
            margin-top: 15px;
            max-height: 200px;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        .file-item {
            background: rgba(255, 255, 255, 0.1);
            padding: 12px;
            margin-bottom: 8px;
            border-radius: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.85rem;
        }

        .remove-btn {
            background: #ff6b6b;
            border: none;
            border-radius: 8px;
            color: white;
            padding: 8px 12px;
            cursor: pointer;
            font-size: 0.75rem;
            font-weight: 500;
            min-height: 36px;
        }

        .remove-btn:active {
            transform: scale(0.95);
        }

        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .progress-bar {
            width: 100%;
            height: 6px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 3px;
            margin-top: 12px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
            width: 0%;
            transition: width 0.3s ease;
        }

        .effect-flash { animation: flashEffect 0.4s ease; }
        @keyframes flashEffect {
            0% { filter: brightness(1) contrast(1) saturate(1); }
            50% { filter: brightness(1.8) contrast(1.4) saturate(1.6) hue-rotate(30deg); }
            100% { filter: brightness(1) contrast(1) saturate(1); }
        }

        .effect-zoom { animation: zoomEffect 0.6s ease; }
        @keyframes zoomEffect {
            0% { transform: scale(1) rotate(0deg); }
            50% { transform: scale(1.15) rotate(2deg); }
            100% { transform: scale(1) rotate(0deg); }
        }

        .effect-shake { animation: shakeEffect 0.4s ease; }
        @keyframes shakeEffect {
            0%, 100% { transform: translateX(0) translateY(0); }
            25% { transform: translateX(-8px) translateY(4px); }
            75% { transform: translateX(8px) translateY(-4px); }
        }

        .particle {
            position: absolute;
            pointer-events: none;
            border-radius: 50%;
            z-index: 20;
        }

        /* iOS specific optimizations */
        @supports (-webkit-touch-callout: none) {
            .app-container {
                height: -webkit-fill-available;
            }
        }

        /* Landscape mode adjustments */
        @media screen and (orientation: landscape) and (max-height: 500px) {
            .header {
                padding: 10px 20px 5px;
            }
            
            .header h1 {
                font-size: 1.5rem;
                margin-bottom: 3px;
            }
            
            .header p {
                font-size: 0.75rem;
            }
            
            .workflow-steps {
                padding: 10px;
            }
            
            .main-content {
                padding: 15px;
            }
            
            .preview-container {
                aspect-ratio: 2/1;
            }
        }

        /* Dark mode media query */
        @media (prefers-color-scheme: dark) {
            .control-group input,
            .control-group select,
            .search-input,
            .genre-filter {
                background: rgba(255, 255, 255, 0.15);
            }
        }

        /* Accessibility improvements */
        @media (prefers-reduced-motion: reduce) {
            * {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }

        /* Touch feedback for better UX */
        .music-card:active,
        .upload-area:active,
        .step:active {
            background: rgba(255, 255, 255, 0.2);
        }

        /* Ensure minimum touch target size */
        button, .play-btn, .select-btn, .remove-btn {
            min-height: 44px;
            min-width: 44px;
        }

        /* Hide scrollbar on iOS */
        .music-grid::-webkit-scrollbar,
        .main-content::-webkit-scrollbar,
        .file-list::-webkit-scrollbar {
            display: none;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="header">
            <h1>🎵 Beat-Sync Maker</h1>
            <p>AI-Powered Music Synchronization</p>
        </div>

        <!-- Workflow Steps -->
        <div class="workflow-steps">
            <div class="step active" id="step1" onclick="goToStep(1)">
                <div class="step-number">1</div>
                <div class="step-title">Music</div>
                <div class="step-desc">Choose</div>
            </div>
            <div class="step" id="step2" onclick="goToStep(2)">
                <div class="step-number">2</div>
                <div class="step-title">Visuals</div>
                <div class="step-desc">Upload</div>
            </div>
            <div class="step" id="step3" onclick="goToStep(3)">
                <div class="step-number">3</div>
                <div class="step-title">Effects</div>
                <div class="step-desc">Customize</div>
            </div>
            <div class="step" id="step4" onclick="goToStep(4)">
                <div class="step-number">4</div>
                <div class="step-title">Generate</div>
                <div class="step-desc">Create</div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Step 1: Choose Music -->
            <div class="step-content active" id="content1">
                <h3 class="section-title">🎵 Choose Your Music</h3>
                
                <div class="selection-instructions">
                    <strong>🎯 How to Select:</strong><br>
                    • Tap ▶ to preview tracks<br>
                    • Tap "Select Track" to choose<br>
                    • Or upload your own music below
                </div>

                <div class="search-container">
                    <input type="text" class="search-input" id="musicSearch" placeholder="Search dance, EDM, house..." />
                    <div class="search-row">
                        <select class="genre-filter" id="genreFilter">
                            <option value="">All Genres</option>
                            <option value="electronic">Electronic</option>
                            <option value="dance">Dance</option>
                            <option value="edm">EDM</option>
                            <option value="house">House</option>
                            <option value="techno">Techno</option>
                            <option value="dubstep">Dubstep</option>
                            <option value="trap">Trap</option>
                        </select>
                        <button class="search-btn" onclick="searchMusic()">🔍</button>
                    </div>
                </div>

                <div class="music-grid" id="musicGrid">
                    <!-- Music cards will be populated here -->
                </div>

                <div style="text-align: center; margin: 20px 0; font-weight: 600; opacity: 0.8;">
                    -- OR --
                </div>

                <div class="upload-section">
                    <div class="upload-area" id="audioUploadArea" onclick="document.getElementById('audioFile').click()">
                        <input type="file" id="audioFile" accept="audio/*,video/*">
                        <div class="upload-icon">🎵</div>
                        <h4>Upload Your Music</h4>
                        <p>Tap to upload (.mp3, .wav, .m4a)</p>
                    </div>
                </div>

                <button class="next-step-btn" id="nextStep1" onclick="nextStep()" disabled>
                    ➡️ Next: Add Visuals
                </button>
            </div>

            <!-- Step 2: Add Visuals -->
            <div class="step-content" id="content2">
                <h3 class="section-title">🎬 Add Visual Content</h3>
                
                <div class="selection-instructions">
                    <strong>📁 Upload Tips:</strong><br>
                    • Add 3-10 files for best variety<br>
                    • AI switches content on beat drops<br>
                    • Images and videos both supported
                </div>

                <div class="upload-section">
                    <div class="upload-area" id="mediaUploadArea" onclick="document.getElementById('mediaFile').click()">
                        <input type="file" id="mediaFile" accept="image/*,video/*" multiple>
                        <div class="upload-icon">🎬</div>
                        <h4>Upload Images & Videos</h4>
                        <p>Tap to select multiple files</p>
                    </div>
                </div>

                <div class="file-list" id="uploadedFiles"></div>

                <div class="button-row">
                    <button class="next-step-btn" style="flex: 1; background: linear-gradient(45deg, #95a5a6, #7f8c8d);" onclick="prevStep()">
                        ⬅️ Back
                    </button>
                    <button class="next-step-btn" style="flex: 1;" id="nextStep2" onclick="nextStep()">
                        ➡️ Next
                    </button>
                </div>
            </div>

            <!-- Step 3: Set Effects -->
            <div class="step-content" id="content3">
                <h3 class="section-title">⚡ Customize Effects</h3>
                
                <div class="selection-instructions">
                    <strong>🎛️ Effect Settings:</strong><br>
                    • Auto-Detect chooses best effects<br>
                    • Higher intensity = more dramatic<br>
                    • Adjust for your music style
                </div>

                <div class="controls-grid">
                    <div class="control-group">
                        <label>🎭 Effect Style</label>
                        <select id="effectStyle">
                            <option value="auto">🤖 Auto-Detect</option>
                            <option value="electronic">⚡ Electronic/EDM</option>
                            <option value="hip-hop">🎤 Hip-Hop/Rap</option>
                            <option value="pop">💫 Pop/Dance</option>
                            <option value="chill">🌊 Chill/Ambient</option>
                            <option value="trap">🔥 Trap/Bass</option>
                        </select>
                    </div>
                    
                    <div class="control-group">
                        <label>⚡ Effect Intensity: <span id="intensityValue">7</span></label>
                        <input type="range" id="intensity" min="1" max="10" value="7" oninput="updateSliderValue('intensity', 'intensityValue')">
                    </div>
                    
                    <div class="control-group">
                        <label>⏱️ Clip Duration (seconds)</label>
                        <input type="number" id="duration" min="5" max="60" value="15">
                    </div>
                    
                    <div class="control-group">
                        <label>🎯 Beat Sensitivity: <span id="sensitivityValue">6</span></label>
                        <input type="range" id="sensitivity" min="1" max="10" value="6" oninput="updateSliderValue('sensitivity', 'sensitivityValue')">
                    </div>
                </div>

                <div class="button-row">
                    <button class="next-step-btn" style="flex: 1; background: linear-gradient(45deg, #95a5a6, #7f8c8d);" onclick="prevStep()">
                        ⬅️ Back
                    </button>
                    <button class="next-step-btn" style="flex: 1;" id="nextStep3" onclick="nextStep()">
                        ➡️ Next
                    </button>
                </div>
            </div>

            <!-- Step 4: Generate -->
            <div class="step-content" id="content4">
                <h3 class="section-title">🚀 Generate Clip</h3>
                
                <div class="selection-instructions">
                    <strong>✨ Ready to Create:</strong><br>
                    • AI analyzes your music's rhythm<br>
                    • Effects sync automatically to beats<br>
                    • Content switches on beat drops
                </div>

                <button class="generate-btn" id="generateBtn" onclick="generateClip()">
                    🎬 Generate Beat-Synced Clip
                </button>

                <button class="next-step-btn" style="background: linear-gradient(45deg, #95a5a6, #7f8c8d); margin-top: 15px;" onclick="prevStep()">
                    ⬅️ Back to Effects
                </button>
            </div>

            <!-- Preview Section -->
            <div class="preview-section">
                <h3 style="margin-bottom: 15px; font-size: 1.2rem;">👀 Live Preview</h3>
                <div class="preview-container">
                    <div class="preview-content" id="previewContent">
                        🎵 Your beat-synced clip will appear here...<br><br>Complete steps above to start!
                    </div>
                    <div class="effect-overlay" id="effectOverlay"></div>
                    <div class="beat-indicator" id="beatIndicator">♪</div>
                    <div class="audio-visualizer" id="audioVisualizer"></div>
                </div>
                <div class="status" id="status">🎵 Welcome! Follow the steps to create your masterpiece!</div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global state
        let currentStep = 1;
        let selectedMusic = null;
        let currentAudio = null;
        let currentMedia = [];
        let currentPreviewAudio = null;
        let isPlaying = false;
        let audioContext, analyser, audioSource, beatDetector, effectsEngine;

        // Sample music database
        const freeMusicDatabase = [
            {
                id: 1,
                title: "Electric Dreams",
                artist: "SynthWave Pro",
                genre: "electronic",
                bpm: 128,
                duration: "3:45",
                previewUrl: "https://www2.cs.uic.edu/~i101/SoundFiles/BabyElephantWalk60.wav",
                tags: ["edm", "electronic", "dance"]
            },
            {
                id: 2,
                title: "Bass Revolution",
                artist: "EDM Master",
                genre: "dubstep",
                bpm: 140,
                duration: "4:12",
                previewUrl: "https://www2.cs.uic.edu/~i101/SoundFiles/CantinaBand60.wav",
                tags: ["dubstep", "bass", "electronic"]
            },
            {
                id: 3,
                title: "House Vibes",
                artist: "Deep House",
                genre: "house",
                bpm: 124,
                duration: "5:30",
                previewUrl: "https://www2.cs.uic.edu/~i101/SoundFiles/ImperialMarch60.wav",
                tags: ["house", "dance", "party"]
            },
            {
                id: 4,
                title: "Techno Beat",
                artist: "Cyber Beats",
                genre: "techno",
                bpm: 132,
                duration: "6:15",
                previewUrl: "https://www2.cs.uic.edu/~i101/SoundFiles/StarWars60.wav",
                tags: ["techno", "underground"]
            },
            {
                id: 5,
                title: "Trap Energy",
                artist: "Urban Sound",
                genre: "trap",
                bpm: 150,
                duration: "3:20",
                previewUrl: "https://www2.cs.uic.edu/~i101/SoundFiles/gettysburg10.wav",
                tags: ["trap", "hip-hop", "urban"]
            }
        ];

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            initAudioVisualizer();
            loadMusicLibrary();
            setupEventListeners();
            updateStepAvailability();
            
            // Prevent zoom on double tap
            let lastTouchEnd = 0;
            document.addEventListener('touchend', function (event) {
                const now = (new Date()).getTime();
                if (now - lastTouchEnd <= 300) {
                    event.preventDefault();
                }
                lastTouchEnd = now;
            }, false);
            
            // Prevent scroll bounce
            document.addEventListener('touchmove', function(e) {
                if (e.target.closest('.main-content, .music-grid, .file-list')) {
                    return;
                }
                e.preventDefault();
            }, { passive: false });
        });

        function setupEventListeners() {
            document.getElementById('audioFile').addEventListener('change', handleAudioUpload);
            document.getElementById('mediaFile').addEventListener('change', handleMediaUpload);
            document.getElementById('musicSearch').addEventListener('input', debounce(searchMusic, 300));
            document.getElementById('genreFilter').addEventListener('change', searchMusic);
        }

        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Step navigation
        function goToStep(step) {
            if (step <= currentStep || isStepCompleted(step - 1)) {
                showStep(step);
            }
        }

        function nextStep() {
            if (currentStep < 4) {
                markStepCompleted(currentStep);
                currentStep++;
                showStep(currentStep);
                updateStepAvailability();
            }
        }

        function prevStep() {
            if (currentStep > 1) {
                currentStep--;
                showStep(currentStep);
            }
        }

        function showStep(step) {
            document.querySelectorAll('.step-content').forEach(content => {
                content.classList.remove('active');
            });
            
            document.getElementById(`content${step}`).classList.add('active');
            
            document.querySelectorAll('.step').forEach((stepEl, index) => {
                stepEl.classList.remove('active');
                if (index + 1 === step) {
                    stepEl.classList.add('active');
                }
            });
            
            currentStep = step;
            
            // Scroll to top
            document.querySelector('.main-content').scrollTop = 0;
        }

        function markStepCompleted(step) {
            document.getElementById(`step${step}`).classList.add('completed');
        }

        function isStepCompleted(step) {
            return document.getElementById(`step${step}`).classList.contains('completed');
        }

        function updateStepAvailability() {
            const hasMusic = selectedMusic || currentAudio;
            document.getElementById('nextStep1').disabled = !hasMusic;
            if (hasMusic) {
                document.getElementById('nextStep1').innerHTML = '➡️ Next: Add Visuals ✓';
            }
        }

        // Music functions
        function loadMusicLibrary() {
            searchMusic();
        }

        function searchMusic() {
            const searchTerm = document.getElementById('musicSearch').value.toLowerCase();
            const genreFilter = document.getElementById('genreFilter').value;
            
            let filteredMusic = freeMusicDatabase.filter(track => {
                const matchesSearch = track.title.toLowerCase().includes(searchTerm) ||
                                    track.artist.toLowerCase().includes(searchTerm) ||
                                    track.tags.some(tag => tag.toLowerCase().includes(searchTerm));
                
                const matchesGenre = !genreFilter || track.genre === genreFilter;
                
                return matchesSearch && matchesGenre;
            });

            renderMusicGrid(filteredMusic);
        }

        function renderMusicGrid(tracks) {
            const grid = document.getElementById('musicGrid');
            grid.innerHTML = '';

            if (tracks.length === 0) {
                grid.innerHTML = '<p style="text-align: center; opacity: 0.7; padding: 20px;">No tracks found. Try different search terms!</p>';
                return;
            }

            tracks.forEach(track => {
                const card = createMusicCard(track);
                grid.appendChild(card);
            });
        }

        function createMusicCard(track) {
            const card = document.createElement('div');
            card.className = 'music-card';
            card.onclick = () => selectMusic(track, card);

            card.innerHTML = `
                <div class="music-info">
                    <h4>${track.title}</h4>
                    <p>by ${track.artist}</p>
                    <p>${track.genre.toUpperCase()} • ${track.bpm} BPM • ${track.duration}</p>
                </div>
                <div class="music-controls">
                    <button class="play-btn" onclick="event.stopPropagation(); togglePreview('${track.previewUrl}', this, '${track.id}')">▶</button>
                    <div class="waveform">
                        <div class="waveform-progress" id="progress-${track.id}"></div>
                        <div class="waveform-time" id="time-${track.id}">0:00</div>
                    </div>
                    <button class="select-btn" onclick="event.stopPropagation(); selectMusic('${JSON.stringify(track).replace(/'/g, "\\'")}', this.closest('.music-card'))">
                        Select
                    </button>
                </div>
            `;

            return card;
        }

        function togglePreview(url, button, trackId) {
            // Stop any currently playing preview
            if (currentPreviewAudio && !currentPreviewAudio.paused) {
                currentPreviewAudio.pause();
                currentPreviewAudio.currentTime = 0;
                
                document.querySelectorAll('.play-btn').forEach(btn => {
                    btn.innerHTML = '▶';
                    btn.classList.remove('playing');
                });
                
                document.querySelectorAll('.music-card').forEach(card => {
                    card.classList.remove('playing');
                });
            }

            if (currentPreviewAudio && currentPreviewAudio.src === url && button.innerHTML === '▶') {
                return;
            }

            // Play new track
            currentPreviewAudio = new Audio(url);
            currentPreviewAudio.volume = 0.7;
            
            button.innerHTML = '⏸';
            button.classList.add('playing');
            button.closest('.music-card').classList.add('playing');
            
            currentPreviewAudio.ontimeupdate = () => {
                const progress = (currentPreviewAudio.currentTime / currentPreviewAudio.duration) * 100;
                const progressBar = document.getElementById(`progress-${trackId}`);
                const timeDisplay = document.getElementById(`time-${trackId}`);
                
                if (progressBar) progressBar.style.width = progress + '%';
                if (timeDisplay) {
                    const minutes = Math.floor(currentPreviewAudio.currentTime / 60);
                    const seconds = Math.floor(currentPreviewAudio.currentTime % 60);
                    timeDisplay.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
                }
            };
            
            currentPreviewAudio.onended = () => {
                button.innerHTML = '▶';
                button.classList.remove('playing');
                button.closest('.music-card').classList.remove('playing');
                document.getElementById(`progress-${trackId}`).style.width = '0%';
                document.getElementById(`time-${trackId}`).textContent = '0:00';
            };
            
            currentPreviewAudio.play().catch(e => {
                console.warn('Could not play preview:', e);
                updateStatus('⚠️ Preview not available');
                button.innerHTML = '▶';
                button.classList.remove('playing');
                button.closest('.music-card').classList.remove('playing');
            });
        }

        function selectMusic(track, cardElement) {
            if (typeof track === 'string') {
                track = JSON.parse(track);
            }
            
            if (currentPreviewAudio && !currentPreviewAudio.paused) {
                currentPreviewAudio.pause();
                currentPreviewAudio.currentTime = 0;
            }
            
            document.querySelectorAll('.play-btn').forEach(btn => {
                btn.innerHTML = '▶';
                btn.classList.remove('playing');
            });
            document.querySelectorAll('.music-card').forEach(card => {
                card.classList.remove('selected', 'playing');
            });
            document.querySelectorAll('.select-btn').forEach(btn => {
                btn.textContent = 'Select';
                btn.classList.remove('selected');
            });
            
            cardElement.classList.add('selected');
            const selectBtn = cardElement.querySelector('.select-btn');
            selectBtn.textContent = 'Selected ✓';
            selectBtn.classList.add('selected');
            
            selectedMusic = track;
            currentAudio = null;
            
            updateStatus(`🎵 Selected: ${track.title}`);
            updateStepAvailability();
            
            loadSelectedMusic(track);
        }

        async function loadSelectedMusic(track) {
            try {
                const response = await fetch(track.previewUrl);
                currentAudio = await response.blob();
                updateStatus(`✅ Loaded: ${track.title} - Ready!`);
            } catch (error) {
                updateStatus(`❌ Error loading: ${track.title}`);
            }
        }

        // File upload handlers
        async function handleAudioUpload(event) {
            const files = Array.from(event.target.files);
            if (files.length > 0) {
                const file = files[0];
                currentAudio = file;
                selectedMusic = null;
                
                document.querySelectorAll('.music-card').forEach(card => {
                    card.classList.remove('selected');
                });
                document.querySelectorAll('.select-btn').forEach(btn => {
                    btn.textContent = 'Select';
                    btn.classList.remove('selected');
                });
                
                const uploadArea = document.getElementById('audioUploadArea');
                uploadArea.classList.add('has-files');
                uploadArea.innerHTML = `
                    <div class="upload-icon">✅</div>
                    <h4>Audio Uploaded</h4>
                    <p>${file.name}</p>
                    <button class="remove-btn" onclick="removeCustomAudio()" style="margin-top: 10px;">Remove</button>
                `;
                
                updateStatus(`🎵 Custom audio: ${file.name}`);
                updateStepAvailability();
            }
        }

        function removeCustomAudio() {
            currentAudio = null;
            selectedMusic = null;
            
            const uploadArea = document.getElementById('audioUploadArea');
            uploadArea.classList.remove('has-files');
            uploadArea.innerHTML = `
                <input type="file" id="audioFile" accept="audio/*,video/*">
                <div class="upload-icon">🎵</div>
                <h4>Upload Your Music</h4>
                <p>Tap to upload (.mp3, .wav, .m4a)</p>
            `;
            
            document.getElementById('audioFile').addEventListener('change', handleAudioUpload);
            
            updateStatus('🎵 Audio removed');
            updateStepAvailability();
        }

        async function handleMediaUpload(event) {
            const files = Array.from(event.target.files);
            currentMedia = [...currentMedia, ...files];
            
            const uploadArea = document.getElementById('mediaUploadArea');
            uploadArea.classList.add('has-files');
            
            updateStatus(`🎬 ${files.length} files added (Total: ${currentMedia.length})`);
            displayUploadedFiles();
        }

        function displayUploadedFiles() {
            const container = document.getElementById('uploadedFiles');
            container.innerHTML = '';

            if (currentMedia.length === 0) return;

            const header = document.createElement('h4');
            header.textContent = `📁 Files (${currentMedia.length})`;
            header.style.marginBottom = '10px';
            header.style.fontSize = '1rem';
            container.appendChild(header);

            currentMedia.forEach((file, index) => {
                const item = document.createElement('div');
                item.className = 'file-item';
                item.innerHTML = `
                    <span>${file.type.startsWith('image/') ? '🖼️' : '🎬'} ${file.name.length > 25 ? file.name.substring(0, 25) + '...' : file.name}</span>
                    <button class="remove-btn" onclick="removeMedia(${index})">Remove</button>
                `;
                container.appendChild(item);
            });
        }

        function removeMedia(index) {
            currentMedia.splice(index, 1);
            displayUploadedFiles();
            
            if (currentMedia.length === 0) {
                document.getElementById('mediaUploadArea').classList.remove('has-files');
            }
            
            updateStatus(`🎬 File removed (${currentMedia.length} remaining)`);
        }

        // Audio visualizer
        function initAudioVisualizer() {
            const visualizer = document.getElementById('audioVisualizer');
            for (let i = 0; i < 32; i++) {
                const bar = document.createElement('div');
                bar.className = 'audio-bar';
                bar.style.height = '3px';
                visualizer.appendChild(bar);
            }
        }

        // Beat Detection Engine
        class BeatDetector {
            constructor(audioContext, analyser) {
                this.audioContext = audioContext;
                this.analyser = analyser;
                this.bufferSize = analyser.frequencyBinCount;
                this.dataArray = new Uint8Array(this.bufferSize);
                this.lastBeatTime = 0;
                this.beatThreshold = 0.4;
            }

            detectBeat() {
                this.analyser.getByteFrequencyData(this.dataArray);
                
                const bassEnergy = this.getFrequencyRangeEnergy([0, 8]);
                const midEnergy = this.getFrequencyRangeEnergy([8, 24]);
                const highEnergy = this.getFrequencyRangeEnergy([24, 64]);
                
                const totalEnergy = bassEnergy + midEnergy + highEnergy;
                const normalizedEnergy = totalEnergy / 255;
                
                const now = this.audioContext.currentTime;
                const timeSinceLastBeat = now - this.lastBeatTime;
                
                let beatDetected = false;
                if (normalizedEnergy > this.beatThreshold && timeSinceLastBeat > 0.2) {
                    beatDetected = true;
                    this.lastBeatTime = now;
                }
                
                return {
                    detected: beatDetected,
                    energy: normalizedEnergy,
                    bass: bassEnergy / 255,
                    mid: midEnergy / 255,
                    high: highEnergy / 255
                };
            }

            getFrequencyRangeEnergy(range) {
                let energy = 0;
                for (let i = range[0]; i < Math.min(range[1], this.dataArray.length); i++) {
                    energy += this.dataArray[i];
                }
                return energy / (range[1] - range[0]);
            }
        }

        // Effects Engine
        class EffectsEngine {
            constructor() {
                this.previewContent = document.getElementById('previewContent');
                this.effectOverlay = document.getElementById('effectOverlay');
                this.beatIndicator = document.getElementById('beatIndicator');
                this.mediaIndex = 0;
            }

            applyBeatEffect(beatData) {
                if (!beatData.detected) return;

                this.beatIndicator.classList.add('beat-active');
                setTimeout(() => {
                    this.beatIndicator.classList.remove('beat-active');
                }, 300);

                if (beatData.bass > 0.7) {
                    this.previewContent.classList.add('effect-zoom');
                    setTimeout(() => {
                        this.previewContent.classList.remove('effect-zoom');
                    }, 600);
                } else if (beatData.high > 0.6) {
                    this.previewContent.classList.add('effect-flash');
                    setTimeout(() => {
                        this.previewContent.classList.remove('effect-flash');
                    }, 400);
                } else {
                    this.previewContent.classList.add('effect-shake');
                    setTimeout(() => {
                        this.previewContent.classList.remove('effect-shake');
                    }, 400);
                }

                if (beatData.energy > 0.8 && currentMedia.length > 1) {
                    this.switchMedia();
                }
            }

            switchMedia() {
                if (currentMedia.length === 0) return;
                
                this.mediaIndex = (this.mediaIndex + 1) % currentMedia.length;
                const file = currentMedia[this.mediaIndex];
                
                if (file.type.startsWith('image/')) {
                    const img = document.createElement('img');
                    img.src = URL.createObjectURL(file);
                    img.className = 'preview-media';
                    this.previewContent.innerHTML = '';
                    this.previewContent.appendChild(img);
                } else if (file.type.startsWith('video/')) {
                    const video = document.createElement('video');
                    video.src = URL.createObjectURL(file);
                    video.className = 'preview-media';
                    video.muted = true;
                    video.loop = true;
                    video.autoplay = true;
                    video.playsInline = true;
                    this.previewContent.innerHTML = '';
                    this.previewContent.appendChild(video);
                }
            }
        }

        // Generate function
        async function generateClip() {
            if (!currentAudio && !selectedMusic) {
                updateStatus('❌ Please select music from Step 1!');
                goToStep(1);
                return;
            }

            const generateBtn = document.getElementById('generateBtn');
            generateBtn.disabled = true;
            generateBtn.innerHTML = '<span class="loading-spinner"></span> Creating Magic...';

            try {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                analyser = audioContext.createAnalyser();
                analyser.fftSize = 256;
                
                const audioElement = document.createElement('audio');
                audioElement.src = URL.createObjectURL(currentAudio);
                audioElement.crossOrigin = 'anonymous';
                
                audioSource = audioContext.createMediaElementSource(audioElement);
                audioSource.connect(analyser);
                analyser.connect(audioContext.destination);
                
                beatDetector = new BeatDetector(audioContext, analyser);
                effectsEngine = new EffectsEngine();
                
                if (currentMedia.length > 0) {
                    effectsEngine.switchMedia();
                } else {
                    const defaultDiv = document.createElement('div');
                    defaultDiv.style.cssText = `
                        width: 100%; height: 100%;
                        background: linear-gradient(45deg, #667eea, #764ba2);
                        display: flex; align-items: center; justify-content: center;
                        color: white; font-size: 2rem; text-align: center;
                        padding: 20px;
                    `;
                    defaultDiv.innerHTML = '🎵<br>Visualizer';
                    document.getElementById('previewContent').innerHTML = '';
                    document.getElementById('previewContent').appendChild(defaultDiv);
                }
                
                await audioElement.play();
                isPlaying = true;
                
                updateStatus('🎵 AI analyzing and syncing...');
                
                function animate() {
                    if (!isPlaying) return;
                    
                    const beatData = beatDetector.detectBeat();
                    effectsEngine.applyBeatEffect(beatData);
                    updateAudioVisualizer();
                    updateProgress(audioElement);
                    
                    requestAnimationFrame(animate);
                }
                
                animate();
                
                const duration = parseInt(document.getElementById('duration').value) * 1000;
                setTimeout(() => {
                    audioElement.pause();
                    isPlaying = false;
                    updateStatus('✅ Beat-synced clip completed! 🎉');
                    generateBtn.disabled = false;
                    generateBtn.innerHTML = '🎬 Generate Beat-Synced Clip';
                    markStepCompleted(4);
                }, duration);
                
            } catch (error) {
                console.error('Error:', error);
                updateStatus('❌ Error generating clip. Try again.');
                generateBtn.disabled = false;
                generateBtn.innerHTML = '🎬 Generate Beat-Synced Clip';
            }
        }

        function updateAudioVisualizer() {
            if (!analyser) return;
            
            const dataArray = new Uint8Array(analyser.frequencyBinCount);
            analyser.getByteFrequencyData(dataArray);
            
            const bars = document.querySelectorAll('.audio-bar');
            const step = Math.floor(dataArray.length / bars.length);
            
            bars.forEach((bar, index) => {
                const value = dataArray[index * step];
                const height = Math.max(2, (value / 255) * 50);
                bar.style.height = height + 'px';
            });
        }

        function updateProgress(audioElement) {
            if (audioElement.duration) {
                const progress = (audioElement.currentTime / audioElement.duration) * 100;
                document.getElementById('progressFill').style.width = progress + '%';
            }
        }

        function updateSliderValue(sliderId, displayId) {
            const value = document.getElementById(sliderId).value;
            document.getElementById(displayId).textContent = value;
        }

        function updateStatus(message) {
            document.getElementById('status').innerHTML = message;
        }

        // Initialize
        updateStatus('🎵 Welcome! Start with Step 1 to begin!');
    </script>
</body>
</html>
