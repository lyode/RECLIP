<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#667eea">
    <title>Beat-Sync Clip Maker Pro</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
        }

        html, body {
            height: 100vh;
            height: 100dvh;
            overflow: hidden;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            position: fixed;
            width: 100%;
        }

        .app-container {
            height: 100vh;
            height: 100dvh;
            display: flex;
            flex-direction: column;
            padding-top: env(safe-area-inset-top);
            padding-bottom: env(safe-area-inset-bottom);
            padding-left: env(safe-area-inset-left);
            padding-right: env(safe-area-inset-right);
        }

        .header {
            text-align: center;
            padding: 15px 20px 10px;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            position: relative;
        }

        .header h1 {
            font-size: 1.8rem;
            font-weight: 700;
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4, #45b7d1);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 5px;
        }

        .header p {
            font-size: 0.85rem;
            opacity: 0.9;
            line-height: 1.2;
        }

        .settings-btn {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(255, 255, 255, 0.2);
            border: none;
            border-radius: 12px;
            color: white;
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 1.2rem;
            transition: all 0.3s ease;
        }

        .settings-btn:active {
            transform: translateY(-50%) scale(0.95);
            background: rgba(255, 255, 255, 0.3);
        }

        .subscription-status {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            background: linear-gradient(45deg, #00b894, #55a3ff);
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 0.7rem;
            font-weight: 600;
            cursor: pointer;
        }

        .subscription-status.free {
            background: rgba(255, 255, 255, 0.2);
        }

        .subscription-status.premium {
            background: linear-gradient(45deg, #f9ca24, #f0932b);
        }

        .subscription-status.pro {
            background: linear-gradient(45deg, #ff6b6b, #ee5a24);
        }

        .workflow-steps {
            display: flex;
            padding: 15px 10px;
            gap: 8px;
            background: rgba(255, 255, 255, 0.05);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        .step {
            background: rgba(255, 255, 255, 0.1);
            padding: 12px 8px;
            border-radius: 12px;
            border: 2px solid transparent;
            transition: all 0.3s ease;
            min-width: 85px;
            text-align: center;
            cursor: pointer;
            flex-shrink: 0;
        }

        .step.active {
            border-color: #4ecdc4;
            background: rgba(78, 205, 196, 0.3);
            transform: scale(1.05);
        }

        .step.completed {
            border-color: #00b894;
            background: rgba(0, 184, 148, 0.3);
        }

        .step-number {
            background: #4ecdc4;
            color: white;
            width: 26px;
            height: 26px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 8px;
            font-weight: bold;
            font-size: 0.9rem;
        }

        .step.completed .step-number {
            background: #00b894;
        }

        .step-title {
            font-size: 0.75rem;
            font-weight: 600;
            margin-bottom: 2px;
        }

        .step-desc {
            font-size: 0.65rem;
            opacity: 0.8;
        }

        .main-content {
            flex: 1;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            padding: 20px 15px;
        }

        .step-content {
            display: none;
        }

        .step-content.active {
            display: block;
        }

        .section-title {
            font-size: 1.3rem;
            margin-bottom: 15px;
            font-weight: 600;
        }

        .selection-instructions {
            background: rgba(255, 255, 255, 0.15);
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 20px;
            border-left: 4px solid #4ecdc4;
            font-size: 0.85rem;
            line-height: 1.4;
        }

        .music-tier-tabs {
            display: flex;
            margin-bottom: 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 4px;
            gap: 4px;
        }

        .tier-tab {
            flex: 1;
            padding: 12px 8px;
            text-align: center;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.8rem;
            font-weight: 600;
            position: relative;
        }

        .tier-tab.active {
            background: rgba(255, 255, 255, 0.2);
        }

        .tier-tab.locked {
            opacity: 0.6;
        }

        .tier-tab .lock-icon {
            font-size: 0.7rem;
            margin-left: 4px;
        }

        .tier-tab .tier-price {
            font-size: 0.6rem;
            opacity: 0.8;
            margin-top: 2px;
        }

        .search-container {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 20px;
        }

        .search-input {
            width: 100%;
            padding: 14px 15px;
            border-radius: 12px;
            border: none;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            font-size: 1rem;
            outline: none;
        }

        .search-input::placeholder {
            color: rgba(255, 255, 255, 0.7);
        }

        .search-row {
            display: flex;
            gap: 10px;
        }

        .genre-filter {
            flex: 1;
            padding: 14px 15px;
            border-radius: 12px;
            border: none;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            font-size: 0.9rem;
            outline: none;
        }

        .genre-filter option {
            background: #333;
            color: white;
        }

        .search-btn {
            padding: 14px 20px;
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
            border: none;
            border-radius: 12px;
            color: white;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.9rem;
            min-width: 80px;
        }

        .music-grid {
            display: flex;
            flex-direction: column;
            gap: 15px;
            max-height: 400px;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            padding: 5px;
        }

        .music-card {
            background: rgba(255, 255, 255, 0.15);
            border-radius: 15px;
            padding: 18px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 3px solid transparent;
            position: relative;
        }

        .music-card:active {
            transform: scale(0.98);
        }

        .music-card.selected {
            border-color: #ff6b6b;
            background: rgba(255, 107, 107, 0.25);
            box-shadow: 0 0 20px rgba(255, 107, 107, 0.3);
        }

        .music-card.playing {
            border-color: #f9ca24;
            background: rgba(249, 202, 36, 0.25);
            animation: pulse 2s infinite;
        }

        .music-card.locked {
            opacity: 0.6;
            background: rgba(255, 255, 255, 0.1);
        }

        .music-card.locked::after {
            content: 'üîí';
            position: absolute;
            top: 15px;
            right: 15px;
            font-size: 1.2rem;
        }

        @keyframes pulse {
            0%, 100% { box-shadow: 0 0 20px rgba(249, 202, 36, 0.3); }
            50% { box-shadow: 0 0 30px rgba(249, 202, 36, 0.6); }
        }

        .music-info h4 {
            margin-bottom: 8px;
            color: #fff;
            font-size: 1.1rem;
            font-weight: 600;
        }

        .music-info p {
            color: rgba(255, 255, 255, 0.8);
            font-size: 0.85rem;
            margin-bottom: 5px;
            line-height: 1.3;
        }

        .music-tier-badge {
            position: absolute;
            top: 15px;
            right: 15px;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.6rem;
            font-weight: 600;
        }

        .music-tier-badge.free {
            background: rgba(255, 255, 255, 0.2);
        }

        .music-tier-badge.premium {
            background: linear-gradient(45deg, #f9ca24, #f0932b);
        }

        .music-tier-badge.pro {
            background: linear-gradient(45deg, #ff6b6b, #ee5a24);
        }

        .music-controls {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-top: 15px;
        }

        .play-btn {
            background: #4ecdc4;
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: white;
            font-size: 18px;
            transition: all 0.3s ease;
            flex-shrink: 0;
        }

        .play-btn:active {
            transform: scale(0.95);
        }

        .play-btn.playing {
            background: #f9ca24;
            animation: playingPulse 1s infinite;
        }

        .play-btn:disabled {
            background: #95a5a6;
            cursor: not-allowed;
        }

        @keyframes playingPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .waveform {
            flex: 1;
            height: 40px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            position: relative;
            overflow: hidden;
            display: flex;
            align-items: center;
            padding: 0 12px;
        }

        .waveform-progress {
            height: 70%;
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
            border-radius: 15px;
            width: 0%;
            transition: width 0.1s ease;
        }

        .waveform-time {
            position: absolute;
            right: 12px;
            font-size: 0.75rem;
            color: rgba(255, 255, 255, 0.9);
            z-index: 2;
            font-weight: 500;
        }

        .select-btn {
            background: linear-gradient(45deg, #00b894, #55a3ff);
            border: none;
            border-radius: 12px;
            color: white;
            padding: 12px 16px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.85rem;
            transition: all 0.3s ease;
            min-height: 44px;
        }

        .select-btn:active {
            transform: scale(0.95);
        }

        .select-btn.selected {
            background: linear-gradient(45deg, #ff6b6b, #ff8e8e);
        }

        .select-btn:disabled {
            background: #95a5a6;
            cursor: not-allowed;
        }

        .upgrade-btn {
            background: linear-gradient(45deg, #f9ca24, #f0932b);
            border: none;
            border-radius: 12px;
            color: white;
            padding: 12px 16px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.85rem;
            transition: all 0.3s ease;
            min-height: 44px;
        }

        .upgrade-btn:active {
            transform: scale(0.95);
        }

        .upload-section {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 20px;
        }

        .upload-area {
            border: 3px dashed rgba(255, 255, 255, 0.5);
            border-radius: 15px;
            padding: 30px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            min-height: 140px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .upload-area:active {
            transform: scale(0.98);
        }

        .upload-area.has-files {
            border-color: #00b894;
            background: rgba(0, 184, 148, 0.15);
        }

        .upload-area input {
            position: absolute;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }

        .upload-icon {
            font-size: 2.5rem;
            margin-bottom: 12px;
            opacity: 0.8;
        }

        .upload-area h4 {
            font-size: 1.1rem;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .upload-area p {
            font-size: 0.85rem;
            opacity: 0.8;
            line-height: 1.3;
        }

        .controls-grid {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 20px;
        }

        .control-group {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .control-group label {
            display: block;
            margin-bottom: 10px;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .control-group select,
        .control-group input {
            width: 100%;
            padding: 12px;
            border-radius: 10px;
            border: none;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            font-size: 1rem;
            outline: none;
        }

        .control-group input[type="range"] {
            padding: 0;
            height: 44px;
            -webkit-appearance: none;
            background: transparent;
        }

        .control-group input[type="range"]::-webkit-slider-track {
            background: rgba(255, 255, 255, 0.3);
            height: 6px;
            border-radius: 3px;
        }

        .control-group input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 24px;
            width: 24px;
            border-radius: 50%;
            background: #4ecdc4;
            cursor: pointer;
            margin-top: -9px;
        }

        .control-group select option {
            background: #333;
            color: white;
        }

        .next-step-btn {
            width: 100%;
            padding: 18px;
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
            border: none;
            border-radius: 12px;
            color: white;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 20px;
            min-height: 56px;
        }

        .next-step-btn:active {
            transform: scale(0.98);
        }

        .next-step-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .generate-btn {
            width: 100%;
            padding: 20px;
            background: linear-gradient(45deg, #00b894, #55a3ff);
            border: none;
            border-radius: 12px;
            color: white;
            font-size: 1.2rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 20px;
            min-height: 60px;
        }

        .generate-btn:active {
            transform: scale(0.98);
        }

        .generate-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .button-row {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .button-row .next-step-btn {
            margin-top: 0;
        }

        .preview-section {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            margin-top: 20px;
        }

        .preview-container {
            position: relative;
            width: 100%;
            aspect-ratio: 16/9;
            background: #000;
            border-radius: 12px;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 15px;
        }

        .preview-content {
            width: 100%;
            height: 100%;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
            text-align: center;
            padding: 20px;
        }

        .preview-media {
            max-width: 100%;
            max-height: 100%;
            object-fit: cover;
            border-radius: 8px;
        }

        .effect-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 10;
        }

        .audio-visualizer {
            position: absolute;
            bottom: 10px;
            left: 10px;
            right: 10px;
            height: 60px;
            display: flex;
            align-items: end;
            gap: 2px;
            z-index: 15;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 8px;
            padding: 8px;
        }

        .audio-bar {
            flex: 1;
            background: linear-gradient(to top, #ff6b6b, #4ecdc4, #45b7d1);
            border-radius: 1px;
            transition: height 0.05s ease;
            opacity: 0.9;
            min-height: 2px;
        }

        .status {
            text-align: center;
            padding: 12px;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.1);
            font-weight: 500;
            font-size: 0.85rem;
            line-height: 1.3;
        }

        .beat-indicator {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 20px;
            height: 20px;
            background: #ff6b6b;
            border-radius: 50%;
            z-index: 15;
            opacity: 0;
            transition: all 0.1s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: bold;
        }

        .beat-active {
            opacity: 1;
            animation: beatPulse 0.3s ease;
            box-shadow: 0 0 15px rgba(255, 107, 107, 0.8);
        }

        @keyframes beatPulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.5); }
            100% { transform: scale(1); }
        }

        .file-list {
            margin-top: 15px;
            max-height: 200px;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        .file-item {
            background: rgba(255, 255, 255, 0.1);
            padding: 12px;
            margin-bottom: 8px;
            border-radius: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.85rem;
        }

        .remove-btn {
            background: #ff6b6b;
            border: none;
            border-radius: 8px;
            color: white;
            padding: 8px 12px;
            cursor: pointer;
            font-size: 0.75rem;
            font-weight: 500;
            min-height: 36px;
        }

        .remove-btn:active {
            transform: scale(0.95);
        }

        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .progress-bar {
            width: 100%;
            height: 6px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 3px;
            margin-top: 12px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
            width: 0%;
            transition: width 0.3s ease;
        }

        .effect-flash { animation: flashEffect 0.4s ease; }
        @keyframes flashEffect {
            0% { filter: brightness(1) contrast(1) saturate(1); }
            50% { filter: brightness(1.8) contrast(1.4) saturate(1.6) hue-rotate(30deg); }
            100% { filter: brightness(1) contrast(1) saturate(1); }
        }

        .effect-zoom { animation: zoomEffect 0.6s ease; }
        @keyframes zoomEffect {
            0% { transform: scale(1) rotate(0deg); }
            50% { transform: scale(1.15) rotate(2deg); }
            100% { transform: scale(1) rotate(0deg); }
        }

        .effect-shake { animation: shakeEffect 0.4s ease; }
        @keyframes shakeEffect {
            0%, 100% { transform: translateX(0) translateY(0); }
            25% { transform: translateX(-8px) translateY(4px); }
            75% { transform: translateX(8px) translateY(-4px); }
        }

        .particle {
            position: absolute;
            pointer-events: none;
            border-radius: 50%;
            z-index: 20;
        }

        /* Settings Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal-content {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 20px;
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow: hidden;
            position: relative;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .modal-header {
            padding: 20px;
            text-align: center;
            background: rgba(255, 255, 255, 0.1);
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            position: relative;
        }

        .modal-header h2 {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .close-btn {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .close-btn:active {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-50%) scale(0.95);
        }

        .modal-body {
            padding: 20px;
            max-height: 70vh;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        .settings-section {
            margin-bottom: 25px;
        }

        .settings-section h3 {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 15px;
            color: #4ecdc4;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .settings-grid {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .setting-item {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .setting-item label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            font-size: 0.9rem;
        }

        .setting-item input,
        .setting-item select {
            width: 100%;
            padding: 12px;
            border-radius: 8px;
            border: none;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            font-size: 1rem;
            outline: none;
        }

        .setting-item input[type="range"] {
            padding: 0;
            height: 40px;
            -webkit-appearance: none;
            background: transparent;
        }

        .setting-item input[type="range"]::-webkit-slider-track {
            background: rgba(255, 255, 255, 0.3);
            height: 6px;
            border-radius: 3px;
        }

        .setting-item input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 20px;
            width: 20px;
            border-radius: 50%;
            background: #4ecdc4;
            cursor: pointer;
            margin-top: -7px;
        }

        .setting-item select option {
            background: #333;
            color: white;
        }

        .setting-toggle {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .toggle-switch {
            position: relative;
            width: 50px;
            height: 28px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .toggle-switch.active {
            background: #4ecdc4;
        }

        .toggle-switch::after {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 24px;
            height: 24px;
            background: white;
            border-radius: 50%;
            transition: all 0.3s ease;
        }

        .toggle-switch.active::after {
            left: 24px;
        }

        .subscription-plans {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .plan-card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            border: 2px solid transparent;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .plan-card.current {
            border-color: #4ecdc4;
            background: rgba(78, 205, 196, 0.2);
        }

        .plan-card.recommended {
            border-color: #f9ca24;
            background: rgba(249, 202, 36, 0.2);
        }

        .plan-card.recommended::before {
            content: '‚≠ê RECOMMENDED';
            position: absolute;
            top: -10px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(45deg, #f9ca24, #f0932b);
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 600;
        }

        .plan-header {
            text-align: center;
            margin-bottom: 15px;
        }

        .plan-name {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .plan-price {
            font-size: 1.8rem;
            font-weight: 700;
            color: #4ecdc4;
            margin-bottom: 5px;
        }

        .plan-period {
            font-size: 0.8rem;
            opacity: 0.8;
        }

        .plan-features {
            list-style: none;
            margin-bottom: 20px;
        }

        .plan-features li {
            padding: 8px 0;
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .plan-features li::before {
            content: '‚úì';
            color: #4ecdc4;
            font-weight: bold;
        }

        .plan-btn {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .plan-btn.current {
            background: rgba(255, 255, 255, 0.2);
            color: white;
        }

        .plan-btn.upgrade {
            background: linear-gradient(45deg, #f9ca24, #f0932b);
            color: white;
        }

        .plan-btn.premium {
            background: linear-gradient(45deg, #ff6b6b, #ee5a24);
            color: white;
        }

        .plan-btn:active {
            transform: scale(0.98);
        }

        /* iOS specific optimizations */
        @supports (-webkit-touch-callout: none) {
            .app-container {
                height: -webkit-fill-available;
            }
        }

        /* Landscape mode adjustments */
        @media screen and (orientation: landscape) and (max-height: 500px) {
            .header {
                padding: 10px 20px 5px;
            }
            
            .header h1 {
                font-size: 1.5rem;
                margin-bottom: 3px;
            }
            
            .header p {
                font-size: 0.75rem;
            }
            
            .workflow-steps {
                padding: 10px;
            }
            
            .main-content {
                padding: 15px;
            }
            
            .preview-container {
                aspect-ratio: 2/1;
            }
        }

        /* Dark mode media query */
        @media (prefers-color-scheme: dark) {
            .control-group input,
            .control-group select,
            .search-input,
            .genre-filter,
            .setting-item input,
            .setting-item select {
                background: rgba(255, 255, 255, 0.15);
            }
        }

        /* Accessibility improvements */
        @media (prefers-reduced-motion: reduce) {
            * {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }

        /* Touch feedback for better UX */
        .music-card:active,
        .upload-area:active,
        .step:active,
        .plan-card:active {
            background: rgba(255, 255, 255, 0.2);
        }

        /* Ensure minimum touch target size */
        button, .play-btn, .select-btn, .remove-btn, .toggle-switch {
            min-height: 44px;
            min-width: 44px;
        }

        /* Hide scrollbar on iOS */
        .music-grid::-webkit-scrollbar,
        .main-content::-webkit-scrollbar,
        .file-list::-webkit-scrollbar,
        .modal-body::-webkit-scrollbar {
            display: none;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="header">
            <div class="subscription-status" id="subscriptionStatus" onclick="openSubscription()">
                FREE
            </div>
            <h1>üéµ Beat-Sync Pro</h1>
            <p>AI Music Synchronization</p>
            <button class="settings-btn" onclick="openSettings()">‚öôÔ∏è</button>
        </div>

        <!-- Workflow Steps -->
        <div class="workflow-steps">
            <div class="step active" id="step1" onclick="goToStep(1)">
                <div class="step-number">1</div>
                <div class="step-title">Music</div>
                <div class="step-desc">Choose</div>
            </div>
            <div class="step" id="step2" onclick="goToStep(2)">
                <div class="step-number">2</div>
                <div class="step-title">Visuals</div>
                <div class="step-desc">Upload</div>
            </div>
            <div class="step" id="step3" onclick="goToStep(3)">
                <div class="step-number">3</div>
                <div class="step-title">Effects</div>
                <div class="step-desc">Customize</div>
            </div>
            <div class="step" id="step4" onclick="goToStep(4)">
                <div class="step-number">4</div>
                <div class="step-title">Generate</div>
                <div class="step-desc">Create</div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Step 1: Choose Music -->
            <div class="step-content active" id="content1">
                <h3 class="section-title">üéµ Choose Your Music</h3>
                
                <div class="selection-instructions">
                    <strong>üéØ How to Select:</strong><br>
                    ‚Ä¢ Tap ‚ñ∂ to preview tracks<br>
                    ‚Ä¢ Tap "Select Track" to choose<br>
                    ‚Ä¢ Upgrade for premium content
                </div>

                <!-- Music Tier Tabs -->
                <div class="music-tier-tabs">
                    <div class="tier-tab active" data-tier="free" onclick="switchMusicTier('free')">
                        <div>FREE</div>
                        <div class="tier-price">5 Tracks</div>
                    </div>
                    <div class="tier-tab" data-tier="premium" onclick="switchMusicTier('premium')">
                        <div>PREMIUM</div>
                        <div class="tier-price">$4.99/mo</div>
                        <div class="lock-icon" id="premiumLock">üîí</div>
                    </div>
                    <div class="tier-tab" data-tier="pro" onclick="switchMusicTier('pro')">
                        <div>PRO</div>
                        <div class="tier-price">$9.99/mo</div>
                        <div class="lock-icon" id="proLock">üîí</div>
                    </div>
                </div>

                <div class="search-container">
                    <input type="text" class="search-input" id="musicSearch" placeholder="Search dance, EDM, house..." />
                    <div class="search-row">
                        <select class="genre-filter" id="genreFilter">
                            <option value="">All Genres</option>
                            <option value="electronic">Electronic</option>
                            <option value="dance">Dance</option>
                            <option value="edm">EDM</option>
                            <option value="house">House</option>
                            <option value="techno">Techno</option>
                            <option value="dubstep">Dubstep</option>
                            <option value="trap">Trap</option>
                            <option value="chill">Chill</option>
                            <option value="drum-bass">Drum & Bass</option>
                            <option value="future-bass">Future Bass</option>
                        </select>
                        <button class="search-btn" onclick="searchMusic()">üîç</button>
                    </div>
                </div>

                <div class="music-grid" id="musicGrid">
                    <!-- Music cards will be populated here -->
                </div>

                <div style="text-align: center; margin: 20px 0; font-weight: 600; opacity: 0.8;">
                    -- OR --
                </div>

                <div class="upload-section">
                    <div class="upload-area" id="audioUploadArea" onclick="document.getElementById('audioFile').click()">
                        <input type="file" id="audioFile" accept="audio/*,video/*">
                        <div class="upload-icon">üéµ</div>
                        <h4>Upload Your Music</h4>
                        <p>Tap to upload (.mp3, .wav, .m4a)</p>
                    </div>
                </div>

                <button class="next-step-btn" id="nextStep1" onclick="nextStep()" disabled>
                    ‚û°Ô∏è Next: Add Visuals
                </button>
            </div>

            <!-- Step 2: Add Visuals -->
            <div class="step-content" id="content2">
                <h3 class="section-title">üé¨ Add Visual Content</h3>
                
                <div class="selection-instructions">
                    <strong>üìÅ Upload Tips:</strong><br>
                    ‚Ä¢ Add 3-10 files for best variety<br>
                    ‚Ä¢ AI switches content on beat drops<br>
                    ‚Ä¢ Images and videos both supported
                </div>

                <div class="upload-section">
                    <div class="upload-area" id="mediaUploadArea" onclick="document.getElementById('mediaFile').click()">
                        <input type="file" id="mediaFile" accept="image/*,video/*" multiple>
                        <div class="upload-icon">üé¨</div>
                        <h4>Upload Images & Videos</h4>
                        <p>Tap to select multiple files</p>
                    </div>
                </div>

                <div class="file-list" id="uploadedFiles"></div>

                <div class="button-row">
                    <button class="next-step-btn" style="flex: 1; background: linear-gradient(45deg, #95a5a6, #7f8c8d);" onclick="prevStep()">
                        ‚¨ÖÔ∏è Back
                    </button>
                    <button class="next-step-btn" style="flex: 1;" id="nextStep2" onclick="nextStep()">
                        ‚û°Ô∏è Next
                    </button>
                </div>
            </div>

            <!-- Step 3: Set Effects -->
            <div class="step-content" id="content3">
                <h3 class="section-title">‚ö° Customize Effects</h3>
                
                <div class="selection-instructions">
                    <strong>üéõÔ∏è Effect Settings:</strong><br>
                    ‚Ä¢ Auto-Detect chooses best effects<br>
                    ‚Ä¢ Higher intensity = more dramatic<br>
                    ‚Ä¢ Adjust for your music style
                </div>

                <div class="controls-grid">
                    <div class="control-group">
                        <label>üé≠ Effect Style</label>
                        <select id="effectStyle">
                            <option value="auto">ü§ñ Auto-Detect</option>
                            <option value="electronic">‚ö° Electronic/EDM</option>
                            <option value="hip-hop">üé§ Hip-Hop/Rap</option>
                            <option value="pop">üí´ Pop/Dance</option>
                            <option value="chill">üåä Chill/Ambient</option>
                            <option value="trap">üî• Trap/Bass</option>
                        </select>
                    </div>
                    
                    <div class="control-group">
                        <label>‚ö° Effect Intensity: <span id="intensityValue">7</span></label>
                        <input type="range" id="intensity" min="1" max="10" value="7" oninput="updateSliderValue('intensity', 'intensityValue')">
                    </div>
                    
                    <div class="control-group">
                        <label>‚è±Ô∏è Clip Duration (seconds)</label>
                        <input type="number" id="duration" min="5" max="60" value="15">
                    </div>
                    
                    <div class="control-group">
                        <label>üéØ Beat Sensitivity: <span id="sensitivityValue">6</span></label>
                        <input type="range" id="sensitivity" min="1" max="10" value="6" oninput="updateSliderValue('sensitivity', 'sensitivityValue')">
                    </div>
                </div>

                <div class="button-row">
                    <button class="next-step-btn" style="flex: 1; background: linear-gradient(45deg, #95a5a6, #7f8c8d);" onclick="prevStep()">
                        ‚¨ÖÔ∏è Back
                    </button>
                    <button class="next-step-btn" style="flex: 1;" id="nextStep3" onclick="nextStep()">
                        ‚û°Ô∏è Next
                    </button>
                </div>
            </div>

            <!-- Step 4: Generate -->
            <div class="step-content" id="content4">
                <h3 class="section-title">üöÄ Generate Clip</h3>
                
                <div class="selection-instructions">
                    <strong>‚ú® Ready to Create:</strong><br>
                    ‚Ä¢ AI analyzes your music's rhythm<br>
                    ‚Ä¢ Effects sync automatically to beats<br>
                    ‚Ä¢ Content switches on beat drops
                </div>

                <button class="generate-btn" id="generateBtn" onclick="generateClip()">
                    üé¨ Generate Beat-Synced Clip
                </button>

                <button class="next-step-btn" style="background: linear-gradient(45deg, #95a5a6, #7f8c8d); margin-top: 15px;" onclick="prevStep()">
                    ‚¨ÖÔ∏è Back to Effects
                </button>
            </div>

            <!-- Preview Section -->
            <div class="preview-section">
                <h3 style="margin-bottom: 15px; font-size: 1.2rem;">üëÄ Live Preview</h3>
                <div class="preview-container">
                    <div class="preview-content" id="previewContent">
                        üéµ Your beat-synced clip will appear here...<br><br>Complete steps above to start!
                    </div>
                    <div class="effect-overlay" id="effectOverlay"></div>
                    <div class="beat-indicator" id="beatIndicator">‚ô™</div>
                    <div class="audio-visualizer" id="audioVisualizer"></div>
                </div>
                <div class="status" id="status">üéµ Welcome! Follow the steps to create your masterpiece!</div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div class="modal-overlay" id="settingsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>‚öôÔ∏è Settings</h2>
                <button class="close-btn" onclick="closeSettings()">√ó</button>
            </div>
            <div class="modal-body">
                <!-- Audio Settings -->
                <div class="settings-section">
                    <h3>üîä Audio Settings</h3>
                    <div class="settings-grid">
                        <div class="setting-item">
                            <label>Master Volume: <span id="masterVolumeValue">80</span>%</label>
                            <input type="range" id="masterVolume" min="0" max="100" value="80" oninput="updateSettingValue('masterVolume', 'masterVolumeValue')">
                        </div>
                        <div class="setting-item">
                            <label>Preview Volume: <span id="previewVolumeValue">70</span>%</label>
                            <input type="range" id="previewVolume" min="0" max="100" value="70" oninput="updateSettingValue('previewVolume', 'previewVolumeValue')">
                        </div>
                        <div class="setting-item">
                            <label>Audio Quality</label>
                            <select id="audioQuality">
                                <option value="standard">Standard (128kbps)</option>
                                <option value="high" selected>High (256kbps)</option>
                                <option value="premium">Premium (320kbps)</option>
                            </select>
                        </div>
                        <div class="setting-item setting-toggle">
                            <label>Auto-Play Previews</label>
                            <div class="toggle-switch active" id="autoPlayToggle" onclick="toggleSetting('autoPlayToggle')"></div>
                        </div>
                    </div>
                </div>

                <!-- Visual Settings -->
                <div class="settings-section">
                    <h3>üé® Visual Settings</h3>
                    <div class="settings-grid">
                        <div class="setting-item">
                            <label>Default Video Quality</label>
                            <select id="videoQuality">
                                <option value="720p">720p (HD)</option>
                                <option value="1080p" selected>1080p (Full HD)</option>
                                <option value="4k">4K (Ultra HD)</option>
                            </select>
                        </div>
                        <div class="setting-item">
                            <label>Frame Rate</label>
                            <select id="frameRate">
                                <option value="24">24 FPS (Cinema)</option>
                                <option value="30" selected>30 FPS (Standard)</option>
                                <option value="60">60 FPS (Smooth)</option>
                            </select>
                        </div>
                        <div class="setting-item">
                            <label>Effect Performance: <span id="effectPerformanceValue">High</span></label>
                            <input type="range" id="effectPerformance" min="1" max="3" value="3" oninput="updatePerformanceValue()">
                        </div>
                        <div class="setting-item setting-toggle">
                            <label>Hardware Acceleration</label>
                            <div class="toggle-switch active" id="hwAccelToggle" onclick="toggleSetting('hwAccelToggle')"></div>
                        </div>
                    </div>
                </div>

                <!-- Beat Detection Settings -->
                <div class="settings-section">
                    <h3>üéµ Beat Detection</h3>
                    <div class="settings-grid">
                        <div class="setting-item">
                            <label>Detection Algorithm</label>
                            <select id="beatAlgorithm">
                                <option value="standard">Standard</option>
                                <option value="advanced" selected>Advanced AI</option>
                                <option value="precision">High Precision</option>
                            </select>
                        </div>
                        <div class="setting-item">
                            <label>Frequency Analysis: <span id="freqAnalysisValue">512</span> bins</label>
                            <input type="range" id="freqAnalysis" min="256" max="2048" value="512" step="256" oninput="updateSettingValue('freqAnalysis', 'freqAnalysisValue')">
                        </div>
                        <div class="setting-item">
                            <label>Bass Threshold: <span id="bassThresholdValue">60</span>%</label>
                            <input type="range" id="bassThreshold" min="30" max="90" value="60" oninput="updateSettingValue('bassThreshold', 'bassThresholdValue')">
                        </div>
                        <div class="setting-item setting-toggle">
                            <label>Auto-Calibrate Sensitivity</label>
                            <div class="toggle-switch active" id="autoCalibToggle" onclick="toggleSetting('autoCalibToggle')"></div>
                        </div>
                    </div>
                </div>

                <!-- Export Settings -->
                <div class="settings-section">
                    <h3>üíæ Export Settings</h3>
                    <div class="settings-grid">
                        <div class="setting-item">
                            <label>Default Export Format</label>
                            <select id="exportFormat">
                                <option value="mp4" selected>MP4 (H.264)</option>
                                <option value="webm">WebM (VP9)</option>
                                <option value="mov">MOV (QuickTime)</option>
                                <option value="gif">GIF (Animated)</option>
                            </select>
                        </div>
                        <div class="setting-item">
                            <label>Compression Level</label>
                            <select id="compression">
                                <option value="low">Low (Large file)</option>
                                <option value="medium" selected>Medium (Balanced)</option>
                                <option value="high">High (Small file)</option>
                            </select>
                        </div>
                        <div class="setting-item setting-toggle">
                            <label>Auto-Save Projects</label>
                            <div class="toggle-switch active" id="autoSaveToggle" onclick="toggleSetting('autoSaveToggle')"></div>
                        </div>
                        <div class="setting-item setting-toggle">
                            <label>Include Watermark</label>
                            <div class="toggle-switch" id="watermarkToggle" onclick="toggleSetting('watermarkToggle')"></div>
                        </div>
                    </div>
                </div>

                <!-- App Settings -->
                <div class="settings-section">
                    <h3>üì± App Settings</h3>
                    <div class="settings-grid">
                        <div class="setting-item">
                            <label>Theme</label>
                            <select id="appTheme">
                                <option value="auto" selected>Auto (System)</option>
                                <option value="light">Light Mode</option>
                                <option value="dark">Dark Mode</option>
                            </select>
                        </div>
                        <div class="setting-item setting-toggle">
                            <label>Haptic Feedback</label>
                            <div class="toggle-switch active" id="hapticToggle" onclick="toggleSetting('hapticToggle')"></div>
                        </div>
                        <div class="setting-item setting-toggle">
                            <label>Push Notifications</label>
                            <div class="toggle-switch" id="notifToggle" onclick="toggleSetting('notifToggle')"></div>
                        </div>
                        <div class="setting-item setting-toggle">
                            <label>Analytics & Crash Reports</label>
                            <div class="toggle-switch active" id="analyticsToggle" onclick="toggleSetting('analyticsToggle')"></div>
                        </div>
                    </div>
                </div>

                <!-- Reset Settings -->
                <div class="settings-section">
                    <h3>üîÑ Reset & Backup</h3>
                    <div class="settings-grid">
                        <div style="display: flex; gap: 10px;">
                            <button class="plan-btn" style="flex: 1; background: #95a5a6;" onclick="resetSettings()">
                                Reset All Settings
                            </button>
                            <button class="plan-btn" style="flex: 1; background: #4ecdc4;" onclick="exportSettings()">
                                Export Settings
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Subscription Modal -->
    <div class="modal-overlay" id="subscriptionModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>‚≠ê Upgrade Your Experience</h2>
                <button class="close-btn" onclick="closeSubscription()">√ó</button>
            </div>
            <div class="modal-body">
                <div class="subscription-plans">
                    <!-- Free Plan -->
                    <div class="plan-card current">
                        <div class="plan-header">
                            <div class="plan-name">Free</div>
                            <div class="plan-price">$0</div>
                            <div class="plan-period">forever</div>
                        </div>
                        <ul class="plan-features">
                            <li>5 free music tracks</li>
                            <li>Basic beat detection</li>
                            <li>720p export quality</li>
                            <li>Standard effects library</li>
                            <li>15-second clips max</li>
                        </ul>
                        <button class="plan-btn current">Current Plan</button>
                    </div>

                    <!-- Premium Plan -->
                    <div class="plan-card recommended">
                        <div class="plan-header">
                            <div class="plan-name">Premium</div>
                            <div class="plan-price">$4.99</div>
                            <div class="plan-period">per month</div>
                        </div>
                        <ul class="plan-features">
                            <li>50+ premium music tracks</li>
                            <li>Advanced AI beat detection</li>
                            <li>1080p export quality</li>
                            <li>Premium effects & filters</li>
                            <li>60-second clips</li>
                            <li>No watermarks</li>
                            <li>Cloud storage (5GB)</li>
                        </ul>
                        <button class="plan-btn upgrade" onclick="subscribeToPlan('premium')">
                            Upgrade to Premium
                        </button>
                    </div>

                    <!-- Pro Plan -->
                    <div class="plan-card">
                        <div class="plan-header">
                            <div class="plan-name">Pro</div>
                            <div class="plan-price">$9.99</div>
                            <div class="plan-period">per month</div>
                        </div>
                        <ul class="plan-features">
                            <li>200+ exclusive tracks</li>
                            <li>AI-powered music creation</li>
                            <li>4K export quality</li>
                            <li>Professional effects suite</li>
                            <li>Unlimited clip length</li>
                            <li>Commercial license</li>
                            <li>Cloud storage (50GB)</li>
                            <li>Priority support</li>
                            <li>Custom branding</li>
                        </ul>
                        <button class="plan-btn premium" onclick="subscribeToPlan('pro')">
                            Go Pro
                        </button>
                    </div>
                </div>

                <div style="text-align: center; margin-top: 20px; font-size: 0.8rem; opacity: 0.8;">
                    ‚ú® Cancel anytime ‚Ä¢ 7-day free trial ‚Ä¢ Secure payment
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global state
        let currentStep = 1;
        let selectedMusic = null;
        let currentAudio = null;
        let currentMedia = [];
        let currentPreviewAudio = null;
        let isPlaying = false;
        let audioContext, analyser, audioSource, beatDetector, effectsEngine;
        let currentTier = 'free';
        let currentMusicTier = 'free';
        let userSubscription = 'free';

        // Expanded music database with tiers
        const freeMusicDatabase = [
            // Free Tier
            {
                id: 1,
                title: "Electric Dreams",
                artist: "SynthWave Pro",
                genre: "electronic",
                bpm: 128,
                duration: "3:45",
                tier: "free",
                previewUrl: "https://www2.cs.uic.edu/~i101/SoundFiles/BabyElephantWalk60.wav",
                tags: ["edm", "electronic", "dance"]
            },
            {
                id: 2,
                title: "Bass Revolution",
                artist: "EDM Master",
                genre: "dubstep",
                bpm: 140,
                duration: "4:12",
                tier: "free",
                previewUrl: "https://www2.cs.uic.edu/~i101/SoundFiles/CantinaBand60.wav",
                tags: ["dubstep", "bass", "electronic"]
            },
            {
                id: 3,
                title: "House Vibes",
                artist: "Deep House",
                genre: "house",
                bpm: 124,
                duration: "5:30",
                tier: "free",
                previewUrl: "https://www2.cs.uic.edu/~i101/SoundFiles/ImperialMarch60.wav",
                tags: ["house", "dance", "party"]
            },
            {
                id: 4,
                title: "Techno Beat",
                artist: "Cyber Beats",
                genre: "techno",
                bpm: 132,
                duration: "6:15",
                tier: "free",
                previewUrl: "https://www2.cs.uic.edu/~i101/SoundFiles/StarWars60.wav",
                tags: ["techno", "underground"]
            },
            {
                id: 5,
                title: "Trap Energy",
                artist: "Urban Sound",
                genre: "trap",
                bpm: 150,
                duration: "3:20",
                tier: "free",
                previewUrl: "https://www2.cs.uic.edu/~i101/SoundFiles/gettysburg10.wav",
                tags: ["trap", "hip-hop", "urban"]
            },

            // Premium Tier
            {
                id: 6,
                title: "Neon Nights",
                artist: "Future Bass Collective",
                genre: "future-bass",
                bpm: 140,
                duration: "4:30",
                tier: "premium",
                previewUrl: "https://www2.cs.uic.edu/~i101/SoundFiles/BabyElephantWalk60.wav",
                tags: ["future-bass", "melodic", "emotional"]
            },
            {
                id: 7,
                title: "Cyber Punk 2099",
                artist: "Digital Dreams",
                genre: "electronic",
                bpm: 135,
                duration: "5:15",
                tier: "premium",
                previewUrl: "https://www2.cs.uic.edu/~i101/SoundFiles/CantinaBand60.wav",
                tags: ["cyberpunk", "dark", "futuristic"]
            },
            {
                id: 8,
                title: "Liquid Drum & Bass",
                artist: "Smooth Operators",
                genre: "drum-bass",
                bpm: 174,
                duration: "6:45",
                tier: "premium",
                previewUrl: "https://www2.cs.uic.edu/~i101/SoundFiles/ImperialMarch60.wav",
                tags: ["drum-bass", "liquid", "smooth"]
            },
            {
                id: 9,
                title: "Festival Anthem",
                artist: "Mainstage Heroes",
                genre: "edm",
                bpm: 128,
                duration: "4:00",
                tier: "premium",
                previewUrl: "https://www2.cs.uic.edu/~i101/SoundFiles/StarWars60.wav",
                tags: ["festival", "big-room", "anthem"]
            },
            {
                id: 10,
                title: "Minimal Techno Journey",
                artist: "Underground Labs",
                genre: "techno",
                bpm: 126,
                duration: "7:30",
                tier: "premium",
                previewUrl: "https://www2.cs.uic.edu/~i101/SoundFiles/gettysburg10.wav",
                tags: ["minimal", "hypnotic", "deep"]
            },

            // Pro Tier
            {
                id: 11,
                title: "Epic Orchestral Bass",
                artist: "Cinematic Sound",
                genre: "electronic",
                bpm: 110,
                duration: "5:45",
                tier: "pro",
                previewUrl: "https://www2.cs.uic.edu/~i101/SoundFiles/BabyElephantWalk60.wav",
                tags: ["cinematic", "orchestral", "epic"]
            },
            {
                id: 12,
                title: "Hybrid Trap Beast",
                artist: "Bass Monsters",
                genre: "trap",
                bpm: 150,
                duration: "4:20",
                tier: "pro",
                previewUrl: "https://www2.cs.uic.edu/~i101/SoundFiles/CantinaBand60.wav",
                tags: ["hybrid", "aggressive", "festival"]
            },
            {
                id: 13,
                title: "Ambient Dreamscape",
                artist: "Ethereal Sounds",
                genre: "chill",
                bpm: 90,
                duration: "8:00",
                tier: "pro",
                previewUrl: "https://www2.cs.uic.edu/~i101/SoundFiles/ImperialMarch60.wav",
                tags: ["ambient", "dreamy", "meditation"]
            },
            {
                id: 14,
                title: "Neurofunk Destroyer",
                artist: "Matrix Breaks",
                genre: "drum-bass",
                bpm: 180,
                duration: "5:30",
                tier: "pro",
                previewUrl: "https://www2.cs.uic.edu/~i101/SoundFiles/StarWars60.wav",
                tags: ["neurofunk", "dark", "technical"]
            },
            {
                id: 15,
                title: "Progressive House Journey",
                artist: "Melodic Progressions",
                genre: "house",
                bpm: 124,
                duration: "9:15",
                tier: "pro",
                previewUrl: "https://www2.cs.uic.edu/~i101/SoundFiles/gettysburg10.wav",
                tags: ["progressive", "melodic", "journey"]
            }
        ];

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            initAudioVisualizer();
            loadMusicLibrary();
            setupEventListeners();
            updateStepAvailability();
            updateSubscriptionDisplay();
            
            // Prevent zoom on double tap
            let lastTouchEnd = 0;
            document.addEventListener('touchend', function (event) {
                const now = (new Date()).getTime();
                if (now - lastTouchEnd <= 300) {
                    event.preventDefault();
                }
                lastTouchEnd = now;
            }, false);
            
            // Prevent scroll bounce
            document.addEventListener('touchmove', function(e) {
                if (e.target.closest('.main-content, .music-grid, .file-list, .modal-body')) {
                    return;
                }
                e.preventDefault();
            }, { passive: false });
        });

        function setupEventListeners() {
            document.getElementById('audioFile').addEventListener('change', handleAudioUpload);
            document.getElementById('mediaFile').addEventListener('change', handleMediaUpload);
            document.getElementById('musicSearch').addEventListener('input', debounce(searchMusic, 300));
            document.getElementById('genreFilter').addEventListener('change', searchMusic);
        }

        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Settings functions
        function openSettings() {
            document.getElementById('settingsModal').classList.add('active');
        }

        function closeSettings() {
            document.getElementById('settingsModal').classList.remove('active');
        }

        function openSubscription() {
            document.getElementById('subscriptionModal').classList.add('active');
        }

        function closeSubscription() {
            document.getElementById('subscriptionModal').classList.remove('active');
        }

        function updateSettingValue(sliderId, displayId) {
            const value = document.getElementById(sliderId).value;
            document.getElementById(displayId).textContent = value;
        }

        function updatePerformanceValue() {
            const value = document.getElementById('effectPerformance').value;
            const levels = ['Low', 'Medium', 'High'];
            document.getElementById('effectPerformanceValue').textContent = levels[value - 1];
        }

        function toggleSetting(toggleId) {
            const toggle = document.getElementById(toggleId);
            toggle.classList.toggle('active');
        }

        function resetSettings() {
            if (confirm('Reset all settings to default? This cannot be undone.')) {
                // Reset all settings to default
                location.reload();
            }
        }

        function exportSettings() {
            const settings = {
                masterVolume: document.getElementById('masterVolume').value,
                previewVolume: document.getElementById('previewVolume').value,
                audioQuality: document.getElementById('audioQuality').value,
                // ... add all other settings
            };
            
            const dataStr = JSON.stringify(settings, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'beat-sync-settings.json';
            link.click();
            
            updateStatus('‚¨áÔ∏è Settings exported successfully!');
        }

        // Subscription functions
        function updateSubscriptionDisplay() {
            const statusEl = document.getElementById('subscriptionStatus');
            statusEl.className = `subscription-status ${userSubscription}`;
            statusEl.textContent = userSubscription.toUpperCase();
            
            // Update tier locks
            const premiumLock = document.getElementById('premiumLock');
            const proLock = document.getElementById('proLock');
            
            if (userSubscription === 'free') {
                premiumLock.style.display = 'block';
                proLock.style.display = 'block';
            } else if (userSubscription === 'premium') {
                premiumLock.style.display = 'none';
                proLock.style.display = 'block';
            } else {
                premiumLock.style.display = 'none';
                proLock.style.display = 'none';
            }
        }

        function subscribeToPlan(plan) {
            // Simulate subscription process
            updateStatus(`üîÑ Processing ${plan} subscription...`);
            
            setTimeout(() => {
                userSubscription = plan;
                updateSubscriptionDisplay();
                closeSubscription();
                updateStatus(`‚úÖ Successfully upgraded to ${plan.toUpperCase()}!`);
                
                // Refresh music library to show new tracks
                loadMusicLibrary();
            }, 2000);
        }

        function switchMusicTier(tier) {
            // Check if user has access to this tier
            if (tier === 'premium' && userSubscription === 'free') {
                openSubscription();
                return;
            }
            if (tier === 'pro' && (userSubscription === 'free' || userSubscription === 'premium')) {
                openSubscription();
                return;
            }
            
            currentMusicTier = tier;
            
            // Update tier tab appearance
            document.querySelectorAll('.tier-tab').forEach(tab => {
                tab.classList.remove('active');
                if (tab.dataset.tier === tier) {
                    tab.classList.add('active');
                }
            });
            
            searchMusic();
        }

        // Step navigation
        function goToStep(step) {
            if (step <= currentStep || isStepCompleted(step - 1)) {
                showStep(step);
            }
        }

        function nextStep() {
            if (currentStep < 4) {
                markStepCompleted(currentStep);
                currentStep++;
                showStep(currentStep);
                updateStepAvailability();
            }
        }

        function prevStep() {
            if (currentStep > 1) {
                currentStep--;
                showStep(currentStep);
            }
        }

        function showStep(step) {
            document.querySelectorAll('.step-content').forEach(content => {
                content.classList.remove('active');
            });
            
            document.getElementById(`content${step}`).classList.add('active');
            
            document.querySelectorAll('.step').forEach((stepEl, index) => {
                stepEl.classList.remove('active');
                if (index + 1 === step) {
                    stepEl.classList.add('active');
                }
            });
            
            currentStep = step;
            
            // Scroll to top
            document.querySelector('.main-content').scrollTop = 0;
        }

        function markStepCompleted(step) {
            document.getElementById(`step${step}`).classList.add('completed');
        }

        function isStepCompleted(step) {
            return document.getElementById(`step${step}`).classList.contains('completed');
        }

        function updateStepAvailability() {
            const hasMusic = selectedMusic || currentAudio;
            document.getElementById('nextStep1').disabled = !hasMusic;
            if (hasMusic) {
                document.getElementById('nextStep1').innerHTML = '‚û°Ô∏è Next: Add Visuals ‚úì';
            }
        }

        // Music functions
        function loadMusicLibrary() {
            searchMusic();
        }

        function searchMusic() {
            const searchTerm = document.getElementById('musicSearch').value.toLowerCase();
            const genreFilter = document.getElementById('genreFilter').value;
            
            let filteredMusic = freeMusicDatabase.filter(track => {
                const matchesSearch = track.title.toLowerCase().includes(searchTerm) ||
                                    track.artist.toLowerCase().includes(searchTerm) ||
                                    track.tags.some(tag => tag.toLowerCase().includes(searchTerm));
                
                const matchesGenre = !genreFilter || track.genre === genreFilter;
                const matchesTier = track.tier === currentMusicTier;
                
                return matchesSearch && matchesGenre && matchesTier;
            });

            renderMusicGrid(filteredMusic);
        }

        function renderMusicGrid(tracks) {
            const grid = document.getElementById('musicGrid');
            grid.innerHTML = '';

            if (tracks.length === 0) {
                grid.innerHTML = '<p style="text-align: center; opacity: 0.7; padding: 20px;">No tracks found. Try different search terms or upgrade your plan!</p>';
                return;
            }

            tracks.forEach(track => {
                const card = createMusicCard(track);
                grid.appendChild(card);
            });
        }

        function createMusicCard(track) {
            const card = document.createElement('div');
            card.className = 'music-card';
            
            const hasAccess = canAccessTrack(track);
            if (!hasAccess) {
                card.classList.add('locked');
            }
            
            card.onclick = () => {
                if (hasAccess) {
                    selectMusic(track, card);
                } else {
                    openSubscription();
                }
            };

            card.innerHTML = `
                <div class="music-tier-badge ${track.tier}">${track.tier.toUpperCase()}</div>
                <div class="music-info">
                    <h4>${track.title}</h4>
                    <p>by ${track.artist}</p>
                    <p>${track.genre.toUpperCase()} ‚Ä¢ ${track.bpm} BPM ‚Ä¢ ${track.duration}</p>
                </div>
                <div class="music-controls">
                    <button class="play-btn" ${!hasAccess ? 'disabled' : ''} onclick="event.stopPropagation(); ${hasAccess ? `togglePreview('${track.previewUrl}', this, '${track.id}')` : 'openSubscription()'}">‚ñ∂</button>
                    <div class="waveform">
                        <div class="waveform-progress" id="progress-${track.id}"></div>
                        <div class="waveform-time" id="time-${track.id}">0:00</div>
                    </div>
                    <button class="select-btn ${hasAccess ? '' : 'upgrade-btn'}" ${!hasAccess ? 'disabled' : ''} onclick="event.stopPropagation(); ${hasAccess ? `selectMusic('${JSON.stringify(track).replace(/'/g, "\\'")}', this.closest('.music-card'))` : 'openSubscription()'}">
                        ${hasAccess ? 'Select' : 'Upgrade'}
                    </button>
                </div>
            `;

            return card;
        }

        function canAccessTrack(track) {
            if (track.tier === 'free') return true;
            if (track.tier === 'premium' && (userSubscription === 'premium' || userSubscription === 'pro')) return true;
            if (track.tier === 'pro' && userSubscription === 'pro') return true;
            return false;
        }

        function togglePreview(url, button, trackId) {
            // Stop any currently playing preview
            if (currentPreviewAudio && !currentPreviewAudio.paused) {
                currentPreviewAudio.pause();
                currentPreviewAudio.currentTime = 0;
                
                document.querySelectorAll('.play-btn').forEach(btn => {
                    btn.innerHTML = '‚ñ∂';
                    btn.classList.remove('playing');
                });
                
                document.querySelectorAll('.music-card').forEach(card => {
                    card.classList.remove('playing');
                });
            }

            if (currentPreviewAudio && currentPreviewAudio.src === url && button.innerHTML === '‚ñ∂') {
                return;
            }

            // Play new track
            currentPreviewAudio = new Audio(url);
            const previewVolume = document.getElementById('previewVolume').value / 100;
            currentPreviewAudio.volume = previewVolume;
            
            button.innerHTML = '‚è∏';
            button.classList.add('playing');
            button.closest('.music-card').classList.add('playing');
            
            currentPreviewAudio.ontimeupdate = () => {
                const progress = (currentPreviewAudio.currentTime / currentPreviewAudio.duration) * 100;
                const progressBar = document.getElementById(`progress-${trackId}`);
                const timeDisplay = document.getElementById(`time-${trackId}`);
                
                if (progressBar) progressBar.style.width = progress + '%';
                if (timeDisplay) {
                    const minutes = Math.floor(currentPreviewAudio.currentTime / 60);
                    const seconds = Math.floor(currentPreviewAudio.currentTime % 60);
                    timeDisplay.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
                }
            };
            
            currentPreviewAudio.onended = () => {
                button.innerHTML = '‚ñ∂';
                button.classList.remove('playing');
                button.closest('.music-card').classList.remove('playing');
                document.getElementById(`progress-${trackId}`).style.width = '0%';
                document.getElementById(`time-${trackId}`).textContent = '0:00';
            };
            
            currentPreviewAudio.play().catch(e => {
                console.warn('Could not play preview:', e);
                updateStatus('‚ö†Ô∏è Preview not available');
                button.innerHTML = '‚ñ∂';
                button.classList.remove('playing');
                button.closest('.music-card').classList.remove('playing');
            });
        }

        function selectMusic(track, cardElement) {
            if (typeof track === 'string') {
                track = JSON.parse(track);
            }
            
            if (!canAccessTrack(track)) {
                openSubscription();
                return;
            }
            
            if (currentPreviewAudio && !currentPreviewAudio.paused) {
                currentPreviewAudio.pause();
                currentPreviewAudio.currentTime = 0;
            }
            
            document.querySelectorAll('.play-btn').forEach(btn => {
                btn.innerHTML = '‚ñ∂';
                btn.classList.remove('playing');
            });
            document.querySelectorAll('.music-card').forEach(card => {
                card.classList.remove('selected', 'playing');
            });
            document.querySelectorAll('.select-btn').forEach(btn => {
                if (!btn.classList.contains('upgrade-btn')) {
                    btn.textContent = 'Select';
                    btn.classList.remove('selected');
                }
            });
            
            cardElement.classList.add('selected');
            const selectBtn = cardElement.querySelector('.select-btn');
            if (!selectBtn.classList.contains('upgrade-btn')) {
                selectBtn.textContent = 'Selected ‚úì';
                selectBtn.classList.add('selected');
            }
            
            selectedMusic = track;
            currentAudio = null;
            
            updateStatus(`üéµ Selected: ${track.title}`);
            updateStepAvailability();
            
            loadSelectedMusic(track);
        }

        async function loadSelectedMusic(track) {
            try {
                const response = await fetch(track.previewUrl);
                currentAudio = await response.blob();
                updateStatus(`‚úÖ Loaded: ${track.title} - Ready!`);
            } catch (error) {
                updateStatus(`‚ùå Error loading: ${track.title}`);
            }
        }

        // File upload handlers
        async function handleAudioUpload(event) {
            const files = Array.from(event.target.files);
            if (files.length > 0) {
                const file = files[0];
                currentAudio = file;
                selectedMusic = null;
                
                document.querySelectorAll('.music-card').forEach(card => {
                    card.classList.remove('selected');
                });
                document.querySelectorAll('.select-btn').forEach(btn => {
                    if (!btn.classList.contains('upgrade-btn')) {
                        btn.textContent = 'Select';
                        btn.classList.remove('selected');
                    }
                });
                
                const uploadArea = document.getElementById('audioUploadArea');
                uploadArea.classList.add('has-files');
                uploadArea.innerHTML = `
                    <div class="upload-icon">‚úÖ</div>
                    <h4>Audio Uploaded</h4>
                    <p>${file.name}</p>
                    <button class="remove-btn" onclick="removeCustomAudio()" style="margin-top: 10px;">Remove</button>
                `;
                
                updateStatus(`üéµ Custom audio: ${file.name}`);
                updateStepAvailability();
            }
        }

        function removeCustomAudio() {
            currentAudio = null;
            selectedMusic = null;
            
            const uploadArea = document.getElementById('audioUploadArea');
            uploadArea.classList.remove('has-files');
            uploadArea.innerHTML = `
                <input type="file" id="audioFile" accept="audio/*,video/*">
                <div class="upload-icon">üéµ</div>
                <h4>Upload Your Music</h4>
                <p>Tap to upload (.mp3, .wav, .m4a)</p>
            `;
            
            document.getElementById('audioFile').addEventListener('change', handleAudioUpload);
            
            updateStatus('üéµ Audio removed');
            updateStepAvailability();
        }

        async function handleMediaUpload(event) {
            const files = Array.from(event.target.files);
            currentMedia = [...currentMedia, ...files];
            
            const uploadArea = document.getElementById('mediaUploadArea');
            uploadArea.classList.add('has-files');
            
            updateStatus(`üé¨ ${files.length} files added (Total: ${currentMedia.length})`);
            displayUploadedFiles();
        }

        function displayUploadedFiles() {
            const container = document.getElementById('uploadedFiles');
            container.innerHTML = '';

            if (currentMedia.length === 0) return;

            const header = document.createElement('h4');
            header.textContent = `üìÅ Files (${currentMedia.length})`;
            header.style.marginBottom = '10px';
            header.style.fontSize = '1rem';
            container.appendChild(header);

            currentMedia.forEach((file, index) => {
                const item = document.createElement('div');
                item.className = 'file-item';
                item.innerHTML = `
                    <span>${file.type.startsWith('image/') ? 'üñºÔ∏è' : 'üé¨'} ${file.name.length > 25 ? file.name.substring(0, 25) + '...' : file.name}</span>
                    <button class="remove-btn" onclick="removeMedia(${index})">Remove</button>
                `;
                container.appendChild(item);
            });
        }

        function removeMedia(index) {
            currentMedia.splice(index, 1);
            displayUploadedFiles();
            
            if (currentMedia.length === 0) {
                document.getElementById('mediaUploadArea').classList.remove('has-files');
            }
            
            updateStatus(`üé¨ File removed (${currentMedia.length} remaining)`);
        }

        // Audio visualizer
        function initAudioVisualizer() {
            const visualizer = document.getElementById('audioVisualizer');
            for (let i = 0; i < 32; i++) {
                const bar = document.createElement('div');
                bar.className = 'audio-bar';
                bar.style.height = '3px';
                visualizer.appendChild(bar);
            }
        }

        // Beat Detection Engine
        class BeatDetector {
            constructor(audioContext, analyser) {
                this.audioContext = audioContext;
                this.analyser = analyser;
                this.bufferSize = analyser.frequencyBinCount;
                this.dataArray = new Uint8Array(this.bufferSize);
                this.lastBeatTime = 0;
                this.beatThreshold = 0.4;
            }

            detectBeat() {
                this.analyser.getByteFrequencyData(this.dataArray);
                
                const bassEnergy = this.getFrequencyRangeEnergy([0, 8]);
                const midEnergy = this.getFrequencyRangeEnergy([8, 24]);
                const highEnergy = this.getFrequencyRangeEnergy([24, 64]);
                
                const totalEnergy = bassEnergy + midEnergy + highEnergy;
                const normalizedEnergy = totalEnergy / 255;
                
                const now = this.audioContext.currentTime;
                const timeSinceLastBeat = now - this.lastBeatTime;
                
                let beatDetected = false;
                if (normalizedEnergy > this.beatThreshold && timeSinceLastBeat > 0.2) {
                    beatDetected = true;
                    this.lastBeatTime = now;
                }
                
                return {
                    detected: beatDetected,
                    energy: normalizedEnergy,
                    bass: bassEnergy / 255,
                    mid: midEnergy / 255,
                    high: highEnergy / 255
                };
            }

            getFrequencyRangeEnergy(range) {
                let energy = 0;
                for (let i = range[0]; i < Math.min(range[1], this.dataArray.length); i++) {
                    energy += this.dataArray[i];
                }
                return energy / (range[1] - range[0]);
            }
        }

        // Effects Engine
        class EffectsEngine {
            constructor() {
                this.previewContent = document.getElementById('previewContent');
                this.effectOverlay = document.getElementById('effectOverlay');
                this.beatIndicator = document.getElementById('beatIndicator');
                this.mediaIndex = 0;
            }

            applyBeatEffect(beatData) {
                if (!beatData.detected) return;

                this.beatIndicator.classList.add('beat-active');
                setTimeout(() => {
                    this.beatIndicator.classList.remove('beat-active');
                }, 300);

                if (beatData.bass > 0.7) {
                    this.previewContent.classList.add('effect-zoom');
                    setTimeout(() => {
                        this.previewContent.classList.remove('effect-zoom');
                    }, 600);
                } else if (beatData.high > 0.6) {
                    this.previewContent.classList.add('effect-flash');
                    setTimeout(() => {
                        this.previewContent.classList.remove('effect-flash');
                    }, 400);
                } else {
                    this.previewContent.classList.add('effect-shake');
                    setTimeout(() => {
                        this.previewContent.classList.remove('effect-shake');
                    }, 400);
                }

                if (beatData.energy > 0.8 && currentMedia.length > 1) {
                    this.switchMedia();
                }
            }

            switchMedia() {
                if (currentMedia.length === 0) return;
                
                this.mediaIndex = (this.mediaIndex + 1) % currentMedia.length;
                const file = currentMedia[this.mediaIndex];
                
                if (file.type.startsWith('image/')) {
                    const img = document.createElement('img');
                    img.src = URL.createObjectURL(file);
                    img.className = 'preview-media';
                    this.previewContent.innerHTML = '';
                    this.previewContent.appendChild(img);
                } else if (file.type.startsWith('video/')) {
                    const video = document.createElement('video');
                    video.src = URL.createObjectURL(file);
                    video.className = 'preview-media';
                    video.muted = true;
                    video.loop = true;
                    video.autoplay = true;
                    video.playsInline = true;
                    this.previewContent.innerHTML = '';
                    this.previewContent.appendChild(video);
                }
            }
        }

        // Generate function
        async function generateClip() {
            if (!currentAudio && !selectedMusic) {
                updateStatus('‚ùå Please select music from Step 1!');
                goToStep(1);
                return;
            }

            const generateBtn = document.getElementById('generateBtn');
            generateBtn.disabled = true;
            generateBtn.innerHTML = '<span class="loading-spinner"></span> Creating Magic...';

            try {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                analyser = audioContext.createAnalyser();
                analyser.fftSize = parseInt(document.getElementById('freqAnalysis')?.value || 512);
                
                const audioElement = document.createElement('audio');
                audioElement.src = URL.createObjectURL(currentAudio);
                audioElement.crossOrigin = 'anonymous';
                
                const masterVolume = document.getElementById('masterVolume')?.value / 100 || 0.8;
                audioElement.volume = masterVolume;
                
                audioSource = audioContext.createMediaElementSource(audioElement);
                audioSource.connect(analyser);
                analyser.connect(audioContext.destination);
                
                beatDetector = new BeatDetector(audioContext, analyser);
                effectsEngine = new EffectsEngine();
                
                if (currentMedia.length > 0) {
                    effectsEngine.switchMedia();
                } else {
                    const defaultDiv = document.createElement('div');
                    defaultDiv.style.cssText = `
                        width: 100%; height: 100%;
                        background: linear-gradient(45deg, #667eea, #764ba2);
                        display: flex; align-items: center; justify-content: center;
                        color: white; font-size: 2rem; text-align: center;
                        padding: 20px;
                    `;
                    defaultDiv.innerHTML = 'üéµ<br>Visualizer';
                    document.getElementById('previewContent').innerHTML = '';
                    document.getElementById('previewContent').appendChild(defaultDiv);
                }
                
                await audioElement.play();
                isPlaying = true;
                
                updateStatus('üéµ AI analyzing and syncing...');
                
                function animate() {
                    if (!isPlaying) return;
                    
                    const beatData = beatDetector.detectBeat();
                    effectsEngine.applyBeatEffect(beatData);
                    updateAudioVisualizer();
                    updateProgress(audioElement);
                    
                    requestAnimationFrame(animate);
                }
                
                animate();
                
                const duration = parseInt(document.getElementById('duration').value) * 1000;
                setTimeout(() => {
                    audioElement.pause();
                    isPlaying = false;
                    updateStatus('‚úÖ Beat-synced clip completed! üéâ');
                    generateBtn.disabled = false;
                    generateBtn.innerHTML = 'üé¨ Generate Beat-Synced Clip';
                    markStepCompleted(4);
                }, duration);
                
            } catch (error) {
                console.error('Error:', error);
                updateStatus('‚ùå Error generating clip. Try again.');
                generateBtn.disabled = false;
                generateBtn.innerHTML = 'üé¨ Generate Beat-Synced Clip';
            }
        }

        function updateAudioVisualizer() {
            if (!analyser) return;
            
            const dataArray = new Uint8Array(analyser.frequencyBinCount);
            analyser.getByteFrequencyData(dataArray);
            
            const bars = document.querySelectorAll('.audio-bar');
            const step = Math.floor(dataArray.length / bars.length);
            
            bars.forEach((bar, index) => {
                const value = dataArray[index * step];
                const height = Math.max(2, (value / 255) * 50);
                bar.style.height = height + 'px';
            });
        }

        function updateProgress(audioElement) {
            if (audioElement.duration) {
                const progress = (audioElement.currentTime / audioElement.duration) * 100;
                document.getElementById('progressFill').style.width = progress + '%';
            }
        }

        function updateSliderValue(sliderId, displayId) {
            const value = document.getElementById(sliderId).value;
            document.getElementById(displayId).textContent = value;
        }

        function updateStatus(message) {
            document.getElementById('status').innerHTML = message;
        }

        // Initialize
        updateStatus('üéµ Welcome! Start with Step 1 to begin!');
    </script>
</body>
</html>
